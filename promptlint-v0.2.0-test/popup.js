class r{loadingOverlay;statusCard;statusIndicator;statusText;statusDetails;statusSite;statusConfidence;errorSection;errorList;currentTabId=null;apiKeyInput;toggleApiKeyBtn;saveApiKeyBtn;clearApiKeyBtn;apiKeyStatus;constructor(){this.initializeElements(),this.attachEventListeners(),this.loadPopupData(),this.loadApiKeyStatus()}initializeElements(){this.loadingOverlay=this.getElement("loadingOverlay"),this.statusCard=this.getElement("statusCard"),this.statusIndicator=this.getElement("statusIndicator"),this.statusText=this.getElement("statusText"),this.statusDetails=this.getElement("statusDetails"),this.statusSite=this.getElement("statusSite"),this.statusConfidence=this.getElement("statusConfidence"),this.errorSection=this.getElement("errorSection"),this.errorList=this.getElement("errorList"),this.apiKeyInput=this.getElement("apiKeyInput"),this.toggleApiKeyBtn=this.getElement("toggleApiKey"),this.saveApiKeyBtn=this.getElement("saveApiKeyBtn"),this.clearApiKeyBtn=this.getElement("clearApiKeyBtn"),this.apiKeyStatus=this.getElement("apiKeyStatus")}getElement(t){const e=document.getElementById(t);if(!e)throw new Error(`Element with id '${t}' not found`);return e}attachEventListeners(){this.getElement("refreshBtn").addEventListener("click",()=>{this.refreshData()}),this.getElement("clearErrorsBtn").addEventListener("click",()=>{this.clearErrors()}),this.getElement("reinjectBtn").addEventListener("click",()=>{this.reinjectContentScript()}),this.getElement("helpBtn").addEventListener("click",()=>{this.openHelpPage()}),this.getElement("feedbackLink").addEventListener("click",t=>{t.preventDefault(),this.openFeedbackPage()}),this.getElement("supportLink").addEventListener("click",t=>{t.preventDefault(),this.openSupportPage()}),this.toggleApiKeyBtn.addEventListener("click",()=>{this.toggleApiKeyVisibility()}),this.saveApiKeyBtn.addEventListener("click",()=>{this.saveApiKey()}),this.clearApiKeyBtn.addEventListener("click",()=>{this.clearApiKey()}),this.apiKeyInput.addEventListener("input",()=>{this.validateApiKeyInput()})}async loadPopupData(){try{this.showLoading(!0);const t=await chrome.tabs.query({active:!0,currentWindow:!0});this.currentTabId=t[0]?.id||null,await Promise.all([this.loadExtensionStatus(),this.loadErrorStats()])}catch(t){console.error("[PromptLint Popup] Error loading data:",t),this.showError("Failed to load extension data")}finally{this.showLoading(!1)}}async loadExtensionStatus(){try{const t=await chrome.runtime.sendMessage({type:"GET_EXTENSION_STATUS"});this.updateStatusDisplay(t),this.updateStatsDisplay(t.stats)}catch(t){console.error("[PromptLint Popup] Error loading status:",t),this.showStatusError()}}async loadErrorStats(){try{const t=await chrome.runtime.sendMessage({type:"GET_ERROR_STATS"});this.updateErrorsDisplay(t)}catch(t){console.error("[PromptLint Popup] Error loading error stats:",t)}}updateStatusDisplay(t){const e=this.statusIndicator.querySelector(".status-dot");if(t.isActive&&t.currentTab)e.className="status-dot active",this.statusText.textContent="Active",this.statusSite.textContent=`Detected: ${t.currentTab.site}`,this.statusConfidence.textContent=`Confidence: ${Math.round(t.currentTab.confidence*100)}%`,this.statusCard.className="status-card success",t.currentTab.hasInputMonitor||(e.className="status-dot warning",this.statusText.textContent="Partially Active",this.statusConfidence.textContent+=" (Input monitoring disabled)",this.statusCard.className="status-card warning");else{const s=window.location.href;this.isSupportedSite(s)?(e.className="status-dot warning",this.statusText.textContent="Not Active",this.statusSite.textContent="Supported site detected",this.statusConfidence.textContent='Click "Retry" to activate',this.statusCard.className="status-card warning"):(e.className="status-dot",this.statusText.textContent="Inactive",this.statusSite.textContent="Navigate to ChatGPT or Claude",this.statusConfidence.textContent="",this.statusCard.className="status-card")}}updateStatsDisplay(t){this.getElement("totalActivations").textContent=t.totalActivations.toString(),this.getElement("successfulInits").textContent=t.successfulInitializations.toString(),this.getElement("errorCount").textContent=t.errorCount.toString(),this.getElement("activeTabsCount").textContent=t.activeTabsCount?.toString()||"0"}updateErrorsDisplay(t){if(t.totalErrors===0){this.errorSection.style.display="none";return}if(this.errorSection.style.display="block",this.errorList.innerHTML="",t.recentErrors.forEach(s=>{const i=document.createElement("div");i.className="error-item",i.innerHTML=`
        <div class="error-type">${this.formatErrorType(s.type)}</div>
        <div class="error-message">${s.message}</div>
      `,this.errorList.appendChild(i)}),t.totalErrors-t.recoverableErrors>0){const s=this.statusIndicator.querySelector(".status-dot");s.className="status-dot error",this.statusText.textContent="Error",this.statusCard.className="status-card error"}}formatErrorType(t){return t.replace(/_/g," ").toLowerCase().replace(/\b\w/g,e=>e.toUpperCase())}showStatusError(){const t=this.statusIndicator.querySelector(".status-dot");t.className="status-dot error",this.statusText.textContent="Error",this.statusSite.textContent="Failed to get extension status",this.statusConfidence.textContent="",this.statusCard.className="status-card error"}showLoading(t){this.loadingOverlay.style.display=t?"flex":"none"}showError(t){console.error("[PromptLint Popup] Error:",t)}async refreshData(){await this.loadPopupData()}async clearErrors(){try{await chrome.runtime.sendMessage({type:"CLEAR_ERRORS"}),this.errorSection.style.display="none",await this.loadErrorStats()}catch(t){console.error("[PromptLint Popup] Error clearing errors:",t)}}async reinjectContentScript(){try{if(!this.currentTabId)return;await chrome.runtime.sendMessage({type:"REINJECT_CONTENT_SCRIPT",tabId:this.currentTabId}),setTimeout(()=>this.refreshData(),1e3)}catch(t){console.error("[PromptLint Popup] Error reinjecting content script:",t)}}isSupportedSite(t){return["chat.openai.com","chatgpt.com","claude.ai","anthropic.com"].some(s=>t.includes(s))}openHelpPage(){chrome.tabs.create({url:"https://github.com/promptlint/promptlint#readme"}),window.close()}openFeedbackPage(){chrome.tabs.create({url:"https://github.com/promptlint/promptlint/issues/new"}),window.close()}openSupportPage(){chrome.tabs.create({url:"https://github.com/promptlint/promptlint/discussions"}),window.close()}async loadApiKeyStatus(){try{!!(await chrome.storage.local.get(["openai_api_key_encrypted"])).openai_api_key_encrypted?(this.apiKeyInput.placeholder="API key configured (hidden)",this.showApiKeyStatus("API key configured - AI rephrasing enabled","success")):(this.apiKeyInput.placeholder="sk-...",this.showApiKeyStatus("No API key - using offline mode","info"))}catch(t){console.error("[PromptLint Popup] Error loading API key status:",t),this.showApiKeyStatus("Error loading API key status","error")}}toggleApiKeyVisibility(){const t=this.apiKeyInput.type==="password";this.apiKeyInput.type=t?"text":"password";const e=this.toggleApiKeyBtn.querySelector(".toggle-icon");e.textContent=t?"üôà":"üëÅÔ∏è"}validateApiKeyInput(){const t=this.apiKeyInput.value.trim();if(!t){this.saveApiKeyBtn.disabled=!1,this.clearApiKeyBtn.disabled=!1,this.showApiKeyStatus("","");return}/^sk-[A-Za-z0-9_-]{20,}$/.test(t)?(this.saveApiKeyBtn.disabled=!1,this.showApiKeyStatus("Valid API key format","success")):(this.saveApiKeyBtn.disabled=!0,this.showApiKeyStatus("Invalid API key format (should be sk-...)","error"))}async saveApiKey(){try{const t=this.apiKeyInput.value.trim();if(!t){this.showApiKeyStatus("Please enter an API key","error");return}if(!t.startsWith("sk-")||t.length<25){this.showApiKeyStatus("Invalid API key format","error");return}this.showApiKeyStatus("Saving API key...","info");const e=await chrome.runtime.sendMessage({type:"SAVE_API_KEY",apiKey:t});e.success?(this.apiKeyInput.value="",this.apiKeyInput.placeholder="API key configured (hidden)",this.showApiKeyStatus("API key saved successfully","success"),setTimeout(()=>this.testApiKey(),1e3)):this.showApiKeyStatus(e.error||"Failed to save API key","error")}catch(t){console.error("[PromptLint Popup] Error saving API key:",t),this.showApiKeyStatus("Error saving API key","error")}}async clearApiKey(){try{this.showApiKeyStatus("Clearing API key...","info");const t=await chrome.runtime.sendMessage({type:"CLEAR_API_KEY"});t.success?(this.apiKeyInput.value="",this.apiKeyInput.placeholder="sk-...",this.showApiKeyStatus("API key cleared - using offline mode","info")):this.showApiKeyStatus(t.error||"Failed to clear API key","error")}catch(t){console.error("[PromptLint Popup] Error clearing API key:",t),this.showApiKeyStatus("Error clearing API key","error")}}async testApiKey(){try{this.showApiKeyStatus("Testing API key...","info");const t=await chrome.runtime.sendMessage({type:"TEST_API_KEY"});t.success?this.showApiKeyStatus("API key working - AI rephrasing enabled","success"):this.showApiKeyStatus(`API key test failed: ${t.error}`,"error")}catch(t){console.error("[PromptLint Popup] Error testing API key:",t),this.showApiKeyStatus("Error testing API key","error")}}showApiKeyStatus(t,e){if(!t||!e){this.apiKeyStatus.textContent="",this.apiKeyStatus.className="config-status";return}this.apiKeyStatus.textContent=t,this.apiKeyStatus.className=`config-status ${e}`}}document.addEventListener("DOMContentLoaded",()=>{new r});document.addEventListener("visibilitychange",()=>{document.hidden||setTimeout(()=>{new r},100)});
