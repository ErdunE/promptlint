const ei="modulepreload",ti=function(s){return"/"+s},Jn={},Mt=function(e,t,n){let r=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),o=a?.nonce||a?.getAttribute("nonce");r=Promise.allSettled(t.map(l=>{if(l=ti(l),l in Jn)return;Jn[l]=!0;const c=l.endsWith(".css"),m=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${m}`))return;const u=document.createElement("link");if(u.rel=c?"stylesheet":ei,c||(u.as="script"),u.crossOrigin="",u.href=l,o&&u.setAttribute("nonce",o),document.head.appendChild(u),c)return new Promise((p,h)=>{u.addEventListener("load",p),u.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return r.then(a=>{for(const o of a||[])o.status==="rejected"&&i(o.reason);return e().catch(i)})};var le=(s=>(s.CHATGPT="chatgpt",s.CLAUDE="claude",s))(le||{}),ze=(s=>(s.SITE_NOT_DETECTED="site_not_detected",s.ELEMENT_NOT_FOUND="element_not_found",s.SELECTOR_INVALID="selector_invalid",s.TIMEOUT="timeout",s.VALIDATION_FAILED="validation_failed",s.INITIALIZATION_FAILED="initialization_failed",s))(ze||{});class mt extends Error{constructor(e,t,n){super(t),this.type=e,this.context=n,this.name="AdapterError"}}const ni={maxRetries:3,baseDelay:100,exponentialBackoff:!0,maxTimeout:5e3};class vs{constructor(e,t){this.config=e,this.fallbackConfig={...ni,...t}}fallbackConfig;initialized=!1;get siteType(){return this.config.type}async detectSite(e){const t=performance.now(),n=e||window.location.href;try{const r=this.config.urlPatterns.some(l=>l.test(n));if(!r)return{type:null,confidence:0,url:n,metadata:{reason:"url_pattern_mismatch"}};const i=await this.performAdditionalDetection(),a=performance.now()-t,o=r?Math.min(.8+i,1):0;return{type:o>.5?this.config.type:null,confidence:o,url:n,metadata:{detectionTime:a,urlMatch:r,additionalConfidence:i}}}catch(r){const i=performance.now()-t;return{type:null,confidence:0,url:n,metadata:{detectionTime:i,error:r instanceof Error?r.message:"Unknown error"}}}}async findInputElement(){return this.findElementWithFallback(this.config.inputSelector,"input")}async findSubmitElement(){return this.findElementWithFallback(this.config.submitSelector,"submit")}async findChatContainer(){return this.findElementWithFallback(this.config.chatContainerSelector,"chatContainer")}async findInjectionPoint(){return this.findElementWithFallback(this.config.injectionPointSelector,"injectionPoint")}async initialize(){if(!this.initialized)try{await this.performInitialization(),this.initialized=!0}catch(e){throw new mt(ze.INITIALIZATION_FAILED,`Failed to initialize ${this.config.type} adapter: ${e instanceof Error?e.message:"Unknown error"}`,{siteType:this.config.type,error:e})}}cleanup(){this.performCleanup(),this.initialized=!1}async findElementWithFallback(e,t){const n=performance.now();let r=await this.findElementWithRetry(e.primary,e.validator);if(r)return{element:r,selectorUsed:"primary",findTime:performance.now()-n,isValid:e.validator?e.validator(r):!0};for(let i=0;i<e.fallbacks.length;i++){const a=e.fallbacks[i];if(r=await this.findElementWithRetry(a,e.validator),r){const o=e.validator?e.validator(r):!0;return{element:r,selectorUsed:i,findTime:performance.now()-n,isValid:o}}}return{element:null,selectorUsed:"primary",findTime:performance.now()-n,isValid:!1}}async findElementWithRetry(e,t){let n=0;const r=Date.now(),i=typeof process<"u"&&!1,a=this.fallbackConfig.maxRetries,o=this.fallbackConfig.maxTimeout;for(;n<a&&!(Date.now()-r>o);){try{const l=document.querySelector(e);if(l&&(i||!t||t(l)))return l}catch{break}if(n<a-1){const l=this.fallbackConfig.baseDelay,c=this.fallbackConfig.exponentialBackoff?l*Math.pow(2,n):l;await this.sleep(c)}n++}return null}sleep(e){return new Promise(t=>setTimeout(t,e))}waitForDOM(){return new Promise(e=>{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>e(),{once:!0}):e()})}waitForElement(e,t=5e3,n){return new Promise(r=>{const i=Date.now(),a=()=>{const o=document.querySelector(e);if(o&&(!n||n(o))){r(o);return}if(Date.now()-i>=t){r(null);return}setTimeout(a,100)};a()})}isTestEnvironment(){return typeof process<"u"&&!1}}const Xn={[le.CHATGPT]:[/^https?:\/\/chat\.openai\.com\//i,/^https?:\/\/chatgpt\.com\//i,/^https?:\/\/.*\.openai\.com\/chat\//i],[le.CLAUDE]:[/^https?:\/\/claude\.ai\//i,/^https?:\/\/.*\.anthropic\.com\//i,/^https?:\/\/console\.anthropic\.com\//i]},si={[le.CHATGPT]:{selectors:['[data-testid="chat-input"]','textarea[placeholder*="Message ChatGPT"]',".text-base.gap-6",'[data-testid="send-button"]'],textContent:["ChatGPT","OpenAI"],attributes:[{selector:'meta[property="og:site_name"]',attribute:"content",value:/ChatGPT|OpenAI/i}]},[le.CLAUDE]:{selectors:['[data-testid="chat-input"]','textarea[placeholder*="Talk with Claude"]',".claude-chat",'[data-testid="send-message"]'],textContent:["Claude","Anthropic"],attributes:[{selector:'meta[property="og:site_name"]',attribute:"content",value:/Claude|Anthropic/i}]}};class ri{detectionCache=new Map;cacheTimeout=3e4;async detectSite(e){const t=performance.now(),n=e||(typeof window<"u"?window.location.href:""),r=this.getCachedResult(n);if(r)return{...r,metadata:{...r.metadata,fromCache:!0,detectionTime:performance.now()-t}};try{const i=await this.performDetection(n,t);return i.confidence>.5&&this.setCachedResult(n,i),i}catch(i){const a=performance.now()-t;return{type:null,confidence:0,url:n,metadata:{detectionTime:a,error:i instanceof Error?i.message:"Unknown error"}}}}async performDetection(e,t){let n=null,r=0,i={};for(const o of Object.values(le)){const{confidence:l,metadata:c}=await this.testSiteType(o,e);l>r&&(n=o,r=l,i={...i,[`${o}_detection`]:c})}const a=performance.now()-t;return{type:r>.5?n:null,confidence:r,url:e,metadata:{detectionTime:a,...i,allScores:i}}}async testSiteType(e,t){let n=0;const r={};if(Xn[e].some(o=>o.test(t))&&(n+=.7,r.urlMatch=!0),typeof document<"u"){const o=await this.testDOMPatterns(e);n+=o*.3,r.domConfidence=o}else r.domConfidence=0;return{confidence:Math.min(n,1),metadata:r}}async testDOMPatterns(e){const t=si[e];let n=0,r=0;if(t.selectors)for(const i of t.selectors){r++;try{document.querySelector(i)&&n++}catch{}}if(t.textContent){r++;const i=document.body?.textContent?.toLowerCase()||"";t.textContent.some(a=>i.includes(a.toLowerCase()))&&n++}if(t.attributes)for(const{selector:i,attribute:a,value:o}of t.attributes){r++;try{const c=document.querySelector(i)?.getAttribute(a);c&&o.test(c)&&n++}catch{}}return r>0?n/r:0}async isSiteSupported(e){const t=await this.detectSite(e);return t.type!==null&&t.confidence>.5}getSupportedSites(){return Object.values(le)}getUrlPatterns(e){return[...Xn[e]]}clearCache(){this.detectionCache.clear()}getCachedResult(e){const t=this.detectionCache.get(e);return t?Date.now()-(t.metadata?.cacheTime||0)>this.cacheTimeout?(this.detectionCache.delete(e),null):t:null}setCachedResult(e,t){const n={...t,metadata:{...t.metadata,cacheTime:Date.now()}};this.detectionCache.set(e,n)}}const Jt=new ri;class Cs{adapters=new Map;initialized=!1;register(e){if(this.adapters.has(e.siteType)){console.log(`[PromptLint] Adapter for ${e.siteType} already registered, skipping`);return}this.adapters.set(e.siteType,e)}registerOrUpdate(e){this.adapters.set(e.siteType,e)}async getAdapter(e){const t=await Jt.detectSite(e);if(!t.type||t.confidence<.5)return null;const n=this.adapters.get(t.type);if(!n)throw new mt(ze.SITE_NOT_DETECTED,`No adapter registered for site type: ${t.type}`,{siteType:t.type,detection:t});return n}getAllAdapters(){return Array.from(this.adapters.values())}async isSiteSupported(e){const t=await Jt.detectSite(e);return t.type!==null&&t.confidence>.5&&this.adapters.has(t.type)}getAdapterByType(e){return this.adapters.get(e)||null}hasAdapter(e){return this.adapters.has(e)}getRegisteredSiteTypes(){return Array.from(this.adapters.keys())}async initializeAll(){if(this.initialized)return;const e=this.getAllAdapters().map(async t=>{try{await t.initialize()}catch(n){throw console.warn(`Failed to initialize ${t.siteType} adapter:`,n),new mt(ze.INITIALIZATION_FAILED,`Failed to initialize ${t.siteType} adapter`,{siteType:t.siteType,error:n})}});await Promise.all(e),this.initialized=!0}cleanupAll(){for(const e of this.getAllAdapters())try{e.cleanup()}catch(t){console.warn(`Failed to cleanup ${e.siteType} adapter:`,t)}this.initialized=!1}unregister(e){const t=this.adapters.get(e);if(t){try{t.cleanup()}catch(n){console.warn(`Failed to cleanup ${e} adapter during unregister:`,n)}return this.adapters.delete(e)}return!1}clear(){this.cleanupAll(),this.adapters.clear()}getStats(){return{totalAdapters:this.adapters.size,registeredSites:this.getRegisteredSiteTypes(),initialized:this.initialized}}}const ft=new Cs;async function Is(){return ft.getAdapter()}const ii=Object.freeze(Object.defineProperty({__proto__:null,AdapterRegistry:Cs,adapterRegistry:ft,getCurrentSiteAdapter:Is},Symbol.toStringTag,{value:"Module"})),Ye={input:{primary:"#prompt-textarea",fallbacks:['textarea[data-testid="chat-input"]','textarea[placeholder*="Message ChatGPT"]','textarea[placeholder*="Send a message"]','.ProseMirror[contenteditable="true"]','div[contenteditable="true"][data-testid="chat-input"]',"textarea.m-0","form textarea:not([disabled])"],validator:s=>{const e=s;if(!e.offsetParent)return!1;const t=e.getAttribute("role")==="textbox"||e.tagName.toLowerCase()==="textarea",n=e.getAttribute("placeholder")?.toLowerCase().includes("message")||e.getAttribute("placeholder")?.toLowerCase().includes("send"),r=e.getAttribute("contenteditable")==="true";return t||n||r},description:"Main chat input textarea"},submit:{primary:'button[data-testid="send-button"]',fallbacks:['button[aria-label*="Send message"]','button[aria-label*="Send"]','form button[type="submit"]','button:has(svg[data-icon="send"])',".btn-primary:last-of-type","button.absolute.p-1.rounded-md",'button[disabled]:has-text("Send")',"form button:not([disabled]):last-child"],validator:s=>{const e=s;if(e.tagName.toLowerCase()!=="button")return!1;const t=e.getAttribute("aria-label")?.toLowerCase(),n=t?.includes("send")||t?.includes("submit"),r=e.querySelector("svg")!==null,i=e.classList.contains("absolute")||e.closest("form")?.lastElementChild===e;return n||r||i},description:"Send message button"},chatContainer:{primary:'main[class*="conversation"]',fallbacks:[".conversation-turn-container",'[data-testid="conversation-turn"]',".text-base.gap-6","main.relative.h-full",".flex.flex-col.text-sm",'div[class*="chat"]','main div[class*="conversation"]',".overflow-hidden.w-full.h-full.relative.flex"],validator:s=>{const e=s.querySelectorAll('[data-testid*="conversation"], .conversation, [class*="message"]').length>0,t=s.tagName.toLowerCase()==="main",n=s.scrollHeight>s.clientHeight;return e||t||n},description:"Main chat conversation container"},injectionPoint:{primary:'form[class*="stretch"]',fallbacks:["form:has(textarea)",".relative.flex.h-full.flex-1.flex-col","main.relative.h-full",'div[class*="composer"]',".flex.w-full.items-center","form.flex.flex-row.gap-3","body > div:first-child","#__next"],validator:s=>{const e=s.querySelector('textarea, [contenteditable="true"]')!==null,t=s.tagName.toLowerCase()==="form"||s.querySelector("form")!==null,n=s.getBoundingClientRect().bottom>window.innerHeight*.5;return e||t||n},description:"UI injection point for floating panel"}},ai={type:le.CHATGPT,urlPatterns:[/^https?:\/\/chat\.openai\.com\//i,/^https?:\/\/chatgpt\.com\//i,/^https?:\/\/.*\.openai\.com\/chat\//i],inputSelector:Ye.input,submitSelector:Ye.submit,chatContainerSelector:Ye.chatContainer,injectionPointSelector:Ye.injectionPoint,metadata:{displayName:"ChatGPT",iconUrl:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjMDBBNjdFIi8+Cjwvc3ZnPgo=",settings:{supportsStreaming:!0,hasCodeExecution:!0,hasFileUpload:!0}}};class Rs extends vs{constructor(){super(ai)}async performAdditionalDetection(){let e=0;const t=['meta[property="og:title"][content*="ChatGPT"]','title:contains("ChatGPT")','[data-testid="chat-input"]',".text-token-text-primary"];let n=0;for(const i of t)try{document.querySelector(i)&&n++}catch{}e+=n/t.length*.15;const r=document.body?.textContent?.toLowerCase()||"";return(r.includes("openai")||r.includes("chatgpt"))&&(e+=.05),Math.min(e,.2)}async performInitialization(){await this.waitForDOM(),this.isTestEnvironment()||(await this.waitForElement('textarea, [contenteditable="true"]',1e4),this.setupDynamicContentObserver()),console.log("ChatGPT adapter initialized successfully")}performCleanup(){console.log("ChatGPT adapter cleaned up")}setupDynamicContentObserver(){const e=new MutationObserver(t=>{for(const n of t)n.type==="childList"&&n.addedNodes.length>0&&console.debug("ChatGPT content updated")});e.observe(document.body,{childList:!0,subtree:!0}),this._contentObserver=e}cleanup(){const e=this._contentObserver;e&&(e.disconnect(),delete this._contentObserver),super.cleanup()}}const oi=new Rs,li=Object.freeze(Object.defineProperty({__proto__:null,ChatGPTAdapter:Rs,chatgptAdapter:oi},Symbol.toStringTag,{value:"Module"})),Qe={input:{primary:'div[contenteditable="true"][data-testid="chat-input"]',fallbacks:['textarea[placeholder*="Talk with Claude"]','textarea[placeholder*="Message Claude"]','div[contenteditable="true"].ProseMirror','[data-testid="message-input"]',".composer textarea",'div[role="textbox"][contenteditable="true"]',"textarea:not([disabled]):last-of-type",'form div[contenteditable="true"]'],validator:s=>{const e=s;if(!e.offsetParent)return!1;const t=e.getAttribute("contenteditable")==="true",n=e.tagName.toLowerCase()==="textarea",r=e.getAttribute("role")==="textbox",i=e.getAttribute("placeholder")?.toLowerCase().includes("claude")||e.getAttribute("placeholder")?.toLowerCase().includes("talk")||e.getAttribute("placeholder")?.toLowerCase().includes("message"),a=e.classList.contains("ProseMirror")||e.querySelector(".ProseMirror")!==null;return(t||n||r)&&(i||a)},description:"Main chat input (contenteditable div or textarea)"},submit:{primary:'button[data-testid="send-message"]',fallbacks:['button[aria-label*="Send message"]','button[aria-label*="Send"]','form button[type="submit"]','button:has(svg[data-icon="send"])','button:has(svg[data-testid="send-icon"])',".send-button","button.bg-accent-main-100","form button:not([disabled]):last-child"],validator:s=>{const e=s;if(e.tagName.toLowerCase()!=="button")return!1;const t=e.getAttribute("aria-label")?.toLowerCase(),n=t?.includes("send")||t?.includes("submit"),r=e.querySelector('svg[data-testid*="send"], svg[data-icon*="send"]')!==null,i=e.classList.contains("bg-accent-main-100")||e.classList.contains("send-button"),a=e.closest("form")?.lastElementChild===e;return n||r||i||a},description:"Send message button"},chatContainer:{primary:'div[data-testid="chat-messages"]',fallbacks:[".conversation-container",'[data-testid="conversation"]','main div[class*="messages"]',".chat-messages",'div[class*="conversation"]',"main.flex.flex-col",'.overflow-y-auto:has([data-testid*="message"])','div:has(> div[data-testid*="message"])'],validator:s=>{const e=s.querySelectorAll('[data-testid*="message"], .message, [class*="message"]').length>0,t=s.scrollHeight>s.clientHeight,n=s.children.length>1;return e||t||n},description:"Main chat messages container"},injectionPoint:{primary:'div[class*="composer"]',fallbacks:['form:has(div[contenteditable="true"])',"form:has(textarea)",".message-input-container",'div:has([data-testid="chat-input"])',"main > div:last-child",".flex.flex-col.gap-2:has(textarea)",'body > div[id^="__next"]',"main.relative"],validator:s=>{const e=s.querySelector('textarea, [contenteditable="true"]')!==null,t=s.classList.toString().includes("composer")||s.querySelector('[class*="composer"]')!==null,n=s.getBoundingClientRect().bottom>window.innerHeight*.4;return e||t||n},description:"UI injection point for floating panel"}},ci={type:le.CLAUDE,urlPatterns:[/^https?:\/\/claude\.ai\//i,/^https?:\/\/.*\.anthropic\.com\//i,/^https?:\/\/console\.anthropic\.com\//i],inputSelector:Qe.input,submitSelector:Qe.submit,chatContainerSelector:Qe.chatContainer,injectionPointSelector:Qe.injectionPoint,metadata:{displayName:"Claude",iconUrl:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiNEOTdCMDAiLz4KPHBhdGggZD0iTTggMTJMMTIgOEwxNiAxMkwxMiAxNkw4IDEyWiIgZmlsbD0iI0ZGRkZGRiIvPgo8L3N2Zz4K",settings:{supportsStreaming:!0,hasCodeExecution:!1,hasFileUpload:!0,usesContentEditable:!0}}};class Ss extends vs{constructor(){super(ci)}async performAdditionalDetection(){let e=0;const t=['meta[property="og:title"][content*="Claude"]','title:contains("Claude")','[data-testid="chat-input"]',".ProseMirror",'[class*="anthropic"]'];let n=0;for(const i of t)try{document.querySelector(i)&&n++}catch{}e+=n/t.length*.15;const r=document.body?.textContent?.toLowerCase()||"";return(r.includes("anthropic")||r.includes("claude"))&&(e+=.05),Math.min(e,.2)}async performInitialization(){await this.waitForDOM(),this.isTestEnvironment()||(await this.waitForElement('div[contenteditable="true"], textarea',1e4),this.setupDynamicContentObserver(),await this.initializeProseMirrorSupport()),console.log("Claude adapter initialized successfully")}performCleanup(){console.log("Claude adapter cleaned up")}setupDynamicContentObserver(){const e=new MutationObserver(t=>{for(const n of t)n.type==="childList"&&n.addedNodes.length>0&&console.debug("Claude content updated")});e.observe(document.body,{childList:!0,subtree:!0}),this._contentObserver=e}async initializeProseMirrorSupport(){const e=await this.waitForElement(".ProseMirror",5e3);e&&(console.debug("ProseMirror editor detected and initialized"),this._proseMirrorEditor=e)}cleanup(){const e=this._contentObserver;e&&(e.disconnect(),delete this._contentObserver),delete this._proseMirrorEditor,super.cleanup()}async getInputText(){const e=await this.findInputElement();if(!e.element)return"";const t=e.element;return t.getAttribute("contenteditable")==="true"?t.textContent||"":t.tagName.toLowerCase()==="textarea"&&t.value||""}async setInputText(e){const t=await this.findInputElement();if(!t.element)return!1;const n=t.element;try{if(n.getAttribute("contenteditable")==="true")return n.textContent=e,n.dispatchEvent(new Event("input",{bubbles:!0})),!0;if(n.tagName.toLowerCase()==="textarea"){const r=n;return r.value=e,r.dispatchEvent(new Event("input",{bubbles:!0})),!0}}catch(r){console.warn("Failed to set input text:",r)}return!1}}const ui=new Ss,di=Object.freeze(Object.defineProperty({__proto__:null,ClaudeAdapter:Ss,claudeAdapter:ui},Symbol.toStringTag,{value:"Module"}));function pi(s){const e=s;if(!e.offsetParent&&e.offsetWidth===0&&e.offsetHeight===0)return!1;const t=window.getComputedStyle(e);return!(t.display==="none"||t.visibility==="hidden"||t.opacity==="0")}function hi(s){const e=s;return!("disabled"in e&&e.disabled||"readOnly"in e&&e.readOnly||e.getAttribute("aria-disabled")==="true")}const mi={maxAttempts:3,baseDelay:100,exponentialBackoff:!0,maxTimeout:5e3,validateElements:!0};class fi{strategy;constructor(e={}){this.strategy={...mi,...e}}async findElement(e){const t=performance.now();let n=0;const r=await this.trySelector(e.primary,e.validator,0);if(n+=r.attempts,r.element)return{element:r.element,successfulSelector:e.primary,selectorIndex:0,totalTime:performance.now()-t,attempts:n,isValid:r.isValid,...r.error&&{error:r.error}};for(let i=0;i<e.fallbacks.length;i++){const a=e.fallbacks[i],o=await this.trySelector(a,e.validator,i+1);if(n+=o.attempts,o.element)return{element:o.element,successfulSelector:a,selectorIndex:i+1,totalTime:performance.now()-t,attempts:n,isValid:o.isValid,...o.error&&{error:o.error}};if(performance.now()-t>this.strategy.maxTimeout)break}return{element:null,successfulSelector:null,selectorIndex:-1,totalTime:performance.now()-t,attempts:n,isValid:!1,error:new mt(ze.ELEMENT_NOT_FOUND,`Failed to find element after trying ${e.fallbacks.length+1} selectors`,{primarySelector:e.primary,fallbackSelectors:e.fallbacks,description:e.description})}}async trySelector(e,t,n=0){let r=0,i;for(;r<this.strategy.maxAttempts;){try{const a=document.querySelector(e);if(a){if(this.strategy.validateElements){if(!pi(a)){r++,await this.delay(r);continue}if(!hi(a)){r++,await this.delay(r);continue}}if(t?t(a):!0)return{element:a,attempts:r+1,isValid:!0}}}catch(a){i=a instanceof Error?a:new Error("Unknown selector error");break}r++,r<this.strategy.maxAttempts&&await this.delay(r)}return{element:null,attempts:r,isValid:!1,...i&&{error:i}}}async delay(e){const t=this.strategy.exponentialBackoff?this.strategy.baseDelay*Math.pow(2,e-1):this.strategy.baseDelay;return new Promise(n=>setTimeout(n,Math.min(t,1e3)))}updateStrategy(e){this.strategy={...this.strategy,...e}}getStrategy(){return{...this.strategy}}}new fi;async function gi(){const{adapterRegistry:s}=await Mt(async()=>{const{adapterRegistry:n}=await Promise.resolve().then(()=>ii);return{adapterRegistry:n}},void 0),{chatgptAdapter:e}=await Mt(async()=>{const{chatgptAdapter:n}=await Promise.resolve().then(()=>li);return{chatgptAdapter:n}},void 0),{claudeAdapter:t}=await Mt(async()=>{const{claudeAdapter:n}=await Promise.resolve().then(()=>di);return{claudeAdapter:n}},void 0);s.registerOrUpdate(e),s.registerOrUpdate(t),await s.initializeAll()}class Yn{panel=null;scoreElement=null;issuesContainer=null;rephraseButton=null;rephraseToggleButton=null;rephraseContainer=null;aiAgentDropdown=null;aiAgentDropdownMenu=null;selectedAiAgent="Auto";isDropdownOpen=!1;isVisible=!1;isRephraseMode=!1;currentPrompt="";options;rephraseCallbacks;constructor(e={},t={}){this.options={position:e.position||"bottom-right",autoHide:e.autoHide!==!1,animationDuration:e.animationDuration||200,enableRephrase:e.enableRephrase!==!1},this.rephraseCallbacks=t}async initialize(){try{this.createPanel(),this.attachStyles(),console.log("[PromptLint] Floating panel initialized")}catch(e){throw console.error("[PromptLint] Failed to initialize floating panel:",e),e}}createPanel(){this.panel=document.createElement("div"),this.panel.id="promptlint-floating-panel",this.panel.className=`promptlint-panel promptlint-panel--${this.options.position}`;const e=document.createElement("div");e.className="promptlint-panel__header";const t=document.createElement("div");t.className="promptlint-panel__drag-handle",t.innerHTML="⋮⋮",t.title="Drag to move panel";const n=document.createElement("div");n.className="promptlint-panel__title",n.textContent="PromptLint",this.aiAgentDropdown=document.createElement("div"),this.aiAgentDropdown.className="promptlint-panel__ai-agent",this.aiAgentDropdown.innerHTML=`
      <span class="ai-agent-text">Auto</span>
      <span class="dropdown-arrow">▼</span>
    `,this.aiAgentDropdown.addEventListener("click",a=>{a.stopPropagation(),this.toggleAiAgentDropdown()}),this.aiAgentDropdownMenu=document.createElement("div"),this.aiAgentDropdownMenu.className="promptlint-panel__ai-agent-menu",this.aiAgentDropdownMenu.style.display="none",[{id:"auto",name:"Auto",description:"Auto-detect current site"},{id:"chatgpt",name:"ChatGPT",description:"OpenAI GPT models"},{id:"claude",name:"Claude",description:"Anthropic Claude"},{id:"gemini",name:"Gemini",description:"Google Gemini"},{id:"copilot",name:"Copilot",description:"Microsoft Copilot"},{id:"perplexity",name:"Perplexity",description:"Perplexity AI"}].forEach(a=>{const o=document.createElement("div");o.className="ai-agent-option",o.dataset.agentId=a.id,o.innerHTML=`
        <div class="ai-agent-option-name">${a.name}</div>
        <div class="ai-agent-option-description">${a.description}</div>
      `,o.addEventListener("click",l=>{l.stopPropagation(),this.selectAiAgent(a.id,a.name)}),this.aiAgentDropdownMenu?.appendChild(o)}),this.aiAgentDropdown.appendChild(this.aiAgentDropdownMenu),this.rephraseToggleButton=document.createElement("button"),this.rephraseToggleButton.className="promptlint-panel__rephrase-toggle",this.rephraseToggleButton.textContent="Rephrase",this.rephraseToggleButton.addEventListener("click",()=>this.toggleRephraseMode()),this.scoreElement=document.createElement("div"),this.scoreElement.className="promptlint-panel__score",this.scoreElement.textContent="0",e.appendChild(t),e.appendChild(n),e.appendChild(this.aiAgentDropdown),e.appendChild(this.rephraseToggleButton),e.appendChild(this.scoreElement),this.issuesContainer=document.createElement("div"),this.issuesContainer.className="promptlint-panel__issues",this.rephraseContainer=document.createElement("div"),this.rephraseContainer.className="promptlint-panel__rephrase",this.rephraseContainer.style.display="none",console.log("[PromptLint DEBUG] Created rephraseContainer:",this.rephraseContainer),console.log("[PromptLint DEBUG] rephraseContainer className:",this.rephraseContainer.className);const i=document.createElement("button");i.className="promptlint-panel__toggle",i.innerHTML="−",i.addEventListener("click",()=>this.toggleCollapse()),e.appendChild(i),console.log("[PromptLint DEBUG] Assembling panel with components:"),console.log("[PromptLint DEBUG] - header:",e),console.log("[PromptLint DEBUG] - issuesContainer:",this.issuesContainer),console.log("[PromptLint DEBUG] - rephraseButton:",this.rephraseButton),console.log("[PromptLint DEBUG] - rephraseContainer:",this.rephraseContainer),this.panel.appendChild(e),this.panel.appendChild(this.issuesContainer),this.panel.appendChild(this.rephraseContainer),console.log("[PromptLint DEBUG] Appended rephrase container to panel"),console.log("[PromptLint DEBUG] Final panel structure:",this.panel.outerHTML),this.panel.style.display="none",document.body.appendChild(this.panel),this.initializeDrag(t),this.loadPosition(),console.log("[PromptLint DEBUG] Panel added to document.body"),console.log("[PromptLint DEBUG] Panel in DOM:",document.body.contains(this.panel)),console.log("[PromptLint DEBUG] rephraseContainer in DOM:",document.body.contains(this.rephraseContainer))}attachStyles(){if(document.getElementById("promptlint-panel-styles"))return;const e=document.createElement("style");e.id="promptlint-panel-styles",e.textContent=this.getPanelCSS(),document.head.appendChild(e)}getPanelCSS(){return`
      .promptlint-panel {
        position: fixed;
        z-index: 10000;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(14px) !important;
        -webkit-backdrop-filter: blur(14px) !important;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
        min-width: 320px;
        max-width: 380px;
        transition: all ${this.options.animationDuration}ms ease;
        overflow: hidden;
      }

      .promptlint-panel--bottom-right {
        bottom: 20px;
        right: 20px;
      }

      .promptlint-panel--top-right {
        top: 20px;
        right: 20px;
      }

      .promptlint-panel--bottom-left {
        bottom: 20px;
        left: 20px;
      }

      .promptlint-panel--top-left {
        top: 20px;
        left: 20px;
      }

      .promptlint-panel__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: rgba(59, 130, 246, 0.05);
        backdrop-filter: blur(14px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px 12px 0 0;
        position: relative;
        gap: 12px;
        min-height: 48px;
      }

      .promptlint-panel__drag-handle {
        cursor: grab;
        color: rgba(255, 255, 255, 0.9);
        font-size: 10px;
        font-weight: 600;
        padding: 6px;
        border-radius: 4px;
        transition: all 0.2s ease;
        user-select: none;
        background: transparent;
        border: none;
        z-index: 1;
        position: relative;
      }

      .promptlint-panel__drag-handle:hover {
        color: rgba(255, 255, 255, 1);
        background: rgba(59, 130, 246, 0.1);
        border-radius: 4px;
      }

      .promptlint-panel__drag-handle:active {
        cursor: grabbing;
        background: rgba(59, 130, 246, 0.15);
      }

      .promptlint-panel__title {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
        font-size: 13px;
        flex: 1;
        text-align: center;
        letter-spacing: 0.025em;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
      }

      .promptlint-panel__ai-agent {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        background: transparent;
        border: none;
        font-weight: 500;
        position: relative;
        z-index: 1;
      }

      .promptlint-panel__ai-agent:hover {
        background: rgba(59, 130, 246, 0.1);
        color: rgba(255, 255, 255, 1);
        border-radius: 4px;
      }

      .promptlint-panel__ai-agent:active {
        background: rgba(59, 130, 246, 0.15);
      }

      .dropdown-arrow {
        font-size: 8px;
        margin-left: 2px;
        opacity: 0.8;
        transition: transform 0.2s ease;
      }

      .promptlint-panel__ai-agent:hover .dropdown-arrow {
        transform: rotate(180deg);
      }

      .promptlint-panel__ai-agent.open .dropdown-arrow {
        transform: rotate(180deg);
      }

      .promptlint-panel__ai-agent-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(14px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 100000;
        margin-top: 4px;
        min-width: 200px;
        max-height: 300px;
        overflow-y: auto;
        animation: dropdownFadeIn 0.2s ease-out;
        /* Ensure dropdown can be positioned outside panel boundaries */
        pointer-events: auto;
      }

      @keyframes dropdownFadeIn {
        from {
          opacity: 0;
          transform: translateY(-8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .ai-agent-option {
        padding: 10px 12px;
        cursor: pointer;
        transition: all 0.15s ease;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .ai-agent-option:last-child {
        border-bottom: none;
      }

      .ai-agent-option:hover {
        background: rgba(59, 130, 246, 0.15);
      }

      .ai-agent-option-name {
        font-weight: 500;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 2px;
      }

      .ai-agent-option-description {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.6);
        line-height: 1.3;
      }

      .promptlint-panel__rephrase-toggle {
        background: rgba(59, 130, 246, 0.8);
        color: white;
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        backdrop-filter: blur(8px);
        box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
        min-width: 70px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 32px;
      }

      .promptlint-panel__rephrase-toggle:hover {
        background: rgba(59, 130, 246, 0.9);
        border-color: rgba(59, 130, 246, 0.3);
        transform: translateY(-1px);
        box-shadow: 0 0 16px rgba(59, 130, 246, 0.6);
      }

      .promptlint-panel__rephrase-toggle.active {
        background: rgba(239, 68, 68, 0.8);
        border-color: rgba(239, 68, 68, 0.2);
        box-shadow: 0 0 12px rgba(239, 68, 68, 0.4);
      }

      .promptlint-panel__rephrase-toggle.active:hover {
        background: rgba(239, 68, 68, 0.9);
        border-color: rgba(239, 68, 68, 0.3);
        box-shadow: 0 0 16px rgba(239, 68, 68, 0.6);
      }

      .promptlint-panel__score {
        font-weight: 700;
        font-size: 14px;
        padding: 6px 10px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(8px);
        min-width: 32px;
        text-align: center;
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 32px;
      }

      .promptlint-panel__score--poor {
        background: rgba(239, 68, 68, 0.2);
        border-color: rgba(239, 68, 68, 0.3);
        color: rgba(255, 255, 255, 0.95);
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
      }

      .promptlint-panel__score--fair {
        background: rgba(245, 158, 11, 0.2);
        border-color: rgba(245, 158, 11, 0.3);
        color: rgba(255, 255, 255, 0.95);
        box-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
      }

      .promptlint-panel__score--good {
        background: rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.3);
        color: rgba(255, 255, 255, 0.95);
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
      }

      .promptlint-panel__score--excellent {
        background: #d4edda;
        color: #155724;
      }

      .promptlint-panel__score--good {
        background: #d1ecf1;
        color: #0c5460;
      }

      .promptlint-panel__score--fair {
        background: #fff3cd;
        color: #856404;
      }

      .promptlint-panel__score--poor {
        background: #f8d7da;
        color: #721c24;
      }

      .promptlint-panel__toggle {
        background: transparent;
        border: none;
        font-size: 14px;
        cursor: pointer;
        padding: 6px;
        color: rgba(255, 255, 255, 0.9);
        border-radius: 4px;
        transition: all 0.2s ease;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 1;
      }

      .promptlint-panel__toggle:hover {
        background: rgba(59, 130, 246, 0.1);
        color: rgba(255, 255, 255, 1);
        border-radius: 4px;
      }

      .promptlint-panel__toggle:active {
        background: rgba(59, 130, 246, 0.15);
      }

      .promptlint-panel__issues {
        padding: 0;
        max-height: 300px;
        overflow-y: auto;
        background: transparent;
        border: none;
        border-radius: 0;
        box-shadow: none;
      }

      .promptlint-panel__issue {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .promptlint-panel__issue:last-child {
        border-bottom: none;
      }

      .promptlint-panel__issue-icon {
        flex-shrink: 0;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-top: 2px;
      }

      .promptlint-panel__issue-icon--high {
        background: #dc3545;
      }

      .promptlint-panel__issue-icon--medium {
        background: #ffc107;
      }

      .promptlint-panel__issue-icon--low {
        background: #17a2b8;
      }

      .promptlint-panel__issue-content {
        flex: 1;
      }

      .promptlint-panel__issue-title {
        font-weight: 500;
        color: #1a1a1a;
        margin-bottom: 2px;
        font-size: 13px;
      }

      .promptlint-panel__issue-description {
        color: #6c757d;
        font-size: 12px;
        line-height: 1.4;
      }

      .promptlint-panel__no-issues {
        padding: 16px;
        text-align: center;
        color: #28a745;
        font-weight: 500;
        font-size: 13px;
      }

      .promptlint-panel--collapsed .promptlint-panel__issues {
        display: none;
      }

      .promptlint-panel--collapsed .promptlint-panel__toggle {
        transform: rotate(180deg);
      }

      /* Animation states */
      .promptlint-panel--entering {
        opacity: 0;
        transform: translateY(10px);
      }

      .promptlint-panel--entered {
        opacity: 1;
        transform: translateY(0);
      }

      .promptlint-panel--exiting {
        opacity: 0;
        transform: translateY(10px);
      }

      .promptlint-panel__rephrase {
        background: transparent;
        border: none;
        border-radius: 0;
        box-shadow: none;
        backdrop-filter: none;
        overflow: hidden;
      }

      .promptlint-panel__rephrase-mode {
        border-radius: 12px;
      }
    `}updateResults(e,t){if(!this.panel||!this.scoreElement||!this.issuesContainer){console.warn("[PromptLint] Panel not initialized");return}this.updateScore(e.score),this.updateIssues(e.issues),t&&this.updatePrompt(t),this.options.autoHide?e.issues.length>0?this.show():(this.show(),setTimeout(()=>this.hide(),2e3)):this.show()}updateScore(e){this.scoreElement&&(this.scoreElement.textContent=e.toString(),this.scoreElement.className="promptlint-panel__score",e>=71?this.scoreElement.classList.add("promptlint-panel__score--good"):e>=41?this.scoreElement.classList.add("promptlint-panel__score--fair"):this.scoreElement.classList.add("promptlint-panel__score--poor"))}updateIssues(e){if(this.issuesContainer){if(this.issuesContainer.innerHTML="",e.length===0){const t=document.createElement("div");t.className="promptlint-panel__no-issues",t.textContent="✓ Great prompt quality!",this.issuesContainer.appendChild(t);return}e.forEach(t=>{const n=document.createElement("div");n.className="promptlint-panel__issue";const r=document.createElement("div");r.className=`promptlint-panel__issue-icon promptlint-panel__issue-icon--${t.severity}`;const i=document.createElement("div");i.className="promptlint-panel__issue-content";const a=document.createElement("div");a.className="promptlint-panel__issue-title",a.textContent=this.getIssueTitle(t);const o=document.createElement("div");o.className="promptlint-panel__issue-description",o.textContent=t.message,i.appendChild(a),i.appendChild(o),n.appendChild(r),n.appendChild(i),this.issuesContainer&&this.issuesContainer.appendChild(n)})}}getIssueTitle(e){return{missing_task_verb:"Missing Action Verb",missing_language:"Missing Programming Language",missing_io_specification:"Missing Input/Output Details",vague_wording:"Vague Language",unclear_scope:"Unclear Scope",redundant_language:"Redundant Wording"}[e.type]||"Quality Issue"}show(){!this.panel||this.isVisible||(this.panel.style.display="block",this.panel.classList.add("promptlint-panel--entering"),requestAnimationFrame(()=>{this.panel&&(this.panel.classList.remove("promptlint-panel--entering"),this.panel.classList.add("promptlint-panel--entered"))}),this.isVisible=!0)}hide(){!this.panel||!this.isVisible||(this.panel.classList.remove("promptlint-panel--entered"),this.panel.classList.add("promptlint-panel--exiting"),setTimeout(()=>{this.panel&&(this.panel.style.display="none",this.panel.classList.remove("promptlint-panel--exiting"))},this.options.animationDuration),this.isVisible=!1)}toggleCollapse(){if(!this.panel)return;this.panel.classList.toggle("promptlint-panel--collapsed");const e=this.panel.querySelector(".promptlint-panel__toggle");e&&(e.innerHTML=this.panel.classList.contains("promptlint-panel--collapsed")?"+":"−")}async handleRephraseClick(){if(!this.rephraseCallbacks.onRephraseRequest||!this.currentPrompt){console.warn("[PromptLint] No rephrase callback or prompt available");return}try{this.rephraseButton&&(this.rephraseButton.innerHTML="⏳ Rephrasing...",this.rephraseButton.disabled=!0);const e=await this.rephraseCallbacks.onRephraseRequest(this.currentPrompt);this.displayRephraseCandidates(e)}catch(e){console.error("[PromptLint] Rephrase failed:",e),this.showRephraseError(e instanceof Error?e.message:"Rephrase failed")}finally{this.rephraseButton&&(this.rephraseButton.innerHTML="Rephrase",this.rephraseButton.disabled=!1)}}displayRephraseCandidates(e){if(console.log("[PromptLint DEBUG] displayRephraseCandidates called"),console.log("[PromptLint DEBUG] rephraseContainer exists:",!!this.rephraseContainer),console.log("[PromptLint DEBUG] panel exists:",!!this.panel),console.log("[PromptLint DEBUG] result:",e),!this.rephraseContainer||!this.panel){console.error("[PromptLint DEBUG] Missing DOM elements - rephraseContainer or panel is null");return}console.log("[PromptLint DEBUG] rephraseContainer element:",this.rephraseContainer),console.log("[PromptLint DEBUG] rephraseContainer parent:",this.rephraseContainer.parentElement),console.log("[PromptLint DEBUG] panel element:",this.panel),console.log("[PromptLint DEBUG] panel parent:",this.panel.parentElement),this.isRephraseMode=!0,this.rephraseContainer.innerHTML="",this.rephraseContainer.style.display="block",this.rephraseContainer.style.maxHeight="600px",this.rephraseContainer.style.overflowY="auto",this.rephraseContainer.style.padding="16px",this.rephraseContainer.style.background="transparent",this.rephraseContainer.style.backdropFilter="none",this.rephraseContainer.style.borderRadius="0",this.rephraseContainer.style.border="none",this.rephraseContainer.style.boxShadow="none",console.log("[PromptLint DEBUG] Set rephraseContainer display to block"),console.log("[PromptLint DEBUG] rephraseContainer computed styles:",window.getComputedStyle(this.rephraseContainer)),this.panel.classList.add("promptlint-panel--rephrase-mode"),console.log("[PromptLint DEBUG] Added rephrase-mode class to panel"),console.log("[PromptLint DEBUG] Processing candidates:",e.candidates.length),e.candidates.forEach((l,c)=>{console.log(`[PromptLint DEBUG] Creating candidate ${c}:`,l);const m=document.createElement("div");m.className="promptlint-panel__issue",m.innerHTML=`
        <div class="promptlint-panel__issue" style="
          background: rgba(255, 255, 255, 0.9);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 12px;
          margin-bottom: 12px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
          transition: all 0.3s ease;
          overflow: hidden;
          position: relative;
        ">
          <!-- Small Badge -->
          <div style="
            position: absolute;
            top: 12px;
            left: 16px;
            background: ${this.getApproachColor(l.approach)};
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 2;
          ">${l.approach}</div>
          
          <!-- Content Area -->
          <div style="
            padding: 40px 16px 60px 16px;
            color: #1f2937;
            line-height: 1.6;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          ">${this.formatRephraseText(l.text)}</div>
          
          <!-- Action Button -->
          <div style="
            position: absolute;
            bottom: 12px;
            right: 16px;
          ">
            <button class="promptlint-copy-btn" title="Copy to clipboard" style="
              background: rgba(59, 130, 246, 0.9);
              color: white;
              border: none;
              border-radius: 8px;
              padding: 8px 16px;
              font-size: 12px;
              font-weight: 500;
              cursor: pointer;
              transition: all 0.2s ease;
              backdrop-filter: blur(10px);
              box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            ">Copy</button>
          </div>
        </div>
      `,console.log(`[PromptLint DEBUG] Candidate ${c} HTML:`,m.outerHTML),console.log(`[PromptLint DEBUG] Candidate ${c} classes:`,m.className);const u=m.querySelector(".promptlint-copy-btn");if(u){u.addEventListener("mouseenter",()=>{u.style.background="rgba(37, 99, 235, 0.95)",u.style.transform="translateY(-2px)",u.style.boxShadow="0 4px 16px rgba(37, 99, 235, 0.4)"}),u.addEventListener("mouseleave",()=>{u.style.background="rgba(59, 130, 246, 0.9)",u.style.transform="translateY(0)",u.style.boxShadow="0 2px 8px rgba(59, 130, 246, 0.3)"}),u.addEventListener("click",E=>{E.stopPropagation(),console.log(`[PromptLint DEBUG] Copy button ${c} clicked`),this.copyToClipboard(l.text),this.showCopyFeedback(u)});const d=window.getComputedStyle(u);console.log(`[PromptLint DEBUG] Copy button ${c} styling:`,{background:d.background,color:d.color,border:d.border,borderRadius:d.borderRadius,padding:d.padding,fontSize:d.fontSize,fontWeight:d.fontWeight,cursor:d.cursor,boxShadow:d.boxShadow})}else console.error(`[PromptLint DEBUG] Copy button ${c} not found!`);const p=m.querySelector(".promptlint-panel__issue-icon");if(p){const d=window.getComputedStyle(p);console.log(`[PromptLint DEBUG] Approach label ${c} styling:`,{background:d.background,color:d.color,borderRadius:d.borderRadius,padding:d.padding,fontSize:d.fontSize,fontWeight:d.fontWeight,textTransform:d.textTransform,letterSpacing:d.letterSpacing,minWidth:d.minWidth,textAlign:d.textAlign,boxShadow:d.boxShadow})}else console.error(`[PromptLint DEBUG] Approach label ${c} not found!`);const h=m.querySelector(".promptlint-panel__issue-content");if(h){const d=window.getComputedStyle(h),E=h.getBoundingClientRect();console.log(`[PromptLint DEBUG] Card container ${c} styling:`,{background:d.background,border:d.border,borderRadius:d.borderRadius,padding:d.padding,margin:d.margin,boxShadow:d.boxShadow,width:E.width,height:E.height})}else console.error(`[PromptLint DEBUG] Card container ${c} not found!`);this.rephraseContainer&&this.rephraseContainer.appendChild(m),console.log(`[PromptLint DEBUG] Appended candidate ${c} directly to rephraseContainer`);const f=m.querySelector(".promptlint-panel__issue-description");if(f){const d=window.getComputedStyle(f),E=f.getBoundingClientRect();console.log(`[PromptLint DEBUG] Candidate ${c} description element:`,{element:f,innerHTML:f.innerHTML,textContent:f.textContent,innerText:f.innerText,className:f.className,computedStyles:{whiteSpace:d.whiteSpace,wordWrap:d.wordWrap,overflowWrap:d.overflowWrap,display:d.display,width:d.width,maxWidth:d.maxWidth,height:d.height,lineHeight:d.lineHeight,fontSize:d.fontSize,fontFamily:d.fontFamily,color:d.color,backgroundColor:d.backgroundColor,padding:d.padding,margin:d.margin,border:d.border,position:d.position,overflow:d.overflow,textOverflow:d.textOverflow},boundingRect:{width:E.width,height:E.height,x:E.x,y:E.y}});const A=f.textContent||"",y=(A.match(/\n/g)||[]).length;console.log(`[PromptLint DEBUG] Candidate ${c} line break analysis:`,{textContentLength:A.length,lineBreakCount:y,hasLineBreaks:y>0,firstLineBreakIndex:A.indexOf(`
`),textContentPreview:A.substring(0,100)+"..."})}});const t=document.createElement("div");t.className="promptlint-panel__issue",t.innerHTML=`
      <div class="promptlint-panel__issue" style="
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        margin-top: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
        cursor: pointer;
      ">
        <!-- Small Badge -->
        <div style="
          position: absolute;
          top: 12px;
          left: 16px;
          background: #6b7280;
          color: white;
          padding: 4px 8px;
          border-radius: 6px;
          font-size: 10px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          z-index: 2;
        ">Close</div>
        
        <!-- Content Area -->
        <div style="
          padding: 40px 16px 16px 16px;
          color: #6b7280;
          line-height: 1.6;
          font-size: 14px;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        ">Return to lint results</div>
      </div>
    `,t.addEventListener("click",()=>this.hideRephrase()),this.rephraseContainer&&this.rephraseContainer.appendChild(t),console.log("[PromptLint DEBUG] Final rephraseContainer innerHTML:",this.rephraseContainer.innerHTML);const n=window.getComputedStyle(this.rephraseContainer),r=this.rephraseContainer.getBoundingClientRect(),i=this.panel?.getBoundingClientRect();console.log("[PromptLint DEBUG] rephraseContainer ACTUAL computed styles:",{display:n.display,visibility:n.visibility,opacity:n.opacity,width:n.width,height:n.height,color:n.color,backgroundColor:n.backgroundColor,position:n.position,top:n.top,left:n.left,zIndex:n.zIndex,overflow:n.overflow,padding:n.padding,margin:n.margin}),console.log("[PromptLint DEBUG] rephraseContainer ACTUAL bounding rect:",{width:r.width,height:r.height,x:r.x,y:r.y,top:r.top,left:r.left,bottom:r.bottom,right:r.right}),console.log("[PromptLint DEBUG] Panel ACTUAL bounding rect:",i?{width:i.width,height:i.height,x:i.x,y:i.y,top:i.top,left:i.left,bottom:i.bottom,right:i.right}:"null"),console.log("[PromptLint DEBUG] All stylesheets on page:"),Array.from(document.styleSheets).forEach((l,c)=>{try{console.log(`[PromptLint DEBUG] Stylesheet ${c}:`,{href:l.href,ownerNode:l.ownerNode,rulesCount:l.cssRules?.length||"N/A"})}catch{console.log(`[PromptLint DEBUG] Stylesheet ${c}: Cross-origin or inaccessible`)}});const a=document.getElementById("promptlint-panel-styles");console.log("[PromptLint DEBUG] PromptLint styles element exists:",!!a),a&&console.log("[PromptLint DEBUG] PromptLint styles content length:",a.textContent?.length||0);const o=this.rephraseContainer.querySelector(".promptlint-panel__issue");if(o){console.log("[PromptLint DEBUG] Sample candidate computed styles:",window.getComputedStyle(o)),console.log("[PromptLint DEBUG] Sample candidate bounding rect:",o.getBoundingClientRect());const l=window.getComputedStyle(o),c=o.getBoundingClientRect();console.log("[PromptLint DEBUG] Sample candidate ACTUAL computed styles:",{display:l.display,visibility:l.visibility,opacity:l.opacity,width:l.width,height:l.height,color:l.color,backgroundColor:l.backgroundColor,border:l.border,borderBottom:l.borderBottom,padding:l.padding,margin:l.margin,fontSize:l.fontSize,fontWeight:l.fontWeight,lineHeight:l.lineHeight,position:l.position,top:l.top,left:l.left,zIndex:l.zIndex}),console.log("[PromptLint DEBUG] Sample candidate ACTUAL bounding rect:",{width:c.width,height:c.height,x:c.x,y:c.y,top:c.top,left:c.left,bottom:c.bottom,right:c.right});const m=o.querySelector(".promptlint-panel__issue-icon");o.querySelector(".promptlint-panel__issue-content");const u=o.querySelector(".promptlint-panel__issue-description");if(m){const p=window.getComputedStyle(m),h=m.getBoundingClientRect();console.log("[PromptLint DEBUG] Approach element ACTUAL styles:",{display:p.display,visibility:p.visibility,opacity:p.opacity,color:p.color,backgroundColor:p.backgroundColor,fontSize:p.fontSize,padding:p.padding,width:p.width,height:p.height}),console.log("[PromptLint DEBUG] Approach element ACTUAL rect:",{width:h.width,height:h.height,x:h.x,y:h.y})}if(u){const p=window.getComputedStyle(u),h=u.getBoundingClientRect();console.log("[PromptLint DEBUG] Text element ACTUAL styles:",{display:p.display,visibility:p.visibility,opacity:p.opacity,color:p.color,backgroundColor:p.backgroundColor,fontSize:p.fontSize,fontWeight:p.fontWeight,lineHeight:p.lineHeight,whiteSpace:p.whiteSpace,wordWrap:p.wordWrap,width:p.width,height:p.height}),console.log("[PromptLint DEBUG] Text element ACTUAL rect:",{width:h.width,height:h.height,x:h.x,y:h.y})}}else console.error("[PromptLint DEBUG] No candidate elements found after injection!")}handleCandidateSelect(e){this.rephraseCallbacks.onRephraseSelect&&this.rephraseCallbacks.onRephraseSelect(e,this.currentPrompt),this.hideRephrase()}async copyToClipboard(e){try{await navigator.clipboard.writeText(e),console.log("[PromptLint] Text copied to clipboard")}catch(t){console.warn("[PromptLint] Failed to copy to clipboard:",t);const n=document.createElement("textarea");n.value=e,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}}showCopyFeedback(e){const t=e.textContent;e.textContent="✓ Copied",e.style.background="#10b981",setTimeout(()=>{e.textContent=t,e.style.background=""},2e3)}getApproachColor(e){return{structured:"#3b82f6",conversational:"#10b981",imperative:"#f59e0b",clarifying:"#8b5cf6",detailed:"#ef4444"}[e]||"#6b7280"}capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}initializeDrag(e){let t=!1,n=0,r=0,i=0,a=0;const o=m=>{m.preventDefault(),t=!0,n=m.clientX,r=m.clientY;const u=this.panel.getBoundingClientRect();i=u.left,a=u.top,document.body.style.cursor="grabbing",document.body.style.userSelect="none"},l=m=>{if(!t)return;const u=m.clientX-n,p=m.clientY-r;let h=i+u,f=a+p;const d=this.panel.offsetWidth,E=this.panel.offsetHeight,A=window.innerWidth-d,y=window.innerHeight-E;h=Math.max(0,Math.min(h,A)),f=Math.max(0,Math.min(f,y)),this.panel.style.transition="none",this.panel.style.left=`${h}px`,this.panel.style.top=`${f}px`,this.panel.style.right="auto",this.panel.style.bottom="auto"},c=()=>{t&&(t=!1,document.body.style.cursor="",document.body.style.userSelect="",this.panel.style.transition=`all ${this.options.animationDuration}ms ease`,this.savePosition())};e.addEventListener("mousedown",o),document.addEventListener("mousemove",l),document.addEventListener("mouseup",c)}savePosition(){if(!this.panel)return;const e=this.panel.getBoundingClientRect(),t={left:e.left,top:e.top,timestamp:Date.now()};try{sessionStorage.setItem("promptlint-panel-position",JSON.stringify(t))}catch(n){console.warn("[PromptLint] Failed to save panel position:",n)}}loadPosition(){if(this.panel)try{const e=sessionStorage.getItem("promptlint-panel-position");if(e){const t=JSON.parse(e);Date.now()-t.timestamp<24*60*60*1e3&&(this.panel.style.left=`${t.left}px`,this.panel.style.top=`${t.top}px`,this.panel.style.right="auto",this.panel.style.bottom="auto")}}catch(e){console.warn("[PromptLint] Failed to load panel position:",e)}}toggleRephraseMode(){this.isRephraseMode?(this.hideRephrase(),this.rephraseToggleButton&&(this.rephraseToggleButton.textContent="Rephrase",this.rephraseToggleButton.classList.remove("active"))):this.currentPrompt&&this.rephraseCallbacks.onRephraseRequest&&(this.handleRephraseClick(),this.rephraseToggleButton&&(this.rephraseToggleButton.textContent="Close",this.rephraseToggleButton.classList.add("active")))}formatRephraseText(e){console.log("[PromptLint DEBUG] formatRephraseText input:",e),console.log("[PromptLint DEBUG] formatRephraseText line breaks in input:",(e.match(/\n/g)||[]).length);let t=this.escapeHtml(e);return t=t.replace(/\n\n/g,"<br>"),t=t.replace(/\n/g,"<br>"),t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/^(\*\*Task\*\*:)/gm,'<div class="rephrase-section"><strong>Task:</strong>'),t=t.replace(/^(\*\*Input\*\*:)/gm,'</div><div class="rephrase-section"><strong>Input:</strong>'),t=t.replace(/^(\*\*Output\*\*:)/gm,'</div><div class="rephrase-section"><strong>Output:</strong>'),t=t.replace(/^(\*\*Additional Context\*\*:)/gm,'</div><div class="rephrase-section"><strong>Additional Context:</strong>'),t=t.replace(/^(\*\*Requirements\*\*:)/gm,'</div><div class="rephrase-section"><strong>Requirements:</strong>'),t=t.replace(/^(\*\*What I want to accomplish\*\*:)/gm,'<div class="rephrase-section"><strong>What I want to accomplish:</strong>'),t=t.replace(/^(\*\*What I'm working with\*\*:)/gm,`</div><div class="rephrase-section"><strong>What I'm working with:</strong>`),t=t.replace(/^(\*\*How I want the result\*\*:)/gm,'</div><div class="rephrase-section"><strong>How I want the result:</strong>'),t=t.replace(/^(\*\*Any constraints\*\*:)/gm,'</div><div class="rephrase-section"><strong>Any constraints:</strong>'),t=t.replace(/^(\*\*First step\*\*:)/gm,'<div class="rephrase-section"><strong>First step:</strong>'),t=t.replace(/^(\*\*Second step\*\*:)/gm,'</div><div class="rephrase-section"><strong>Second step:</strong>'),t=t.replace(/^(\*\*Third step\*\*:)/gm,'</div><div class="rephrase-section"><strong>Third step:</strong>'),t=t.replace(/^(\*\*Final step\*\*:)/gm,'</div><div class="rephrase-section"><strong>Final step:</strong>'),t=t.replace(/^(\*\*Requirements\*\*:)/gm,'</div><div class="rephrase-section"><strong>Requirements:</strong>'),t.includes('<div class="rephrase-section">')&&(t+="</div>"),console.log("[PromptLint DEBUG] formatRephraseText output:",t),console.log("[PromptLint DEBUG] formatRephraseText <br> tags in output:",(t.match(/<br>/g)||[]).length),t}hideRephrase(){this.rephraseContainer&&(this.rephraseContainer.style.display="none"),this.panel&&this.panel.classList.remove("promptlint-panel--rephrase-mode"),this.isRephraseMode=!1}showRephraseError(e){if(!this.rephraseContainer)return;this.rephraseContainer.innerHTML=`
      <div class="promptlint-rephrase__error">
        <h4>Rephrase Failed</h4>
        <p>${this.escapeHtml(e)}</p>
        <button class="promptlint-rephrase__close">Close</button>
      </div>
    `,this.rephraseContainer.style.display="block",this.rephraseContainer.querySelector(".promptlint-rephrase__close")?.addEventListener("click",()=>this.hideRephrase())}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}updatePrompt(e){if(this.currentPrompt=e,(!e||e.trim().length===0)&&this.updateScore(0),this.rephraseButton){const t=e.length>10&&this.options.enableRephrase;this.rephraseButton.style.display=t?"block":"none"}}toggleAiAgentDropdown(){this.aiAgentDropdownMenu&&(this.isDropdownOpen=!this.isDropdownOpen,this.isDropdownOpen?(this.aiAgentDropdownMenu.style.display="block",this.aiAgentDropdown?.classList.add("open"),this.positionDropdownOutsidePanel(),setTimeout(()=>{document.addEventListener("click",this.handleClickOutside.bind(this),{once:!0})},0)):this.closeAiAgentDropdown())}positionDropdownOutsidePanel(){if(!this.aiAgentDropdown||!this.aiAgentDropdownMenu||!this.panel)return;const e=this.aiAgentDropdown.getBoundingClientRect(),t=e.left,n=e.bottom+4,r=200,i=window.innerWidth,a=t+r>i?i-r-8:t,o=300,l=window.innerHeight,c=n+o>l?e.top-o-4:n;this.aiAgentDropdownMenu.style.position="fixed",this.aiAgentDropdownMenu.style.left=`${a}px`,this.aiAgentDropdownMenu.style.top=`${c}px`,this.aiAgentDropdownMenu.style.right="auto",this.aiAgentDropdownMenu.style.bottom="auto",this.aiAgentDropdownMenu.style.zIndex="100000",this.aiAgentDropdownMenu.parentElement!==document.body&&document.body.appendChild(this.aiAgentDropdownMenu)}closeAiAgentDropdown(){this.aiAgentDropdownMenu&&(this.isDropdownOpen=!1,this.aiAgentDropdownMenu.style.display="none",this.aiAgentDropdown?.classList.remove("open"),this.aiAgentDropdownMenu.style.position="absolute",this.aiAgentDropdownMenu.style.left="0",this.aiAgentDropdownMenu.style.top="100%",this.aiAgentDropdownMenu.style.right="auto",this.aiAgentDropdownMenu.style.bottom="auto",this.aiAgentDropdownMenu.style.zIndex="100000",this.aiAgentDropdownMenu.parentElement===document.body&&this.aiAgentDropdown&&this.aiAgentDropdown.appendChild(this.aiAgentDropdownMenu))}handleClickOutside(e){this.aiAgentDropdown&&!this.aiAgentDropdown.contains(e.target)&&this.closeAiAgentDropdown()}selectAiAgent(e,t){this.selectedAiAgent=t;const n=this.aiAgentDropdown?.querySelector(".ai-agent-text");n&&(n.textContent=t),this.closeAiAgentDropdown(),console.log(`[PromptLint] AI Agent selected: ${t} (${e})`)}async cleanup(){this.isDropdownOpen&&this.closeAiAgentDropdown(),this.aiAgentDropdownMenu&&this.aiAgentDropdownMenu.parentElement===document.body&&this.aiAgentDropdownMenu.remove(),this.panel&&(this.panel.remove(),this.panel=null);const e=document.getElementById("promptlint-panel-styles");e&&e.remove(),this.scoreElement=null,this.issuesContainer=null,this.aiAgentDropdown=null,this.aiAgentDropdownMenu=null,this.isVisible=!1,console.log("[PromptLint] Floating panel cleaned up")}}class yi{adapter;options;floatingPanel=null;injectionPoint=null;rephraseCallbacks;isInitialized=!1;constructor(e,t={},n={}){this.adapter=e,this.options={panelOptions:t.panelOptions||{},autoPosition:t.autoPosition!==!1,respectSiteStyles:t.respectSiteStyles!==!1},this.rephraseCallbacks=n}async initialize(){if(this.isInitialized){console.log("[PromptLint] UI Injector already initialized");return}try{console.log("[PromptLint] Initializing UI injector...");const e=await this.adapter.findInjectionPoint();console.log("[PromptLint DEBUG] Injection result:",e),e.element?(this.injectionPoint=e.element,console.log("[PromptLint DEBUG] Found injection point element:",this.injectionPoint),console.log("[PromptLint DEBUG] Injection point selector used:",e.selectorUsed),console.log("[PromptLint DEBUG] Injection point tag/id/class:",{tagName:this.injectionPoint?.tagName,id:this.injectionPoint?.id,className:this.injectionPoint?.className})):(console.warn("[PromptLint DEBUG] No UI injection point found, using document.body fallback"),this.injectionPoint=document.body);const t=this.determineOptimalPosition(),n={...this.options.panelOptions,position:t};this.floatingPanel=new Yn(n,this.rephraseCallbacks),await this.floatingPanel.initialize(),this.isInitialized=!0,console.log("[PromptLint] UI injector initialized successfully")}catch(e){throw console.error("[PromptLint] Failed to initialize UI injector:",e),e}}determineOptimalPosition(){if(!this.options.autoPosition)return this.options.panelOptions?.position||"bottom-right";try{const e=this.adapter.findInputElement();if(!e.element)return"bottom-right";const t=e.element.getBoundingClientRect(),n=window.innerWidth,r=window.innerHeight,i=t.right<n*.7,a=t.bottom<r*.7;return i&&a?"bottom-right":i&&!a?"top-right":!i&&a?"bottom-left":"top-left"}catch(e){return console.warn("[PromptLint] Error determining position, using default:",e),"bottom-right"}}async updateResults(e,t){if(!this.floatingPanel){console.warn("[PromptLint] Floating panel not initialized");return}try{this.floatingPanel.updateResults(e,t),console.log("[PromptLint] UI updated with results:",{score:e.score,issueCount:e.issues.length,processingTime:e.metadata?.processingTime})}catch(n){console.error("[PromptLint] Error updating UI with results:",n)}}async showPanel(){this.floatingPanel&&this.floatingPanel.show()}async hidePanel(){this.floatingPanel&&this.floatingPanel.hide()}async repositionPanel(){if(!(!this.floatingPanel||!this.options.autoPosition))try{const e=this.determineOptimalPosition(),t=this.floatingPanel,n={...this.options.panelOptions,position:e};await t.cleanup(),this.floatingPanel=new Yn(n),await this.floatingPanel.initialize(),console.log("[PromptLint] Panel repositioned to:",e)}catch(e){console.error("[PromptLint] Error repositioning panel:",e)}}async handleContentChange(){try{if(console.log("[PromptLint] Handling content change..."),this.injectionPoint&&!document.contains(this.injectionPoint)){console.log("[PromptLint] Injection point removed, finding new one...");const e=await this.adapter.findInjectionPoint();e.element?this.injectionPoint=e.element:this.injectionPoint=document.body}await this.repositionPanel()}catch(e){console.error("[PromptLint] Error handling content change:",e)}}getStatus(){return{isInitialized:this.isInitialized,hasPanelElement:!!this.floatingPanel,hasInjectionPoint:!!this.injectionPoint,panelVisible:this.floatingPanel?this.floatingPanel.isVisible:!1}}async refresh(){try{console.log("[PromptLint] Refreshing UI components..."),this.floatingPanel&&(await this.floatingPanel.cleanup(),this.floatingPanel=null),this.isInitialized=!1,await this.initialize(),console.log("[PromptLint] UI components refreshed successfully")}catch(e){throw console.error("[PromptLint] Error refreshing UI components:",e),e}}async cleanup(){try{this.floatingPanel&&(await this.floatingPanel.cleanup(),this.floatingPanel=null),this.injectionPoint=null,this.isInitialized=!1,console.log("[PromptLint] UI injector cleaned up")}catch(e){console.error("[PromptLint] Error during UI injector cleanup:",e)}}}var _e=(s=>(s.MISSING_TASK_VERB="missing_task_verb",s.MISSING_LANGUAGE="missing_language",s.MISSING_IO_SPECIFICATION="missing_io_specification",s.VAGUE_WORDING="vague_wording",s.UNCLEAR_SCOPE="unclear_scope",s.REDUNDANT_LANGUAGE="redundant_language",s))(_e||{}),v=(s=>(s.INVALID_API_KEY="INVALID_API_KEY",s.RATE_LIMIT_EXCEEDED="RATE_LIMIT_EXCEEDED",s.NETWORK_ERROR="NETWORK_ERROR",s.INVALID_REQUEST="INVALID_REQUEST",s.SERVICE_UNAVAILABLE="SERVICE_UNAVAILABLE",s.QUOTA_EXCEEDED="QUOTA_EXCEEDED",s.TIMEOUT="TIMEOUT",s.UNKNOWN_ERROR="UNKNOWN_ERROR",s))(v||{});class S extends Error{constructor(e,t,n,r=!1){super(t),this.type=e,this.originalError=n,this.retryable=r,this.name="RephraseError"}}const wi=["implement","create","build","develop","write","code","generate","explain","describe","analyze","review","document","debug","fix","solve","resolve","troubleshoot","convert","transform","refactor","optimize","improve","test","validate","verify","check","design","plan","outline","demonstrate","provide"],bi=["make","do","get","have","use","work","help","give","tell","show","find"];class _i{constructor(){this.type=_e.MISSING_TASK_VERB,this.name="Missing Task Verb",this.description="Detects prompts without clear action verbs indicating what should be done"}analyze(e){const t=e.toLowerCase().trim();return wi.some(i=>[new RegExp(`^${i}\\b`),new RegExp(`\\b${i}\\b`),new RegExp(`^(please |can you |could you |i need to |i want to |help me )?${i}\\b`)].some(o=>o.test(t)))?{hasIssue:!1,message:""}:bi.some(i=>new RegExp(`\\b${i}\\b`).test(t))?{hasIssue:!0,message:'Task verb is unclear - specify a precise action like "implement", "debug", or "explain"',suggestion:"Use specific action verbs: implement, create, debug, explain, analyze, etc."}:{hasIssue:!0,message:"No clear task verb found - specify what action should be taken",suggestion:'Start with a clear action verb like "implement", "create", "debug", or "explain"'}}}const Ei=["javascript","js","typescript","ts","python","py","java","c\\+\\+","cpp","c#","csharp","c","go","golang","rust","php","ruby","swift","kotlin","scala","dart","html","css","scss","sass","jsx","tsx","vue","react","angular","bash","shell","powershell","sql","r","matlab","perl","haskell","clojure","lua","assembly","asm","vb","vba","fortran","cobol","ada","erlang","elixir","node","nodejs","deno","bun"],xi=["function","class","method","algorithm","code","script","program","app","application","implementation","library","module","component","service","api","endpoint","quicksort","bubblesort","mergesort","binary search","linked list","tree","graph","database","query","server","client","frontend","backend","fullstack","navbar","navigation","responsive","website","webpage","html","css","dom","unit test","test","testing","spec","mock","stub","system","authentication","auth","login","session","security","debug","fix","error","bug","issue","troubleshoot","do","make","create","build","write","implement"],Ai=["explain","describe","document","what is","how does","why does","show me","tell me","help me understand","clarify","outline","overview"];class vi{constructor(){this.type=_e.MISSING_LANGUAGE,this.name="Missing Programming Language",this.description="Detects code generation requests without specified programming language"}analyze(e){const t=e.toLowerCase().trim();return Ai.some(a=>t.includes(a.toLowerCase()))?{hasIssue:!1,message:""}:xi.some(a=>t.includes(a.toLowerCase()))?Ei.some(a=>[new RegExp(`\\b${a}\\b`,"i"),new RegExp(`\\bin ${a}\\b`,"i"),new RegExp(`\\busing ${a}\\b`,"i"),new RegExp(`\\bwith ${a}\\b`,"i"),new RegExp(`\\b${a} code\\b`,"i"),new RegExp(`\\b${a} function\\b`,"i"),new RegExp(`\\b${a} script\\b`,"i")].some(l=>l.test(t)))?{hasIssue:!1,message:""}:{hasIssue:!0,message:"Programming language not specified for code generation request",suggestion:"Specify the programming language (e.g., Python, JavaScript, Java, C++, etc.)"}:{hasIssue:!1,message:""}}}const Ci=["input","parameter","argument","data","array","list","string","number","integer","object","json","csv","file","text","value","variable","field","property","receives","takes","accepts","given","provided","passed"],Ii=["output","return","result","response","produce","generate","create","build","sorted","filtered","transformed","formatted","calculated","processed","returns","outputs","produces","yields","gives","provides"],Ri=["function","method","algorithm","sort","search","filter","transform","convert","parse","process","calculate","compute","analyze","validate","format","returns","endpoint","api","service","component","connection","authentication","do","make","create","build","write","implement"];class Si{constructor(){this.type=_e.MISSING_IO_SPECIFICATION,this.name="Missing I/O Specification",this.description="Detects prompts without clear input/output format specifications"}analyze(e){const t=e.toLowerCase().trim();if(!Ri.some(m=>t.includes(m.toLowerCase())))return{hasIssue:!1,message:""};const r=Ci.some(m=>[new RegExp(`\\b${m}\\s*:`),new RegExp(`\\b${m}\\s*(is|are|should be)`),new RegExp(`\\btakes?\\s+\\w*\\s*${m}`),new RegExp(`\\binput\\s+${m}`),new RegExp(`\\b${m}\\s+input`),new RegExp(`\\breceives?\\s+\\w*\\s*${m}`),new RegExp(`\\baccepts?\\s+\\w*\\s*${m}`)].some(p=>p.test(t))),i=Ii.some(m=>[new RegExp(`\\b${m}\\b`),new RegExp(`\\b${m}\\s*:`),new RegExp(`\\b${m}\\s*(is|are|should be)`),new RegExp(`\\bshould\\s+${m}`)].some(p=>p.test(t))),a=!r,o=!i;if(!a&&!o)return{hasIssue:!1,message:""};let l="",c="";return a&&o?(l="Input and output formats not specified",c='Specify both input format (e.g., "array of integers") and expected output format'):a?(l="Input format not specified",c='Specify the input format (e.g., "array of integers", "string", "JSON object")'):(l="Output format not specified",c='Specify the expected output format (e.g., "sorted array", "boolean", "formatted string")'),{hasIssue:!0,message:l,suggestion:c}}}const Pi=[{term:"just",replacement:"specifically"},{term:"maybe",replacement:"optionally"},{term:"somehow",replacement:"using a specific method"},{term:"something like",replacement:"similar to"},{term:"kind of",replacement:"type of"},{term:"sort of",replacement:"type of"},{term:"pretty much",replacement:"essentially"},{term:"basically",replacement:"specifically"},{term:"probably",replacement:"likely"},{term:"might",replacement:"could"},{term:"stuff",replacement:"items"},{term:"things",replacement:"elements"},{term:"whatever",replacement:"any appropriate"},{term:"some kind of",replacement:"a specific type of"},{term:"or something",replacement:"or similar"},{term:"and stuff",replacement:"and related items"}],Ti=["perhaps","possibly","presumably","supposedly","apparently","seemingly","roughly","approximately","about","around","kinda","sorta"];class Li{constructor(){this.type=_e.VAGUE_WORDING,this.name="Vague Wording",this.description="Detects vague terms that make prompts unclear and ambiguous"}analyze(e){const t=[],n=[];for(const{term:o}of Pi){const l=new RegExp(`\\b${o.replace(/\s+/g,"\\s+")}\\b`,"gi");let c;for(;(c=l.exec(e))!==null;)t.push(o),n.push({start:c.index,end:c.index+c[0].length})}for(const o of Ti){const l=new RegExp(`\\b${o}\\b`,"gi");let c;for(;(c=l.exec(e))!==null;)t.push(o),n.push({start:c.index,end:c.index+c[0].length})}if(t.length===0)return{hasIssue:!1,message:""};const a={hasIssue:!0,message:`Vague terms detected: ${[...new Set(t)].map(o=>`"${o}"`).join(", ")}`,suggestion:"Replace vague terms with specific, precise language"};return n.length>0&&(a.position=n[0]),a}}const Di=["everything","anything","all","any","complete","full","entire","whole","comprehensive","total","overall","general","generic","universal"],Oi=["system","solution","program","app","application","tool","utility","framework","platform","service","component","module","library","bug","issue","problem","error","thing","stuff","it","something","anything"],ki=["best","good","better","optimal","efficient","fast","simple","easy","nice","clean","proper","correct","right","appropriate","suitable"],Ni=["this","that","these","those","the above","the following"],Mi=["only","just","specifically","exactly","precisely","limited to","excluding","without","except","focus on","concentrate on","single","one","basic","minimal","simple version"];class $i{constructor(){this.type=_e.UNCLEAR_SCOPE,this.name="Unclear Scope",this.description="Detects prompts with undefined or overly broad task boundaries"}analyze(e){const t=e.toLowerCase().trim(),n=[];Di.some(h=>[new RegExp(`\\b${h}\\b`),new RegExp(`\\bthe ${h}\\b`),new RegExp(`\\ban? ${h}\\b`)].some(d=>d.test(t)))&&n.push("overly broad scope");const i=Oi.some(h=>new RegExp(`\\b${h}\\b`).test(t)),a=Mi.some(h=>new RegExp(`\\b${h}\\b`).test(t)),o=["merge sort","quicksort","binary search","linked list","binary tree","hash table","stack","queue","graph","fibonacci","factorial"].some(h=>t.includes(h.toLowerCase()));i&&!a&&!o&&n.push("vague task descriptor without scope clarification");const l=ki.some(h=>[new RegExp(`\\bmake it ${h}\\b`),new RegExp(`\\bshould be ${h}\\b`),new RegExp(`\\bneeds to be ${h}\\b`),new RegExp(`\\bhas to be ${h}\\b`)].some(d=>d.test(t))),c=Ni.some(h=>h==="that"?[/\bdebug that\b/,/\bfix that\b/,/\boptimize that\b/,/\bimprove that\b/,/\bupdate that\b/,/\bthat\s+(bug|error|issue|problem)\b/].some(d=>d.test(t)):new RegExp(`\\b${h}\\b`).test(t));l&&n.push("unclear quality requirements"),c&&n.push("vague references");const m=t.split(/\s+/).filter(h=>h.length>0),u=["quicksort","bubblesort","mergesort","binary search","factorial","fibonacci"].some(h=>t.includes(h.toLowerCase()));return m.length<=2&&!a&&!u&&n.push("insufficient detail for scope definition"),n.length===0?{hasIssue:!1,message:""}:{hasIssue:!0,message:`Task scope unclear: ${n.join(", ")}`,suggestion:"Define specific boundaries for what should be included/excluded in the task"}}}const Fi=["really","very","quite","rather","pretty","fairly","somewhat","actually","basically","essentially","literally","definitely","absolutely","totally","completely","entirely","obviously","clearly","certainly","surely"],Ui=[{phrase:"in order to",replacement:"to"},{phrase:"due to the fact that",replacement:"because"},{phrase:"at this point in time",replacement:"now"},{phrase:"for the purpose of",replacement:"to"},{phrase:"with regard to",replacement:"regarding"},{phrase:"in the event that",replacement:"if"},{phrase:"it is important to note that",replacement:""},{phrase:"please note that",replacement:""},{phrase:"i would like to",replacement:"i want to"},{phrase:"could you please",replacement:"please"},{phrase:"would you mind",replacement:"please"},{phrase:"if you could",replacement:"please"}],Bi=[{expression:"make use of",replacement:"use"},{expression:"give consideration to",replacement:"consider"},{expression:"put emphasis on",replacement:"emphasize"},{expression:"take into account",replacement:"consider"},{expression:"come to the conclusion",replacement:"conclude"},{expression:"make a decision",replacement:"decide"},{expression:"carry out",replacement:"do"},{expression:"bring to completion",replacement:"complete"}];class zi{constructor(){this.type=_e.REDUNDANT_LANGUAGE,this.name="Redundant Language",this.description="Detects unnecessary repetition, filler words, and verbose expressions"}analyze(e){const t=e.toLowerCase().trim(),n=[];let r=0;const i=Fi.filter(f=>{const d=new RegExp(`\\b${f}\\b`,"g"),E=t.match(d);return E&&E.length>0});i.length>0&&(n.push(`filler words: ${i.slice(0,3).join(", ")}`),r+=i.length);const a=Ui.filter(({phrase:f})=>t.includes(f.toLowerCase()));a.length>0&&(n.push("redundant phrases"),r+=a.length);const o=Bi.filter(({expression:f})=>t.includes(f.toLowerCase()));o.length>0&&(n.push("verbose expressions"),r+=o.length);const l=t.split(/\s+/).filter(f=>f.length>3),c={};l.forEach(f=>{c[f]=(c[f]||0)+1});const m=Object.entries(c).filter(([f,d])=>d>2).map(([f])=>f);m.length>0&&(n.push("repeated words"),r+=m.length);const p=["please","thank you","thanks","appreciate","grateful"].reduce((f,d)=>{const E=t.match(new RegExp(`\\b${d}\\b`,"g"));return f+(E?E.length:0)},0);return p>2&&(n.push("excessive courtesy language"),r+=p-2),n.length===0?{hasIssue:!1,message:""}:r<2&&a.length===0?{hasIssue:!1,message:""}:{hasIssue:!0,message:`Redundant language detected: ${n.slice(0,2).join(", ")}`,suggestion:"Remove unnecessary words and simplify expressions for clarity"}}}function ji(){return[new _i,new vi,new Si,new Li,new $i,new zi]}function Gi(s,e,t){let n=e.baseScore;for(const r of s)switch(r.severity){case"high":n-=e.highSeverityPenalty;break;case"medium":n-=e.mediumSeverityPenalty;break;case"low":n-=e.lowSeverityPenalty;break}return t&&(n+=Wi(t,e)),Math.max(0,Math.min(100,n))}function Wi(s,e){const t=s.toLowerCase().trim();let n=0;if(e.taskVerbQualityBonus){const r=["implement","develop","architect","construct","engineer"],i=["build","create","generate","design","code","program"];r.some(a=>t.includes(a))?n+=e.taskVerbQualityBonus:i.some(a=>t.includes(a))&&(n+=Math.round(e.taskVerbQualityBonus*.6))}if(e.specificityBonus){const i=["algorithm","function","method","class","module","component"].filter(a=>t.includes(a));i.length>0&&(n+=e.specificityBonus,i.length>1&&(n+=Math.round(e.specificityBonus*.5*(i.length-1))))}if(e.clarityBonus){const i=[{pattern:" with ",desc:"with clause"},{pattern:" that ",desc:"that clause"},{pattern:" for ",desc:"for clause"},{pattern:"input",desc:"input specification"},{pattern:"output",desc:"output specification"},{pattern:"return",desc:"return specification"}].filter(a=>t.includes(a.pattern));n+=Math.round(e.clarityBonus*i.length*.3),t.length>30&&t.split(" ").length>=6&&(n+=Math.round(e.clarityBonus*.5))}return n}const Hi={rules:[{type:"missing_task_verb",enabled:!0,severity:"medium"},{type:"missing_language",enabled:!0,severity:"high"},{type:"missing_io_specification",enabled:!0,severity:"medium"},{type:"vague_wording",enabled:!0,severity:"medium"},{type:"unclear_scope",enabled:!0,severity:"medium"},{type:"redundant_language",enabled:!0,severity:"low"}],scoring:{baseScore:100,highSeverityPenalty:43,mediumSeverityPenalty:23,lowSeverityPenalty:12,taskVerbQualityBonus:5,specificityBonus:3,clarityBonus:2},performance:{maxProcessingTime:50}};class qi{constructor(e={}){this.config={...Hi,...e},this.rules=ji()}analyze(e){const t=[],n=[];for(const a of this.rules){const o=this.config.rules.find(l=>l.type===a.type);if(!(!o||!o.enabled))try{const l=a.analyze(e);if(l.hasIssue){const c={type:a.type,severity:o.severity,message:l.message};l.position&&(c.position=l.position),t.push(c)}l.suggestion&&n.push(l.suggestion)}catch(l){console.warn(`Rule ${a.type} failed:`,l)}}const i={score:Gi(t,this.config.scoring,e),issues:t};return n.length>0&&(i.suggestions=n),i}getConfig(){return{...this.config}}updateConfig(e){this.config={...this.config,...e}}}function Qn(s){const e=performance.now();if(!s||typeof s!="string")return{score:0,issues:[],suggestions:["Please provide a valid prompt text"],metadata:{processingTime:performance.now()-e,inputLength:0,timestamp:new Date}};const t=s.trim();if(t.length===0)return{score:0,issues:[],suggestions:["Please provide a non-empty prompt"],metadata:{processingTime:performance.now()-e,inputLength:0,timestamp:new Date}};const r=new qi().analyze(t);return r.metadata={processingTime:performance.now()-e,inputLength:t.length,timestamp:new Date},r}var Z=(s=>(s.SITE_DETECTION_FAILED="SITE_DETECTION_FAILED",s.ADAPTER_NOT_FOUND="ADAPTER_NOT_FOUND",s.ADAPTER_INITIALIZATION_FAILED="ADAPTER_INITIALIZATION_FAILED",s.DOM_INJECTION_FAILED="DOM_INJECTION_FAILED",s.INPUT_ELEMENT_NOT_FOUND="INPUT_ELEMENT_NOT_FOUND",s.UI_INJECTION_POINT_NOT_FOUND="UI_INJECTION_POINT_NOT_FOUND",s.LINT_ANALYSIS_FAILED="LINT_ANALYSIS_FAILED",s.PANEL_CREATION_FAILED="PANEL_CREATION_FAILED",s.PERMISSION_DENIED="PERMISSION_DENIED",s.NETWORK_ERROR="NETWORK_ERROR",s.UNKNOWN_ERROR="UNKNOWN_ERROR",s))(Z||{});class Vi{options;errorLog=[];retryAttempts=new Map;constructor(e={}){this.options={enableLogging:e.enableLogging!==!1,enableUserNotifications:e.enableUserNotifications!==!1,maxRetries:e.maxRetries||3,retryDelayMs:e.retryDelayMs||1e3}}handleError(e,t,n){const r=this.createPromptLintError(e,t,n);return this.options.enableLogging&&this.logError(r),this.errorLog.push(r),this.errorLog.length>50&&this.errorLog.shift(),this.reportToBackground(r),r}createPromptLintError(e,t,n){const r=e instanceof Error?e:new Error(e),i=t||this.categorizeError(r);return{type:i,message:r.message,originalError:r,context:n||{},timestamp:Date.now(),recoverable:this.isRecoverable(i),userMessage:this.getUserMessage(i),suggestion:this.getSuggestion(i)}}categorizeError(e){const t=e.message.toLowerCase();return t.includes("site")&&t.includes("detect")?"SITE_DETECTION_FAILED":t.includes("adapter")&&t.includes("not found")?"ADAPTER_NOT_FOUND":t.includes("input")&&t.includes("element")?"INPUT_ELEMENT_NOT_FOUND":t.includes("injection")||t.includes("dom")?"DOM_INJECTION_FAILED":t.includes("permission")?"PERMISSION_DENIED":t.includes("network")||t.includes("fetch")?"NETWORK_ERROR":t.includes("analyze")||t.includes("lint")?"LINT_ANALYSIS_FAILED":"UNKNOWN_ERROR"}isRecoverable(e){return["INPUT_ELEMENT_NOT_FOUND","UI_INJECTION_POINT_NOT_FOUND","DOM_INJECTION_FAILED","LINT_ANALYSIS_FAILED","NETWORK_ERROR"].includes(e)}getUserMessage(e){return{SITE_DETECTION_FAILED:"Unable to detect supported AI website",ADAPTER_NOT_FOUND:"Website adapter not available",ADAPTER_INITIALIZATION_FAILED:"Failed to initialize website integration",DOM_INJECTION_FAILED:"Unable to inject PromptLint interface",INPUT_ELEMENT_NOT_FOUND:"Cannot find text input field",UI_INJECTION_POINT_NOT_FOUND:"Cannot find suitable location for PromptLint panel",LINT_ANALYSIS_FAILED:"Prompt analysis temporarily unavailable",PANEL_CREATION_FAILED:"Unable to create PromptLint panel",PERMISSION_DENIED:"Extension permissions insufficient",NETWORK_ERROR:"Network connection issue",UNKNOWN_ERROR:"An unexpected error occurred"}[e]||"Unknown error occurred"}getSuggestion(e){return{SITE_DETECTION_FAILED:"Make sure you're on ChatGPT or Claude website",ADAPTER_NOT_FOUND:"Try refreshing the page or check if site is supported",INPUT_ELEMENT_NOT_FOUND:"Navigate to the chat interface and try again",PERMISSION_DENIED:"Check extension permissions in Chrome settings",NETWORK_ERROR:"Check your internet connection and try again",UNKNOWN_ERROR:"Try refreshing the page or restarting the browser"}[e]}async attemptRecovery(e,t,n){const r=`${t}_${JSON.stringify(n||{})}`,i=this.retryAttempts.get(r)||0;if(i>=this.options.maxRetries)return console.warn(`[PromptLint] Max retries exceeded for ${t}`),null;try{const a=await e();return this.retryAttempts.delete(r),a}catch(a){const o=i+1;if(this.retryAttempts.set(r,o),this.handleError(a,t,{...n,attempt:o,maxRetries:this.options.maxRetries}).recoverable&&o<this.options.maxRetries){console.log(`[PromptLint] Retrying ${t} (attempt ${o}/${this.options.maxRetries})`);const c=this.options.retryDelayMs*Math.pow(2,o-1);return await this.sleep(c),this.attemptRecovery(e,t,n)}return null}}createErrorLintResult(e){return{score:0,issues:[{type:"missing_language",severity:"high",message:e.userMessage}],metadata:{processingTime:0,inputLength:0,timestamp:new Date}}}logError(e){const t=`[PromptLint Error] ${e.type}: ${e.message}`,n={error:e.originalError,context:e.context,recoverable:e.recoverable,timestamp:new Date(e.timestamp).toISOString()};e.recoverable?console.warn(t,n):console.error(t,n)}reportToBackground(e){try{chrome.runtime.sendMessage({type:"ERROR_REPORT",error:{type:e.type,message:e.message,timestamp:e.timestamp,recoverable:e.recoverable,context:e.context}}).catch(()=>{})}catch{}}getErrorStats(){const e={};let t=0;return this.errorLog.forEach(n=>{e[n.type]=(e[n.type]||0)+1,n.recoverable&&t++}),{totalErrors:this.errorLog.length,recoverableErrors:t,errorsByType:e,recentErrors:this.errorLog.slice(-10)}}clearErrorLog(){this.errorLog=[],this.retryAttempts.clear()}sleep(e){return new Promise(t=>setTimeout(t,e))}}const K=new Vi({enableLogging:!0,enableUserNotifications:!0,maxRetries:3,retryDelayMs:1e3});class Ki{adapter;uiInjector;options;currentInputElement=null;debounceTimer=null;lastAnalyzedText="";isMonitoring=!1;constructor(e,t,n={}){this.adapter=e,this.uiInjector=t,this.options={debounceMs:n.debounceMs||300,minLength:n.minLength||3,maxLength:n.maxLength||5e3}}async initialize(){try{console.log("[PromptLint] Initializing input monitor...");const e=await this.adapter.findInputElement();if(!e.element){console.warn("[PromptLint] No input element found");return}this.currentInputElement=e.element,console.log("[PromptLint] Found input element:",e.selectorUsed),this.startMonitoring(),console.log("[PromptLint] Input monitor initialized successfully")}catch(e){throw console.error("[PromptLint] Failed to initialize input monitor:",e),e}}startMonitoring(){!this.currentInputElement||this.isMonitoring||(this.isMonitoring=!0,this.currentInputElement.tagName.toLowerCase()==="textarea"||this.currentInputElement.tagName.toLowerCase()==="input"?(this.currentInputElement.addEventListener("input",this.handleInputChange.bind(this)),this.currentInputElement.addEventListener("paste",this.handleInputChange.bind(this))):this.currentInputElement.getAttribute("contenteditable")==="true"&&(this.currentInputElement.addEventListener("input",this.handleInputChange.bind(this)),this.currentInputElement.addEventListener("paste",this.handleInputChange.bind(this)),new MutationObserver(()=>{this.handleInputChange()}).observe(this.currentInputElement,{childList:!0,subtree:!0,characterData:!0})),console.log("[PromptLint] Started monitoring input changes"))}handleInputChange(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(()=>{this.processInputChange()},this.options.debounceMs)}async processInputChange(){try{if(!this.currentInputElement)return;const e=this.extractTextContent();if(e===this.lastAnalyzedText||e.length>this.options.maxLength)return;if(this.lastAnalyzedText=e,e.length===0){console.log("[PromptLint] Input cleared, resetting score to 0"),await this.uiInjector.updateResults({score:0,issues:[],metadata:{processingTime:0,inputLength:0,timestamp:new Date}},"");return}if(e.length<this.options.minLength)return;console.log("[PromptLint] Analyzing input:",e.substring(0,50)+"...");const t=await K.attemptRecovery(async()=>{const n=performance.now(),r=Qn(e),i=performance.now()-n;return console.log(`[PromptLint] Analysis completed in ${i.toFixed(2)}ms:`,{score:r.score,issues:r.issues.length}),r},Z.LINT_ANALYSIS_FAILED,{textLength:e.length,inputType:this.currentInputElement.tagName.toLowerCase()});if(t)await this.uiInjector.updateResults(t,e);else{const n=K.handleError("Lint analysis failed after multiple attempts",Z.LINT_ANALYSIS_FAILED,{textLength:e.length}),r=K.createErrorLintResult(n);await this.uiInjector.updateResults(r,e)}}catch(e){const t=K.handleError(e,Z.LINT_ANALYSIS_FAILED,{phase:"input_processing",textLength:this.lastAnalyzedText.length}),n=K.createErrorLintResult(t);await this.uiInjector.updateResults(n,this.lastAnalyzedText)}}extractTextContent(){return this.currentInputElement?this.currentInputElement.tagName.toLowerCase()==="textarea"||this.currentInputElement.tagName.toLowerCase()==="input"?this.currentInputElement.value.trim():this.currentInputElement.getAttribute("contenteditable")==="true"&&this.currentInputElement.textContent?.trim()||"":""}async refreshInputElement(){try{console.log("[PromptLint] Refreshing input element..."),this.stopMonitoring();const e=await this.adapter.findInputElement();return e.element?(this.currentInputElement=e.element,this.lastAnalyzedText="",this.startMonitoring(),console.log("[PromptLint] Input element refreshed successfully"),!0):(console.warn("[PromptLint] No input element found during refresh"),!1)}catch(e){return console.error("[PromptLint] Failed to refresh input element:",e),!1}}stopMonitoring(){if(this.isMonitoring){if(this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.currentInputElement){const e=this.currentInputElement.cloneNode(!0);this.currentInputElement.parentNode?.replaceChild(e,this.currentInputElement)}this.isMonitoring=!1,console.log("[PromptLint] Stopped monitoring input changes")}}async analyzeNow(){try{const e=this.extractTextContent();if(e.length<this.options.minLength)return null;const t=Qn(e);return await this.uiInjector.updateResults(t,e),t}catch(e){return console.error("[PromptLint] Error in immediate analysis:",e),null}}getStatus(){return{isMonitoring:this.isMonitoring,hasInputElement:!!this.currentInputElement,lastAnalyzedText:this.lastAnalyzedText,debounceMs:this.options.debounceMs}}async cleanup(){try{this.stopMonitoring(),this.currentInputElement=null,this.lastAnalyzedText="",console.log("[PromptLint] Input monitor cleaned up")}catch(e){console.error("[PromptLint] Error during input monitor cleanup:",e)}}}const Xt="RFC3986",Yt={RFC1738:s=>String(s).replace(/%20/g,"+"),RFC3986:s=>String(s)},Ji="RFC1738",Xi=Array.isArray,te=(()=>{const s=[];for(let e=0;e<256;++e)s.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return s})(),$t=1024,Yi=(s,e,t,n,r)=>{if(s.length===0)return s;let i=s;if(typeof s=="symbol"?i=Symbol.prototype.toString.call(s):typeof s!="string"&&(i=String(s)),t==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<i.length;o+=$t){const l=i.length>=$t?i.slice(o,o+$t):i,c=[];for(let m=0;m<l.length;++m){let u=l.charCodeAt(m);if(u===45||u===46||u===95||u===126||u>=48&&u<=57||u>=65&&u<=90||u>=97&&u<=122||r===Ji&&(u===40||u===41)){c[c.length]=l.charAt(m);continue}if(u<128){c[c.length]=te[u];continue}if(u<2048){c[c.length]=te[192|u>>6]+te[128|u&63];continue}if(u<55296||u>=57344){c[c.length]=te[224|u>>12]+te[128|u>>6&63]+te[128|u&63];continue}m+=1,u=65536+((u&1023)<<10|l.charCodeAt(m)&1023),c[c.length]=te[240|u>>18]+te[128|u>>12&63]+te[128|u>>6&63]+te[128|u&63]}a+=c.join("")}return a};function Qi(s){return!s||typeof s!="object"?!1:!!(s.constructor&&s.constructor.isBuffer&&s.constructor.isBuffer(s))}function Zn(s,e){if(Xi(s)){const t=[];for(let n=0;n<s.length;n+=1)t.push(e(s[n]));return t}return e(s)}const Zi=Object.prototype.hasOwnProperty,Ps={brackets(s){return String(s)+"[]"},comma:"comma",indices(s,e){return String(s)+"["+e+"]"},repeat(s){return String(s)}},ne=Array.isArray,ea=Array.prototype.push,Ts=function(s,e){ea.apply(s,ne(e)?e:[e])},ta=Date.prototype.toISOString,D={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:Yi,encodeValuesOnly:!1,format:Xt,formatter:Yt[Xt],indices:!1,serializeDate(s){return ta.call(s)},skipNulls:!1,strictNullHandling:!1};function na(s){return typeof s=="string"||typeof s=="number"||typeof s=="boolean"||typeof s=="symbol"||typeof s=="bigint"}const Ft={};function Ls(s,e,t,n,r,i,a,o,l,c,m,u,p,h,f,d,E,A){let y=s,M=A,R=0,$=!1;for(;(M=M.get(Ft))!==void 0&&!$;){const P=M.get(s);if(R+=1,typeof P<"u"){if(P===R)throw new RangeError("Cyclic object value");$=!0}typeof M.get(Ft)>"u"&&(R=0)}if(typeof c=="function"?y=c(e,y):y instanceof Date?y=p?.(y):t==="comma"&&ne(y)&&(y=Zn(y,function(P){return P instanceof Date?p?.(P):P})),y===null){if(i)return l&&!d?l(e,D.encoder,E,"key",h):e;y=""}if(na(y)||Qi(y)){if(l){const P=d?e:l(e,D.encoder,E,"key",h);return[f?.(P)+"="+f?.(l(y,D.encoder,E,"value",h))]}return[f?.(e)+"="+f?.(String(y))]}const z=[];if(typeof y>"u")return z;let j;if(t==="comma"&&ne(y))d&&l&&(y=Zn(y,l)),j=[{value:y.length>0?y.join(",")||null:void 0}];else if(ne(c))j=c;else{const P=Object.keys(y);j=m?P.sort(m):P}const F=o?String(e).replace(/\./g,"%2E"):String(e),k=n&&ne(y)&&y.length===1?F+"[]":F;if(r&&ne(y)&&y.length===0)return k+"[]";for(let P=0;P<j.length;++P){const T=j[P],Vn=typeof T=="object"&&typeof T.value<"u"?T.value:y[T];if(a&&Vn===null)continue;const Nt=u&&o?T.replace(/\./g,"%2E"):T,Zr=ne(y)?typeof t=="function"?t(k,Nt):k:k+(u?"."+Nt:"["+Nt+"]");A.set(s,R);const Kn=new WeakMap;Kn.set(Ft,A),Ts(z,Ls(Vn,Zr,t,n,r,i,a,o,t==="comma"&&d&&ne(y)?null:l,c,m,u,p,h,f,d,E,Kn))}return z}function sa(s=D){if(typeof s.allowEmptyArrays<"u"&&typeof s.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof s.encodeDotInKeys<"u"&&typeof s.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(s.encoder!==null&&typeof s.encoder<"u"&&typeof s.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=s.charset||D.charset;if(typeof s.charset<"u"&&s.charset!=="utf-8"&&s.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=Xt;if(typeof s.format<"u"){if(!Zi.call(Yt,s.format))throw new TypeError("Unknown format option provided.");t=s.format}const n=Yt[t];let r=D.filter;(typeof s.filter=="function"||ne(s.filter))&&(r=s.filter);let i;if(s.arrayFormat&&s.arrayFormat in Ps?i=s.arrayFormat:"indices"in s?i=s.indices?"indices":"repeat":i=D.arrayFormat,"commaRoundTrip"in s&&typeof s.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=typeof s.allowDots>"u"?s.encodeDotInKeys?!0:D.allowDots:!!s.allowDots;return{addQueryPrefix:typeof s.addQueryPrefix=="boolean"?s.addQueryPrefix:D.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof s.allowEmptyArrays=="boolean"?!!s.allowEmptyArrays:D.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof s.charsetSentinel=="boolean"?s.charsetSentinel:D.charsetSentinel,commaRoundTrip:!!s.commaRoundTrip,delimiter:typeof s.delimiter>"u"?D.delimiter:s.delimiter,encode:typeof s.encode=="boolean"?s.encode:D.encode,encodeDotInKeys:typeof s.encodeDotInKeys=="boolean"?s.encodeDotInKeys:D.encodeDotInKeys,encoder:typeof s.encoder=="function"?s.encoder:D.encoder,encodeValuesOnly:typeof s.encodeValuesOnly=="boolean"?s.encodeValuesOnly:D.encodeValuesOnly,filter:r,format:t,formatter:n,serializeDate:typeof s.serializeDate=="function"?s.serializeDate:D.serializeDate,skipNulls:typeof s.skipNulls=="boolean"?s.skipNulls:D.skipNulls,sort:typeof s.sort=="function"?s.sort:null,strictNullHandling:typeof s.strictNullHandling=="boolean"?s.strictNullHandling:D.strictNullHandling}}function ra(s,e={}){let t=s;const n=sa(e);let r,i;typeof n.filter=="function"?(i=n.filter,t=i("",t)):ne(n.filter)&&(i=n.filter,r=i);const a=[];if(typeof t!="object"||t===null)return"";const o=Ps[n.arrayFormat],l=o==="comma"&&n.commaRoundTrip;r||(r=Object.keys(t)),n.sort&&r.sort(n.sort);const c=new WeakMap;for(let p=0;p<r.length;++p){const h=r[p];n.skipNulls&&t[h]===null||Ts(a,Ls(t[h],h,o,l,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,c))}const m=a.join(n.delimiter);let u=n.addQueryPrefix===!0?"?":"";return n.charsetSentinel&&(n.charset==="iso-8859-1"?u+="utf8=%26%2310003%3B&":u+="utf8=%E2%9C%93&"),m.length>0?u+m:""}const Ce="4.104.0";let es=!1,Ue,Ds,Os,Qt,ks,Ns,Ms,$s,Fs;function ia(s,e={auto:!1}){if(es)throw new Error(`you must \`import 'openai/shims/${s.kind}'\` before importing anything else from openai`);if(Ue)throw new Error(`can't \`import 'openai/shims/${s.kind}'\` after \`import 'openai/shims/${Ue}'\``);es=e.auto,Ue=s.kind,Ds=s.fetch,Os=s.FormData,Qt=s.File,ks=s.ReadableStream,Ns=s.getMultipartRequestOptions,Ms=s.getDefaultAgent,$s=s.fileFromPath,Fs=s.isFsReadStream}class aa{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function oa({manuallyImported:s}={}){const e=s?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,n,r,i;try{t=fetch,n=Request,r=Response,i=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:r,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new aa(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:a=>!1}}const Us=()=>{Ue||ia(oa(),{auto:!0})};Us();class w extends Error{}class B extends w{constructor(e,t,n,r){super(`${B.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.request_id=r?.["x-request-id"],this.error=t;const i=t;this.code=i?.code,this.param=i?.param,this.type=i?.type}static makeMessage(e,t,n){const r=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e||!r)return new Et({message:n,cause:en(t)});const i=t?.error;return e===400?new Bs(e,i,n,r):e===401?new zs(e,i,n,r):e===403?new js(e,i,n,r):e===404?new Gs(e,i,n,r):e===409?new Ws(e,i,n,r):e===422?new Hs(e,i,n,r):e===429?new qs(e,i,n,r):e>=500?new Vs(e,i,n,r):new B(e,i,n,r)}}class X extends B{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Et extends B{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class un extends Et{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Bs extends B{}class zs extends B{}class js extends B{}class Gs extends B{}class Ws extends B{}class Hs extends B{}class qs extends B{}class Vs extends B{}class Ks extends w{constructor(){super("Could not parse response content as the length limit was reached")}}class Js extends w{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var Ze=function(s,e,t,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(s,t):r?r.value=t:e.set(s,t),t},fe=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},q;class xt{constructor(){q.set(this,void 0),this.buffer=new Uint8Array,Ze(this,q,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let n=new Uint8Array(this.buffer.length+t.length);n.set(this.buffer),n.set(t,this.buffer.length),this.buffer=n;const r=[];let i;for(;(i=la(this.buffer,fe(this,q,"f")))!=null;){if(i.carriage&&fe(this,q,"f")==null){Ze(this,q,i.index,"f");continue}if(fe(this,q,"f")!=null&&(i.index!==fe(this,q,"f")+1||i.carriage)){r.push(this.decodeText(this.buffer.slice(0,fe(this,q,"f")-1))),this.buffer=this.buffer.slice(fe(this,q,"f")),Ze(this,q,null,"f");continue}const a=fe(this,q,"f")!==null?i.preceding-1:i.preceding,o=this.decodeText(this.buffer.slice(0,a));r.push(o),this.buffer=this.buffer.slice(i.index),Ze(this,q,null,"f")}return r}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new w(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new w(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new w("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}q=new WeakMap;xt.NEWLINE_CHARS=new Set([`
`,"\r"]);xt.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function la(s,e){for(let r=e??0;r<s.length;r++){if(s[r]===10)return{preceding:r,index:r+1,carriage:!1};if(s[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function ca(s){for(let n=0;n<s.length-1;n++){if(s[n]===10&&s[n+1]===10||s[n]===13&&s[n+1]===13)return n+2;if(s[n]===13&&s[n+1]===10&&n+3<s.length&&s[n+2]===13&&s[n+3]===10)return n+4}return-1}function Xs(s){if(s[Symbol.asyncIterator])return s;const e=s.getReader();return{async next(){try{const t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class re{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*r(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let i=!1;try{for await(const a of ua(e,t))if(!i){if(a.data.startsWith("[DONE]")){i=!0;continue}if(a.event===null||a.event.startsWith("response.")||a.event.startsWith("transcript.")){let o;try{o=JSON.parse(a.data)}catch(l){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),l}if(o&&o.error)throw new B(void 0,o.error,void 0,rr(e.headers));yield o}else{let o;try{o=JSON.parse(a.data)}catch(l){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),l}if(a.event=="error")throw new B(void 0,o.error,o.message,void 0);yield{event:a.event,data:o}}}i=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{i||t.abort()}}return new re(r,t)}static fromReadableStream(e,t){let n=!1;async function*r(){const a=new xt,o=Xs(e);for await(const l of o)for(const c of a.decode(l))yield c;for(const l of a.flush())yield l}async function*i(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let a=!1;try{for await(const o of r())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new re(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=i=>({next:()=>{if(i.length===0){const a=n.next();e.push(a),t.push(a)}return i.shift()}});return[new re(()=>r(e),this.controller),new re(()=>r(t),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new ks({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{const{value:i,done:a}=await t.next();if(a)return r.close();const o=n.encode(JSON.stringify(i)+`
`);r.enqueue(o)}catch(i){r.error(i)}},async cancel(){await t.return?.()}})}}async function*ua(s,e){if(!s.body)throw e.abort(),new w("Attempted to iterate over a response with no body");const t=new pa,n=new xt,r=Xs(s.body);for await(const i of da(r))for(const a of n.decode(i)){const o=t.decode(a);o&&(yield o)}for(const i of n.flush()){const a=t.decode(i);a&&(yield a)}}async function*da(s){let e=new Uint8Array;for await(const t of s){if(t==null)continue;const n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let r=new Uint8Array(e.length+n.length);r.set(e),r.set(n,e.length),e=r;let i;for(;(i=ca(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}class pa{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=ha(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}}function ha(s,e){const t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}const Ys=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function",Qs=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&At(s),At=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function",ma=s=>Qs(s)||Ys(s)||Fs(s);async function Zs(s,e,t){if(s=await s,Qs(s))return s;if(Ys(s)){const r=await s.blob();e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=At(r)?[await r.arrayBuffer()]:[r];return new Qt(i,e,t)}const n=await fa(s);if(e||(e=ya(s)??"unknown_file"),!t?.type){const r=n[0]?.type;typeof r=="string"&&(t={...t,type:r})}return new Qt(n,e,t)}async function fa(s){let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(At(s))e.push(await s.arrayBuffer());else if(wa(s))for await(const t of s)e.push(t);else throw new Error(`Unexpected data type: ${typeof s}; constructor: ${s?.constructor?.name}; props: ${ga(s)}`);return e}function ga(s){return`[${Object.getOwnPropertyNames(s).map(t=>`"${t}"`).join(", ")}]`}function ya(s){return Ut(s.name)||Ut(s.filename)||Ut(s.path)?.split(/[\\/]/).pop()}const Ut=s=>{if(typeof s=="string")return s;if(typeof Buffer<"u"&&s instanceof Buffer)return String(s)},wa=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function",ts=s=>s&&typeof s=="object"&&s.body&&s[Symbol.toStringTag]==="MultipartBody",be=async s=>{const e=await ba(s.body);return Ns(e,s)},ba=async s=>{const e=new Os;return await Promise.all(Object.entries(s||{}).map(([t,n])=>Zt(e,t,n))),e},Zt=async(s,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")s.append(e,String(t));else if(ma(t)){const n=await Zs(t);s.append(e,n)}else if(Array.isArray(t))await Promise.all(t.map(n=>Zt(s,e+"[]",n)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([n,r])=>Zt(s,`${e}[${n}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var er={},_a=function(s,e,t,n,r){if(typeof e=="function"?s!==e||!0:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(s,t),t},Ea=function(s,e,t,n){if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},et;Us();async function tr(s){const{response:e}=s;if(s.options.stream)return pe("response",e.status,e.url,e.headers,e.body),s.options.__streamClass?s.options.__streamClass.fromSSEResponse(e,s.controller):re.fromSSEResponse(e,s.controller);if(e.status===204)return null;if(s.options.__binaryResponse)return e;const n=e.headers.get("content-type")?.split(";")[0]?.trim();if(n?.includes("application/json")||n?.endsWith("+json")){const a=await e.json();return pe("response",e.status,e.url,e.headers,a),nr(a,e)}const i=await e.text();return pe("response",e.status,e.url,e.headers,i),i}function nr(s,e){return!s||typeof s!="object"||Array.isArray(s)?s:Object.defineProperty(s,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class vt extends Promise{constructor(e,t=tr){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new vt(this.responsePromise,async t=>nr(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class xa{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:i}){this.baseURL=e,this.maxRetries=Bt("maxRetries",t),this.timeout=Bt("timeout",n),this.httpAgent=r,this.fetch=i??Ds}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Ra(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${La()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async r=>{const i=r&&At(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:i}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const n={...e},{method:r,path:i,query:a,headers:o={}}=n,l=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:ts(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,c=this.calculateContentLength(l),m=this.buildURL(i,a);"timeout"in n&&Bt("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const u=n.httpAgent??this.httpAgent??Ms(m),p=n.timeout+1e3;typeof u?.options?.timeout=="number"&&p>(u.options.timeout??0)&&(u.options.timeout=p),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);const h=this.buildHeaders({options:n,headers:o,contentLength:c,retryCount:t});return{req:{method:r,...l&&{body:l},headers:h,...u&&{agent:u},signal:n.signal??null},url:m,timeout:n.timeout}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:r}){const i={};n&&(i["content-length"]=n);const a=this.defaultHeaders(e);return is(i,a),is(i,t),ts(e.body)&&Ue!=="node"&&delete i["content-type"],nt(a,"x-stainless-retry-count")===void 0&&nt(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(r)),nt(a,"x-stainless-timeout")===void 0&&nt(t,"x-stainless-timeout")===void 0&&e.timeout&&(i["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,r){return B.generate(e,t,n,r)}request(e,t=null){return new vt(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,r=n.maxRetries??this.maxRetries;t==null&&(t=r),await this.prepareOptions(n);const{req:i,url:a,timeout:o}=this.buildRequest(n,{retryCount:r-t});if(await this.prepareRequest(i,{url:a,options:n}),pe("request",a,n,i.headers),n.signal?.aborted)throw new X;const l=new AbortController,c=await this.fetchWithTimeout(a,i,o,l).catch(en);if(c instanceof Error){if(n.signal?.aborted)throw new X;if(t)return this.retryRequest(n,t);throw c.name==="AbortError"?new un:new Et({cause:c})}const m=rr(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const E=`retrying, ${t} attempts remaining`;return pe(`response (error; ${E})`,c.status,a,m),this.retryRequest(n,t,m)}const u=await c.text().catch(E=>en(E).message),p=Sa(u),h=p?void 0:u;throw pe(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,a,m,h),this.makeStatusError(c.status,p,h,m)}return{response:c,options:n,controller:l}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new Aa(this,n,e)}buildURL(e,t){const n=Ta(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return ir(r)||(t={...r,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new w(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:i,...a}=t||{};i&&i.addEventListener("abort",()=>r.abort());const o=setTimeout(()=>r.abort(),n),l={signal:r.signal,...a};return l.method&&(l.method=l.method.toUpperCase()),this.fetch.call(void 0,e,l).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let r;const i=n?.["retry-after-ms"];if(i){const o=parseFloat(i);Number.isNaN(o)||(r=o)}const a=n?.["retry-after"];if(a&&!r){const o=parseFloat(a);Number.isNaN(o)?r=Date.parse(a)-Date.now():r=o*1e3}if(!(r&&0<=r&&r<60*1e3)){const o=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,o)}return await We(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Ce}`}}class sr{constructor(e,t,n,r){et.set(this,void 0),_a(this,et,e),this.options=r,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new w("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[r,i]of n)e.url.searchParams.set(r,i);t.query=void 0,t.path=e.url.toString()}return await Ea(this,et,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(et=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Aa extends vt{constructor(e,t,n){super(t,async r=>new n(e,r.response,await tr(r),r.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const rr=s=>new Proxy(Object.fromEntries(s.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),va={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},I=s=>typeof s=="object"&&s!==null&&!ir(s)&&Object.keys(s).every(e=>ar(va,e)),Ca=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":ss(Deno.build.os),"X-Stainless-Arch":ns(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":ss(process.platform),"X-Stainless-Arch":ns(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const s=Ia();return s?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${s.browser}`,"X-Stainless-Runtime-Version":s.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Ia(){if(typeof navigator>"u"||!navigator)return null;const s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of s){const n=t.exec(navigator.userAgent);if(n){const r=n[1]||0,i=n[2]||0,a=n[3]||0;return{browser:e,version:`${r}.${i}.${a}`}}}return null}const ns=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",ss=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown");let rs;const Ra=()=>rs??(rs=Ca()),Sa=s=>{try{return JSON.parse(s)}catch{return}},Pa=/^[a-z][a-z0-9+.-]*:/i,Ta=s=>Pa.test(s),We=s=>new Promise(e=>setTimeout(e,s)),Bt=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new w(`${s} must be an integer`);if(e<0)throw new w(`${s} must be a positive integer`);return e},en=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null)try{return new Error(JSON.stringify(s))}catch{}return new Error(s)},tt=s=>{if(typeof process<"u")return er?.[s]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(s)?.trim()};function ir(s){if(!s)return!0;for(const e in s)return!1;return!0}function ar(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function is(s,e){for(const t in e){if(!ar(e,t))continue;const n=t.toLowerCase();if(!n)continue;const r=e[t];r===null?delete s[n]:r!==void 0&&(s[n]=r)}}const as=new Set(["authorization","api-key"]);function pe(s,...e){if(typeof process<"u"&&er?.DEBUG==="true"){const t=e.map(n=>{if(!n)return n;if(n.headers){const i={...n,headers:{...n.headers}};for(const a in n.headers)as.has(a.toLowerCase())&&(i.headers[a]="REDACTED");return i}let r=null;for(const i in n)as.has(i.toLowerCase())&&(r??(r={...n}),r[i]="REDACTED");return r??n});console.log(`OpenAI:DEBUG:${s}`,...t)}}const La=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}),Da=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",Oa=s=>typeof s?.get=="function",nt=(s,e)=>{const t=e.toLowerCase();if(Oa(s)){const n=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(r,i,a)=>i+a.toUpperCase());for(const r of[e,t,e.toUpperCase(),n]){const i=s.get(r);if(i)return i}}for(const[n,r]of Object.entries(s))if(n.toLowerCase()===t)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${e} header, using the first entry.`),r[0]):r},ka=s=>{if(typeof Buffer<"u"){const e=Buffer.from(s,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(s),t=e.length,n=new Uint8Array(t);for(let r=0;r<t;r++)n[r]=e.charCodeAt(r);return Array.from(new Float32Array(n.buffer))}};function zt(s){return s!=null&&typeof s=="object"&&!Array.isArray(s)}class Ct extends sr{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class O extends sr{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class b{constructor(e){this._client=e}}let or=class extends b{list(e,t={},n){return I(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,Na,{query:t,...n})}},It=class extends b{constructor(){super(...arguments),this.messages=new or(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return I(e)?this.list({},e):this._client.getAPIList("/chat/completions",Rt,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}};class Rt extends O{}class Na extends O{}It.ChatCompletionsPage=Rt;It.Messages=or;let St=class extends b{constructor(){super(...arguments),this.completions=new It(this._client)}};St.Completions=It;St.ChatCompletionsPage=Rt;class lr extends b{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class cr extends b{create(e,t){return this._client.post("/audio/transcriptions",be({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class ur extends b{create(e,t){return this._client.post("/audio/translations",be({body:e,...t,__metadata:{model:e.model}}))}}class He extends b{constructor(){super(...arguments),this.transcriptions=new cr(this._client),this.translations=new ur(this._client),this.speech=new lr(this._client)}}He.Transcriptions=cr;He.Translations=ur;He.Speech=lr;class dn extends b{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return I(e)?this.list({},e):this._client.getAPIList("/batches",pn,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class pn extends O{}dn.BatchesPage=pn;var Y=function(s,e,t,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(s,t):r?r.value=t:e.set(s,t),t},C=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},tn,lt,ct,Oe,ke,ut,Ne,oe,Me,gt,yt,Ie,dr;class hn{constructor(){tn.add(this),this.controller=new AbortController,lt.set(this,void 0),ct.set(this,()=>{}),Oe.set(this,()=>{}),ke.set(this,void 0),ut.set(this,()=>{}),Ne.set(this,()=>{}),oe.set(this,{}),Me.set(this,!1),gt.set(this,!1),yt.set(this,!1),Ie.set(this,!1),Y(this,lt,new Promise((e,t)=>{Y(this,ct,e,"f"),Y(this,Oe,t,"f")}),"f"),Y(this,ke,new Promise((e,t)=>{Y(this,ut,e,"f"),Y(this,Ne,t,"f")}),"f"),C(this,lt,"f").catch(()=>{}),C(this,ke,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},C(this,tn,"m",dr).bind(this))},0)}_connected(){this.ended||(C(this,ct,"f").call(this),this._emit("connect"))}get ended(){return C(this,Me,"f")}get errored(){return C(this,gt,"f")}get aborted(){return C(this,yt,"f")}abort(){this.controller.abort()}on(e,t){return(C(this,oe,"f")[e]||(C(this,oe,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=C(this,oe,"f")[e];if(!n)return this;const r=n.findIndex(i=>i.listener===t);return r>=0&&n.splice(r,1),this}once(e,t){return(C(this,oe,"f")[e]||(C(this,oe,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{Y(this,Ie,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){Y(this,Ie,!0,"f"),await C(this,ke,"f")}_emit(e,...t){if(C(this,Me,"f"))return;e==="end"&&(Y(this,Me,!0,"f"),C(this,ut,"f").call(this));const n=C(this,oe,"f")[e];if(n&&(C(this,oe,"f")[e]=n.filter(r=>!r.once),n.forEach(({listener:r})=>r(...t))),e==="abort"){const r=t[0];!C(this,Ie,"f")&&!n?.length&&Promise.reject(r),C(this,Oe,"f").call(this,r),C(this,Ne,"f").call(this,r),this._emit("end");return}if(e==="error"){const r=t[0];!C(this,Ie,"f")&&!n?.length&&Promise.reject(r),C(this,Oe,"f").call(this,r),C(this,Ne,"f").call(this,r),this._emit("end")}}_emitFinal(){}}lt=new WeakMap,ct=new WeakMap,Oe=new WeakMap,ke=new WeakMap,ut=new WeakMap,Ne=new WeakMap,oe=new WeakMap,Me=new WeakMap,gt=new WeakMap,yt=new WeakMap,Ie=new WeakMap,tn=new WeakSet,dr=function(e){if(Y(this,gt,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new X),e instanceof X)return Y(this,yt,!0,"f"),this._emit("abort",e);if(e instanceof w)return this._emit("error",e);if(e instanceof Error){const t=new w(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new w(String(e)))};var g=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},H=function(s,e,t,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(s,t):r?r.value=t:e.set(s,t),t},U,nn,se,dt,Q,we,Re,ge,wt,V,pt,ht,Be,$e,Fe,os,ls,cs,us,ds,ps,hs;class ee extends hn{constructor(){super(...arguments),U.add(this),nn.set(this,[]),se.set(this,{}),dt.set(this,{}),Q.set(this,void 0),we.set(this,void 0),Re.set(this,void 0),ge.set(this,void 0),wt.set(this,void 0),V.set(this,void 0),pt.set(this,void 0),ht.set(this,void 0),Be.set(this,void 0)}[(nn=new WeakMap,se=new WeakMap,dt=new WeakMap,Q=new WeakMap,we=new WeakMap,Re=new WeakMap,ge=new WeakMap,wt=new WeakMap,V=new WeakMap,pt=new WeakMap,ht=new WeakMap,Be=new WeakMap,U=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",r=>{const i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{n=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{n=!0;for(const i of t)i.reject(r);t.length=0}),this.on("error",r=>{n=!0;for(const i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new ee;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const r=re.fromReadableStream(e,this.controller);for await(const i of r)g(this,U,"m",$e).call(this,i);if(r.controller.signal?.aborted)throw new X;return this._addRun(g(this,U,"m",Fe).call(this))}toReadableStream(){return new re(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r,i){const a=new ee;return a._run(()=>a._runToolAssistantStream(e,t,n,r,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,n,r,i){const a=i?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const o={...r,stream:!0},l=await e.submitToolOutputs(t,n,o,{...i,signal:this.controller.signal});this._connected();for await(const c of l)g(this,U,"m",$e).call(this,c);if(l.controller.signal?.aborted)throw new X;return this._addRun(g(this,U,"m",Fe).call(this))}static createThreadAssistantStream(e,t,n){const r=new ee;return r._run(()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(e,t,n,r){const i=new ee;return i._run(()=>i._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return g(this,pt,"f")}currentRun(){return g(this,ht,"f")}currentMessageSnapshot(){return g(this,Q,"f")}currentRunStepSnapshot(){return g(this,Be,"f")}async finalRunSteps(){return await this.done(),Object.values(g(this,se,"f"))}async finalMessages(){return await this.done(),Object.values(g(this,dt,"f"))}async finalRun(){if(await this.done(),!g(this,we,"f"))throw Error("Final run was not received.");return g(this,we,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const i={...t,stream:!0},a=await e.createAndRun(i,{...n,signal:this.controller.signal});this._connected();for await(const o of a)g(this,U,"m",$e).call(this,o);if(a.controller.signal?.aborted)throw new X;return this._addRun(g(this,U,"m",Fe).call(this))}async _createAssistantStream(e,t,n,r){const i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},o=await e.create(t,a,{...r,signal:this.controller.signal});this._connected();for await(const l of o)g(this,U,"m",$e).call(this,l);if(o.controller.signal?.aborted)throw new X;return this._addRun(g(this,U,"m",Fe).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let i=e[n];if(i==null){e[n]=r;continue}if(n==="index"||n==="type"){e[n]=r;continue}if(typeof i=="string"&&typeof r=="string")i+=r;else if(typeof i=="number"&&typeof r=="number")i+=r;else if(zt(i)&&zt(r))i=this.accumulateDelta(i,r);else if(Array.isArray(i)&&Array.isArray(r)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...r);continue}for(const a of r){if(!zt(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);const o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const l=i[o];l==null?i.push(a):i[o]=this.accumulateDelta(l,a)}continue}else throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${i}`);e[n]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r,i){return await this._createToolAssistantStream(n,e,t,r,i)}}$e=function(e){if(!this.ended)switch(H(this,pt,e,"f"),g(this,U,"m",cs).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":g(this,U,"m",hs).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":g(this,U,"m",ls).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":g(this,U,"m",os).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Fe=function(){if(this.ended)throw new w("stream has ended, this shouldn't happen");if(!g(this,we,"f"))throw Error("Final run has not been received");return g(this,we,"f")},os=function(e){const[t,n]=g(this,U,"m",ds).call(this,e,g(this,Q,"f"));H(this,Q,t,"f"),g(this,dt,"f")[t.id]=t;for(const r of n){const i=t.content[r.index];i?.type=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const r of e.data.delta.content){if(r.type=="text"&&r.text){let i=r.text,a=t.content[r.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=g(this,Re,"f")){if(g(this,ge,"f"))switch(g(this,ge,"f").type){case"text":this._emit("textDone",g(this,ge,"f").text,g(this,Q,"f"));break;case"image_file":this._emit("imageFileDone",g(this,ge,"f").image_file,g(this,Q,"f"));break}H(this,Re,r.index,"f")}H(this,ge,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(g(this,Re,"f")!==void 0){const r=e.data.content[g(this,Re,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,g(this,Q,"f"));break;case"text":this._emit("textDone",r.text,g(this,Q,"f"));break}}g(this,Q,"f")&&this._emit("messageDone",e.data),H(this,Q,void 0,"f")}},ls=function(e){const t=g(this,U,"m",us).call(this,e);switch(H(this,Be,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&n.step_details.type=="tool_calls"&&n.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const i of n.step_details.tool_calls)i.index==g(this,wt,"f")?this._emit("toolCallDelta",i,t.step_details.tool_calls[i.index]):(g(this,V,"f")&&this._emit("toolCallDone",g(this,V,"f")),H(this,wt,i.index,"f"),H(this,V,t.step_details.tool_calls[i.index],"f"),g(this,V,"f")&&this._emit("toolCallCreated",g(this,V,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":H(this,Be,void 0,"f"),e.data.step_details.type=="tool_calls"&&g(this,V,"f")&&(this._emit("toolCallDone",g(this,V,"f")),H(this,V,void 0,"f")),this._emit("runStepDone",e.data,t);break}},cs=function(e){g(this,nn,"f").push(e),this._emit("event",e)},us=function(e){switch(e.event){case"thread.run.step.created":return g(this,se,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=g(this,se,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=ee.accumulateDelta(t,n.delta);g(this,se,"f")[e.data.id]=r}return g(this,se,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":g(this,se,"f")[e.data.id]=e.data;break}if(g(this,se,"f")[e.data.id])return g(this,se,"f")[e.data.id];throw new Error("No snapshot available")},ds=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const i of r.delta.content)if(i.index in t.content){let a=t.content[i.index];t.content[i.index]=g(this,U,"m",ps).call(this,i,a)}else t.content[i.index]=i,n.push(i);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},ps=function(e,t){return ee.accumulateDelta(t,e)},hs=function(e){switch(H(this,ht,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":H(this,we,e.data,"f"),g(this,V,"f")&&(this._emit("toolCallDone",g(this,V,"f")),H(this,V,void 0,"f"));break}};class mn extends b{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return I(e)?this.list({},e):this._client.getAPIList("/assistants",fn,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class fn extends O{}mn.AssistantsPage=fn;function ms(s){return typeof s.parse=="function"}const Se=s=>s?.role==="assistant",pr=s=>s?.role==="function",hr=s=>s?.role==="tool";function gn(s){return s?.$brand==="auto-parseable-response-format"}function qe(s){return s?.$brand==="auto-parseable-tool"}function Ma(s,e){return!e||!mr(e)?{...s,choices:s.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:yn(s,e)}function yn(s,e){const t=s.choices.map(n=>{if(n.finish_reason==="length")throw new Ks;if(n.finish_reason==="content_filter")throw new Js;return{...n,message:{...n.message,...n.message.tool_calls?{tool_calls:n.message.tool_calls?.map(r=>Fa(e,r))??void 0}:void 0,parsed:n.message.content&&!n.message.refusal?$a(e,n.message.content):null}}});return{...s,choices:t}}function $a(s,e){return s.response_format?.type!=="json_schema"?null:s.response_format?.type==="json_schema"?"$parseRaw"in s.response_format?s.response_format.$parseRaw(e):JSON.parse(e):null}function Fa(s,e){const t=s.tools?.find(n=>n.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:qe(t)?t.$parseRaw(e.function.arguments):t?.function.strict?JSON.parse(e.function.arguments):null}}}function Ua(s,e){if(!s)return!1;const t=s.tools?.find(n=>n.function?.name===e.function.name);return qe(t)||t?.function.strict||!1}function mr(s){return gn(s.response_format)?!0:s.tools?.some(e=>qe(e)||e.type==="function"&&e.function.strict===!0)??!1}function Ba(s){for(const e of s??[]){if(e.type!=="function")throw new w(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new w(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var W=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},G,sn,bt,rn,an,on,fr,ln;const fs=10;class gr extends hn{constructor(){super(...arguments),G.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(pr(e)||hr(e))&&e.content)this._emit("functionCallResult",e.content);else if(Se(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Se(e)&&e.tool_calls)for(const n of e.tool_calls)n.type==="function"&&this._emit("functionCall",n.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new w("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),W(this,G,"m",sn).call(this)}async finalMessage(){return await this.done(),W(this,G,"m",bt).call(this)}async finalFunctionCall(){return await this.done(),W(this,G,"m",rn).call(this)}async finalFunctionCallResult(){return await this.done(),W(this,G,"m",an).call(this)}async totalUsage(){return await this.done(),W(this,G,"m",on).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=W(this,G,"m",bt).call(this);t&&this._emit("finalMessage",t);const n=W(this,G,"m",sn).call(this);n&&this._emit("finalContent",n);const r=W(this,G,"m",rn).call(this);r&&this._emit("finalFunctionCall",r);const i=W(this,G,"m",an).call(this);i!=null&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",W(this,G,"m",on).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),W(this,G,"m",fr).call(this,t);const i=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(yn(i,t))}async _runChatCompletion(e,t,n){for(const r of t.messages)this._addMessage(r,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const r="function",{function_call:i="auto",stream:a,...o}=t,l=typeof i!="string"&&i?.name,{maxChatCompletions:c=fs}=n||{},m={};for(const p of t.functions)m[p.name||p.function.name]=p;const u=t.functions.map(p=>({name:p.name||p.function.name,parameters:p.parameters,description:p.description}));for(const p of t.messages)this._addMessage(p,!1);for(let p=0;p<c;++p){const f=(await this._createChatCompletion(e,{...o,function_call:i,functions:u,messages:[...this.messages]},n)).choices[0]?.message;if(!f)throw new w("missing message in ChatCompletion response");if(!f.function_call)return;const{name:d,arguments:E}=f.function_call,A=m[d];if(A){if(l&&l!==d){const $=`Invalid function_call: ${JSON.stringify(d)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:r,name:d,content:$});continue}}else{const $=`Invalid function_call: ${JSON.stringify(d)}. Available options are: ${u.map(z=>JSON.stringify(z.name)).join(", ")}. Please try again`;this._addMessage({role:r,name:d,content:$});continue}let y;try{y=ms(A)?await A.parse(E):E}catch($){this._addMessage({role:r,name:d,content:$ instanceof Error?$.message:String($)});continue}const M=await A.function(y,this),R=W(this,G,"m",ln).call(this,M);if(this._addMessage({role:r,name:d,content:R}),l)return}}async _runTools(e,t,n){const r="tool",{tool_choice:i="auto",stream:a,...o}=t,l=typeof i!="string"&&i?.function?.name,{maxChatCompletions:c=fs}=n||{},m=t.tools.map(h=>{if(qe(h)){if(!h.$callback)throw new w("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:h.$callback,name:h.function.name,description:h.function.description||"",parameters:h.function.parameters,parse:h.$parseRaw,strict:!0}}}return h}),u={};for(const h of m)h.type==="function"&&(u[h.function.name||h.function.function.name]=h.function);const p="tools"in t?m.map(h=>h.type==="function"?{type:"function",function:{name:h.function.name||h.function.function.name,parameters:h.function.parameters,description:h.function.description,strict:h.function.strict}}:h):void 0;for(const h of t.messages)this._addMessage(h,!1);for(let h=0;h<c;++h){const d=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:p,messages:[...this.messages]},n)).choices[0]?.message;if(!d)throw new w("missing message in ChatCompletion response");if(!d.tool_calls?.length)return;for(const E of d.tool_calls){if(E.type!=="function")continue;const A=E.id,{name:y,arguments:M}=E.function,R=u[y];if(R){if(l&&l!==y){const F=`Invalid tool_call: ${JSON.stringify(y)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:r,tool_call_id:A,content:F});continue}}else{const F=`Invalid tool_call: ${JSON.stringify(y)}. Available options are: ${Object.keys(u).map(k=>JSON.stringify(k)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:A,content:F});continue}let $;try{$=ms(R)?await R.parse(M):M}catch(F){const k=F instanceof Error?F.message:String(F);this._addMessage({role:r,tool_call_id:A,content:k});continue}const z=await R.function($,this),j=W(this,G,"m",ln).call(this,z);if(this._addMessage({role:r,tool_call_id:A,content:j}),l)return}}}}G=new WeakSet,sn=function(){return W(this,G,"m",bt).call(this).content??null},bt=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Se(t)){const{function_call:n,...r}=t,i={...r,content:t.content??null,refusal:t.refusal??null};return n&&(i.function_call=n),i}}throw new w("stream ended without producing a ChatCompletionMessage with role=assistant")},rn=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Se(t)&&t?.function_call)return t.function_call;if(Se(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},an=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(pr(t)&&t.content!=null||hr(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(n=>n.role==="assistant"&&n.tool_calls?.some(r=>r.type==="function"&&r.id===t.tool_call_id)))return t.content}},on=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},fr=function(e){if(e.n!=null&&e.n>1)throw new w("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ln=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class je extends gr{static runFunctions(e,t,n){const r=new je,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run(()=>r._runFunctions(e,t,i)),r}static runTools(e,t,n){const r=new je,i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,i)),r}_addMessage(e,t=!0){super._addMessage(e,t),Se(e)&&e.content&&this._emit("content",e.content)}}const yr=1,wr=2,br=4,_r=8,Er=16,xr=32,Ar=64,vr=128,Cr=256,Ir=vr|Cr,Rr=Er|xr|Ir|Ar,Sr=yr|wr|Rr,Pr=br|_r,za=Sr|Pr,N={STR:yr,NUM:wr,ARR:br,OBJ:_r,NULL:Er,BOOL:xr,NAN:Ar,INFINITY:vr,MINUS_INFINITY:Cr,INF:Ir,SPECIAL:Rr,ATOM:Sr,COLLECTION:Pr,ALL:za};class ja extends Error{}class Ga extends Error{}function Wa(s,e=N.ALL){if(typeof s!="string")throw new TypeError(`expecting str, got ${typeof s}`);if(!s.trim())throw new Error(`${s} is empty`);return Ha(s.trim(),e)}const Ha=(s,e)=>{const t=s.length;let n=0;const r=p=>{throw new ja(`${p} at position ${n}`)},i=p=>{throw new Ga(`${p} at position ${n}`)},a=()=>(u(),n>=t&&r("Unexpected end of input"),s[n]==='"'?o():s[n]==="{"?l():s[n]==="["?c():s.substring(n,n+4)==="null"||N.NULL&e&&t-n<4&&"null".startsWith(s.substring(n))?(n+=4,null):s.substring(n,n+4)==="true"||N.BOOL&e&&t-n<4&&"true".startsWith(s.substring(n))?(n+=4,!0):s.substring(n,n+5)==="false"||N.BOOL&e&&t-n<5&&"false".startsWith(s.substring(n))?(n+=5,!1):s.substring(n,n+8)==="Infinity"||N.INFINITY&e&&t-n<8&&"Infinity".startsWith(s.substring(n))?(n+=8,1/0):s.substring(n,n+9)==="-Infinity"||N.MINUS_INFINITY&e&&1<t-n&&t-n<9&&"-Infinity".startsWith(s.substring(n))?(n+=9,-1/0):s.substring(n,n+3)==="NaN"||N.NAN&e&&t-n<3&&"NaN".startsWith(s.substring(n))?(n+=3,NaN):m()),o=()=>{const p=n;let h=!1;for(n++;n<t&&(s[n]!=='"'||h&&s[n-1]==="\\");)h=s[n]==="\\"?!h:!1,n++;if(s.charAt(n)=='"')try{return JSON.parse(s.substring(p,++n-Number(h)))}catch(f){i(String(f))}else if(N.STR&e)try{return JSON.parse(s.substring(p,n-Number(h))+'"')}catch{return JSON.parse(s.substring(p,s.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},l=()=>{n++,u();const p={};try{for(;s[n]!=="}";){if(u(),n>=t&&N.OBJ&e)return p;const h=o();u(),n++;try{const f=a();Object.defineProperty(p,h,{value:f,writable:!0,enumerable:!0,configurable:!0})}catch(f){if(N.OBJ&e)return p;throw f}u(),s[n]===","&&n++}}catch{if(N.OBJ&e)return p;r("Expected '}' at end of object")}return n++,p},c=()=>{n++;const p=[];try{for(;s[n]!=="]";)p.push(a()),u(),s[n]===","&&n++}catch{if(N.ARR&e)return p;r("Expected ']' at end of array")}return n++,p},m=()=>{if(n===0){s==="-"&&N.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(s)}catch(h){if(N.NUM&e)try{return s[s.length-1]==="."?JSON.parse(s.substring(0,s.lastIndexOf("."))):JSON.parse(s.substring(0,s.lastIndexOf("e")))}catch{}i(String(h))}}const p=n;for(s[n]==="-"&&n++;s[n]&&!",]}".includes(s[n]);)n++;n==t&&!(N.NUM&e)&&r("Unterminated number literal");try{return JSON.parse(s.substring(p,n))}catch{s.substring(p,n)==="-"&&N.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(s.substring(p,s.lastIndexOf("e")))}catch(f){i(String(f))}}},u=()=>{for(;n<t&&` 
\r	`.includes(s[n]);)n++};return a()},gs=s=>Wa(s,N.ALL^N.NUM);var Ee=function(s,e,t,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(s,t):r?r.value=t:e.set(s,t),t},x=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},L,ae,xe,ce,jt,st,Gt,Wt,Ht,rt,qt,ys;class Ge extends gr{constructor(e){super(),L.add(this),ae.set(this,void 0),xe.set(this,void 0),ce.set(this,void 0),Ee(this,ae,e,"f"),Ee(this,xe,[],"f")}get currentChatCompletionSnapshot(){return x(this,ce,"f")}static fromReadableStream(e){const t=new Ge(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const r=new Ge(t);return r._run(()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(e,t,n){super._createChatCompletion;const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),x(this,L,"m",jt).call(this);const i=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const a of i)x(this,L,"m",Gt).call(this,a);if(i.controller.signal?.aborted)throw new X;return this._addChatCompletion(x(this,L,"m",rt).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),x(this,L,"m",jt).call(this),this._connected();const r=re.fromReadableStream(e,this.controller);let i;for await(const a of r)i&&i!==a.id&&this._addChatCompletion(x(this,L,"m",rt).call(this)),x(this,L,"m",Gt).call(this,a),i=a.id;if(r.controller.signal?.aborted)throw new X;return this._addChatCompletion(x(this,L,"m",rt).call(this))}[(ae=new WeakMap,xe=new WeakMap,ce=new WeakMap,L=new WeakSet,jt=function(){this.ended||Ee(this,ce,void 0,"f")},st=function(t){let n=x(this,xe,"f")[t.index];return n||(n={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},x(this,xe,"f")[t.index]=n,n)},Gt=function(t){if(this.ended)return;const n=x(this,L,"m",ys).call(this,t);this._emit("chunk",t,n);for(const r of t.choices){const i=n.choices[r.index];r.delta.content!=null&&i.message?.role==="assistant"&&i.message?.content&&(this._emit("content",r.delta.content,i.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:i.message.content,parsed:i.message.parsed})),r.delta.refusal!=null&&i.message?.role==="assistant"&&i.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:i.message.refusal}),r.logprobs?.content!=null&&i.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:i.logprobs?.content??[]}),r.logprobs?.refusal!=null&&i.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:i.logprobs?.refusal??[]});const a=x(this,L,"m",st).call(this,i);i.finish_reason&&(x(this,L,"m",Ht).call(this,i),a.current_tool_call_index!=null&&x(this,L,"m",Wt).call(this,i,a.current_tool_call_index));for(const o of r.delta.tool_calls??[])a.current_tool_call_index!==o.index&&(x(this,L,"m",Ht).call(this,i),a.current_tool_call_index!=null&&x(this,L,"m",Wt).call(this,i,a.current_tool_call_index)),a.current_tool_call_index=o.index;for(const o of r.delta.tool_calls??[]){const l=i.message.tool_calls?.[o.index];l?.type&&(l?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:l.function?.name,index:o.index,arguments:l.function.arguments,parsed_arguments:l.function.parsed_arguments,arguments_delta:o.function?.arguments??""}):(l?.type,void 0))}}},Wt=function(t,n){if(x(this,L,"m",st).call(this,t).done_tool_calls.has(n))return;const i=t.message.tool_calls?.[n];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){const a=x(this,ae,"f")?.tools?.find(o=>o.type==="function"&&o.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:n,arguments:i.function.arguments,parsed_arguments:qe(a)?a.$parseRaw(i.function.arguments):a?.function.strict?JSON.parse(i.function.arguments):null})}else i.type},Ht=function(t){const n=x(this,L,"m",st).call(this,t);if(t.message.content&&!n.content_done){n.content_done=!0;const r=x(this,L,"m",qt).call(this);this._emit("content.done",{content:t.message.content,parsed:r?r.$parseRaw(t.message.content):null})}t.message.refusal&&!n.refusal_done&&(n.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!n.logprobs_content_done&&(n.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!n.logprobs_refusal_done&&(n.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},rt=function(){if(this.ended)throw new w("stream has ended, this shouldn't happen");const t=x(this,ce,"f");if(!t)throw new w("request ended without sending any chunks");return Ee(this,ce,void 0,"f"),Ee(this,xe,[],"f"),qa(t,x(this,ae,"f"))},qt=function(){const t=x(this,ae,"f")?.response_format;return gn(t)?t:null},ys=function(t){var n,r,i,a;let o=x(this,ce,"f");const{choices:l,...c}=t;o?Object.assign(o,c):o=Ee(this,ce,{...c,choices:[]},"f");for(const{delta:m,finish_reason:u,index:p,logprobs:h=null,...f}of t.choices){let d=o.choices[p];if(d||(d=o.choices[p]={finish_reason:u,index:p,message:{},logprobs:h,...f}),h)if(!d.logprobs)d.logprobs=Object.assign({},h);else{const{content:z,refusal:j,...F}=h;Object.assign(d.logprobs,F),z&&((n=d.logprobs).content??(n.content=[]),d.logprobs.content.push(...z)),j&&((r=d.logprobs).refusal??(r.refusal=[]),d.logprobs.refusal.push(...j))}if(u&&(d.finish_reason=u,x(this,ae,"f")&&mr(x(this,ae,"f")))){if(u==="length")throw new Ks;if(u==="content_filter")throw new Js}if(Object.assign(d,f),!m)continue;const{content:E,refusal:A,function_call:y,role:M,tool_calls:R,...$}=m;if(Object.assign(d.message,$),A&&(d.message.refusal=(d.message.refusal||"")+A),M&&(d.message.role=M),y&&(d.message.function_call?(y.name&&(d.message.function_call.name=y.name),y.arguments&&((i=d.message.function_call).arguments??(i.arguments=""),d.message.function_call.arguments+=y.arguments)):d.message.function_call=y),E&&(d.message.content=(d.message.content||"")+E,!d.message.refusal&&x(this,L,"m",qt).call(this)&&(d.message.parsed=gs(d.message.content))),R){d.message.tool_calls||(d.message.tool_calls=[]);for(const{index:z,id:j,type:F,function:k,...P}of R){const T=(a=d.message.tool_calls)[z]??(a[z]={});Object.assign(T,P),j&&(T.id=j),F&&(T.type=F),k&&(T.function??(T.function={name:k.name??"",arguments:""})),k?.name&&(T.function.name=k.name),k?.arguments&&(T.function.arguments+=k.arguments,Ua(x(this,ae,"f"),T)&&(T.function.parsed_arguments=gs(T.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",r=>{const i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{n=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{n=!0;for(const i of t)i.reject(r);t.length=0}),this.on("error",r=>{n=!0;for(const i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new re(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function qa(s,e){const{id:t,choices:n,created:r,model:i,system_fingerprint:a,...o}=s,l={...o,id:t,choices:n.map(({message:c,finish_reason:m,index:u,logprobs:p,...h})=>{if(!m)throw new w(`missing finish_reason for choice ${u}`);const{content:f=null,function_call:d,tool_calls:E,...A}=c,y=c.role;if(!y)throw new w(`missing role for choice ${u}`);if(d){const{arguments:M,name:R}=d;if(M==null)throw new w(`missing function_call.arguments for choice ${u}`);if(!R)throw new w(`missing function_call.name for choice ${u}`);return{...h,message:{content:f,function_call:{arguments:M,name:R},role:y,refusal:c.refusal??null},finish_reason:m,index:u,logprobs:p}}return E?{...h,index:u,finish_reason:m,logprobs:p,message:{...A,role:y,content:f,refusal:c.refusal??null,tool_calls:E.map((M,R)=>{const{function:$,type:z,id:j,...F}=M,{arguments:k,name:P,...T}=$||{};if(j==null)throw new w(`missing choices[${u}].tool_calls[${R}].id
${it(s)}`);if(z==null)throw new w(`missing choices[${u}].tool_calls[${R}].type
${it(s)}`);if(P==null)throw new w(`missing choices[${u}].tool_calls[${R}].function.name
${it(s)}`);if(k==null)throw new w(`missing choices[${u}].tool_calls[${R}].function.arguments
${it(s)}`);return{...F,id:j,type:z,function:{...T,name:P,arguments:k}}})}}:{...h,message:{...A,content:f,role:y,refusal:c.refusal??null},finish_reason:m,index:u,logprobs:p}}),created:r,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return Ma(l,e)}function it(s){return JSON.stringify(s)}class Pe extends Ge{static fromReadableStream(e){const t=new Pe(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,n){const r=new Pe(null),i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run(()=>r._runFunctions(e,t,i)),r}static runTools(e,t,n){const r=new Pe(t),i={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,i)),r}}let Tr=class extends b{parse(e,t){return Ba(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(n=>yn(n,e))}runFunctions(e,t){return e.stream?Pe.runFunctions(this._client,e,t):je.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Pe.runTools(this._client,e,t):je.runTools(this._client,e,t)}stream(e,t){return Ge.createChatCompletion(this._client,e,t)}};class cn extends b{constructor(){super(...arguments),this.completions=new Tr(this._client)}}(function(s){s.Completions=Tr})(cn||(cn={}));class Lr extends b{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Dr extends b{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Pt extends b{constructor(){super(...arguments),this.sessions=new Lr(this._client),this.transcriptionSessions=new Dr(this._client)}}Pt.Sessions=Lr;Pt.TranscriptionSessions=Dr;class wn extends b{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return I(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,bn,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class bn extends O{}wn.MessagesPage=bn;class _n extends b{retrieve(e,t,n,r={},i){return I(r)?this.retrieve(e,t,n,{},r):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:r,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}list(e,t,n={},r){return I(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,En,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class En extends O{}_n.RunStepsPage=En;let Ve=class extends b{constructor(){super(...arguments),this.steps=new _n(this._client)}create(e,t,n){const{include:r,...i}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:i,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return I(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,xn,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}createAndStream(e,t,n){return ee.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:i,response:a}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{const l=a.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await We(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,n){return ee.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,r){const i=await this.submitToolOutputs(e,t,n,r);return await this.poll(e,i.id,r)}submitToolOutputsStream(e,t,n,r){return ee.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,r)}};class xn extends O{}Ve.RunsPage=xn;Ve.Steps=_n;Ve.RunStepsPage=En;class Te extends b{constructor(){super(...arguments),this.runs=new Ve(this._client),this.messages=new wn(this._client)}create(e={},t){return I(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return ee.createThreadAssistantStream(e,this._client.beta.threads,t)}}Te.Runs=Ve;Te.RunsPage=xn;Te.Messages=wn;Te.MessagesPage=bn;class Le extends b{constructor(){super(...arguments),this.realtime=new Pt(this._client),this.chat=new cn(this._client),this.assistants=new mn(this._client),this.threads=new Te(this._client)}}Le.Realtime=Pt;Le.Assistants=mn;Le.AssistantsPage=fn;Le.Threads=Te;class Or extends b{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class kr extends b{retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}/content`,{...n,headers:{Accept:"application/binary",...n?.headers},__binaryResponse:!0})}}let Tt=class extends b{constructor(){super(...arguments),this.content=new kr(this._client)}create(e,t,n){return this._client.post(`/containers/${e}/files`,be({body:t,...n}))}retrieve(e,t,n){return this._client.get(`/containers/${e}/files/${t}`,n)}list(e,t={},n){return I(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,An,{query:t,...n})}del(e,t,n){return this._client.delete(`/containers/${e}/files/${t}`,{...n,headers:{Accept:"*/*",...n?.headers}})}};class An extends O{}Tt.FileListResponsesPage=An;Tt.Content=kr;class Ke extends b{constructor(){super(...arguments),this.files=new Tt(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return I(e)?this.list({},e):this._client.getAPIList("/containers",vn,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class vn extends O{}Ke.ContainerListResponsesPage=vn;Ke.Files=Tt;Ke.FileListResponsesPage=An;class Nr extends b{create(e,t){const n=!!e.encoding_format;let r=n?e.encoding_format:"base64";n&&pe("Request","User defined encoding_format:",e.encoding_format);const i=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return n?i:(pe("response","Decoding base64 embeddings to float32 array"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(o=>{const l=o.embedding;o.embedding=ka(l)}),a)))}}class Cn extends b{retrieve(e,t,n,r){return this._client.get(`/evals/${e}/runs/${t}/output_items/${n}`,r)}list(e,t,n={},r){return I(n)?this.list(e,t,{},n):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,In,{query:n,...r})}}class In extends O{}Cn.OutputItemListResponsesPage=In;class Je extends b{constructor(){super(...arguments),this.outputItems=new Cn(this._client)}create(e,t,n){return this._client.post(`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){return this._client.get(`/evals/${e}/runs/${t}`,n)}list(e,t={},n){return I(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,Rn,{query:t,...n})}del(e,t,n){return this._client.delete(`/evals/${e}/runs/${t}`,n)}cancel(e,t,n){return this._client.post(`/evals/${e}/runs/${t}`,n)}}class Rn extends O{}Je.RunListResponsesPage=Rn;Je.OutputItems=Cn;Je.OutputItemListResponsesPage=In;class Xe extends b{constructor(){super(...arguments),this.runs=new Je(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,n){return this._client.post(`/evals/${e}`,{body:t,...n})}list(e={},t){return I(e)?this.list({},e):this._client.getAPIList("/evals",Sn,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class Sn extends O{}Xe.EvalListResponsesPage=Sn;Xe.Runs=Je;Xe.RunListResponsesPage=Rn;let Pn=class extends b{create(e,t){return this._client.post("/files",be({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return I(e)?this.list({},e):this._client.getAPIList("/files",Tn,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=30*60*1e3}={}){const r=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(e);for(;!a.status||!r.has(a.status);)if(await We(t),a=await this.retrieve(e),Date.now()-i>n)throw new un({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}};class Tn extends O{}Pn.FileObjectsPage=Tn;class Mr extends b{}let $r=class extends b{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};class Ln extends b{constructor(){super(...arguments),this.graders=new $r(this._client)}}Ln.Graders=$r;class Dn extends b{create(e,t,n){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,On,{body:t,method:"post",...n})}retrieve(e,t={},n){return I(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}del(e,t,n){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,n)}}class On extends Ct{}Dn.PermissionCreateResponsesPage=On;let Lt=class extends b{constructor(){super(...arguments),this.permissions=new Dn(this._client)}};Lt.Permissions=Dn;Lt.PermissionCreateResponsesPage=On;class kn extends b{list(e,t={},n){return I(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Nn,{query:t,...n})}}class Nn extends O{}kn.FineTuningJobCheckpointsPage=Nn;class De extends b{constructor(){super(...arguments),this.checkpoints=new kn(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return I(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Mn,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return I(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,$n,{query:t,...n})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class Mn extends O{}class $n extends O{}De.FineTuningJobsPage=Mn;De.FineTuningJobEventsPage=$n;De.Checkpoints=kn;De.FineTuningJobCheckpointsPage=Nn;class he extends b{constructor(){super(...arguments),this.methods=new Mr(this._client),this.jobs=new De(this._client),this.checkpoints=new Lt(this._client),this.alpha=new Ln(this._client)}}he.Methods=Mr;he.Jobs=De;he.FineTuningJobsPage=Mn;he.FineTuningJobEventsPage=$n;he.Checkpoints=Lt;he.Alpha=Ln;class Fr extends b{}class Fn extends b{constructor(){super(...arguments),this.graderModels=new Fr(this._client)}}Fn.GraderModels=Fr;class Ur extends b{createVariation(e,t){return this._client.post("/images/variations",be({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",be({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class Un extends b{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Bn,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Bn extends Ct{}Un.ModelsPage=Bn;class Br extends b{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function Va(s,e){return!e||!Ja(e)?{...s,output_parsed:null,output:s.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(n=>({...n,parsed:null}))}:t)}:zr(s,e)}function zr(s,e){const t=s.output.map(r=>{if(r.type==="function_call")return{...r,parsed_arguments:Qa(e,r)};if(r.type==="message"){const i=r.content.map(a=>a.type==="output_text"?{...a,parsed:Ka(e,a.text)}:a);return{...r,content:i}}return r}),n=Object.assign({},s,{output:t});return Object.getOwnPropertyDescriptor(s,"output_text")||jr(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const r of n.output)if(r.type==="message"){for(const i of r.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),n}function Ka(s,e){return s.text?.format?.type!=="json_schema"?null:"$parseRaw"in s.text?.format?(s.text?.format).$parseRaw(e):JSON.parse(e)}function Ja(s){return!!gn(s.text?.format)}function Xa(s){return s?.$brand==="auto-parseable-tool"}function Ya(s,e){return s.find(t=>t.type==="function"&&t.name===e)}function Qa(s,e){const t=Ya(s.tools??[],e.name);return{...e,...e,parsed_arguments:Xa(t)?t.$parseRaw(e.arguments):t?.strict?JSON.parse(e.arguments):null}}function jr(s){const e=[];for(const t of s.output)if(t.type==="message")for(const n of t.content)n.type==="output_text"&&e.push(n.text);s.output_text=e.join("")}class Gr extends b{list(e,t={},n){return I(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,eo,{query:t,...n})}}var Ae=function(s,e,t,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(s,t):r?r.value=t:e.set(s,t),t},ue=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},ve,at,de,ot,ws,bs,_s,Es;class zn extends hn{constructor(e){super(),ve.add(this),at.set(this,void 0),de.set(this,void 0),ot.set(this,void 0),Ae(this,at,e,"f")}static createResponse(e,t,n){const r=new zn(t);return r._run(()=>r._createOrRetrieveResponse(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createOrRetrieveResponse(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),ue(this,ve,"m",ws).call(this);let i,a=null;"response_id"in t?(i=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):i=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const o of i)ue(this,ve,"m",bs).call(this,o,a);if(i.controller.signal?.aborted)throw new X;return ue(this,ve,"m",_s).call(this)}[(at=new WeakMap,de=new WeakMap,ot=new WeakMap,ve=new WeakSet,ws=function(){this.ended||Ae(this,de,void 0,"f")},bs=function(t,n){if(this.ended)return;const r=(a,o)=>{(n==null||o.sequence_number>n)&&this._emit(a,o)},i=ue(this,ve,"m",Es).call(this,t);switch(r("event",t),t.type){case"response.output_text.delta":{const a=i.output[t.output_index];if(!a)throw new w(`missing output at index ${t.output_index}`);if(a.type==="message"){const o=a.content[t.content_index];if(!o)throw new w(`missing content at index ${t.content_index}`);if(o.type!=="output_text")throw new w(`expected content to be 'output_text', got ${o.type}`);r("response.output_text.delta",{...t,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const a=i.output[t.output_index];if(!a)throw new w(`missing output at index ${t.output_index}`);a.type==="function_call"&&r("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:r(t.type,t);break}},_s=function(){if(this.ended)throw new w("stream has ended, this shouldn't happen");const t=ue(this,de,"f");if(!t)throw new w("request ended without sending any events");Ae(this,de,void 0,"f");const n=Za(t,ue(this,at,"f"));return Ae(this,ot,n,"f"),n},Es=function(t){let n=ue(this,de,"f");if(!n){if(t.type!=="response.created")throw new w(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return n=Ae(this,de,t.response,"f"),n}switch(t.type){case"response.output_item.added":{n.output.push(t.item);break}case"response.content_part.added":{const r=n.output[t.output_index];if(!r)throw new w(`missing output at index ${t.output_index}`);r.type==="message"&&r.content.push(t.part);break}case"response.output_text.delta":{const r=n.output[t.output_index];if(!r)throw new w(`missing output at index ${t.output_index}`);if(r.type==="message"){const i=r.content[t.content_index];if(!i)throw new w(`missing content at index ${t.content_index}`);if(i.type!=="output_text")throw new w(`expected content to be 'output_text', got ${i.type}`);i.text+=t.delta}break}case"response.function_call_arguments.delta":{const r=n.output[t.output_index];if(!r)throw new w(`missing output at index ${t.output_index}`);r.type==="function_call"&&(r.arguments+=t.delta);break}case"response.completed":{Ae(this,de,t.response,"f");break}}return n},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",r=>{const i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{n=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{n=!0;for(const i of t)i.reject(r);t.length=0}),this.on("error",r=>{n=!0;for(const i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=ue(this,ot,"f");if(!e)throw new w("stream ended without producing a ChatCompletion");return e}}function Za(s,e){return Va(s,e)}class jn extends b{constructor(){super(...arguments),this.inputItems=new Gr(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(n=>("object"in n&&n.object==="response"&&jr(n),n))}retrieve(e,t={},n){return this._client.get(`/responses/${e}`,{query:t,...n,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(n=>zr(n,e))}stream(e,t){return zn.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class eo extends O{}jn.InputItems=Gr;class Wr extends b{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,be({body:t,...n}))}}class Gn extends b{constructor(){super(...arguments),this.parts=new Wr(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}Gn.Parts=Wr;const to=async s=>{const e=await Promise.allSettled(s),t=e.filter(r=>r.status==="rejected");if(t.length){for(const r of t)console.error(r.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const n=[];for(const r of e)r.status==="fulfilled"&&n.push(r.value);return n};class Dt extends b{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return I(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Ot,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const i=await this.retrieve(e,t,{...n,headers:r}).withResponse(),a=i.data;switch(a.status){case"in_progress":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{const l=i.response.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await We(o);break;case"failed":case"completed":return a}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}content(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,Wn,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class Ot extends O{}class Wn extends Ct{}Dt.VectorStoreFilesPage=Ot;Dt.FileContentResponsesPage=Wn;class Hr extends b{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n={},r){return I(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Ot,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:i,response:a}=await this.retrieve(e,t,{...n,headers:r}).withResponse();switch(i.status){case"in_progress":let o=5e3;if(n?.pollIntervalMs)o=n.pollIntervalMs;else{const l=a.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await We(o);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const i=r?.maxConcurrency??5,a=Math.min(i,t.length),o=this._client,l=t.values(),c=[...n];async function m(p){for(let h of p){const f=await o.files.create({file:h,purpose:"assistants"},r);c.push(f.id)}}const u=Array(a).fill(l).map(m);return await to(u),await this.createAndPoll(e,{file_ids:c})}}class me extends b{constructor(){super(...arguments),this.files=new Dt(this._client),this.fileBatches=new Hr(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return I(e)?this.list({},e):this._client.getAPIList("/vector_stores",Hn,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,n){return this._client.getAPIList(`/vector_stores/${e}/search`,qn,{body:t,method:"post",...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class Hn extends O{}class qn extends Ct{}me.VectorStoresPage=Hn;me.VectorStoreSearchResponsesPage=qn;me.Files=Dt;me.VectorStoreFilesPage=Ot;me.FileContentResponsesPage=Wn;me.FileBatches=Hr;var qr;class _ extends xa{constructor({baseURL:e=tt("OPENAI_BASE_URL"),apiKey:t=tt("OPENAI_API_KEY"),organization:n=tt("OPENAI_ORG_ID")??null,project:r=tt("OPENAI_PROJECT_ID")??null,...i}={}){if(t===void 0)throw new w("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const a={apiKey:t,organization:n,project:r,...i,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&Da())throw new w(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new Or(this),this.chat=new St(this),this.embeddings=new Nr(this),this.files=new Pn(this),this.images=new Ur(this),this.audio=new He(this),this.moderations=new Br(this),this.models=new Un(this),this.fineTuning=new he(this),this.graders=new Fn(this),this.vectorStores=new me(this),this.beta=new Le(this),this.batches=new dn(this),this.uploads=new Gn(this),this.responses=new jn(this),this.evals=new Xe(this),this.containers=new Ke(this),this._options=a,this.apiKey=t,this.organization=n,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return ra(e,{arrayFormat:"brackets"})}}qr=_;_.OpenAI=qr;_.DEFAULT_TIMEOUT=6e5;_.OpenAIError=w;_.APIError=B;_.APIConnectionError=Et;_.APIConnectionTimeoutError=un;_.APIUserAbortError=X;_.NotFoundError=Gs;_.ConflictError=Ws;_.RateLimitError=qs;_.BadRequestError=Bs;_.AuthenticationError=zs;_.InternalServerError=Vs;_.PermissionDeniedError=js;_.UnprocessableEntityError=Hs;_.toFile=Zs;_.fileFromPath=$s;_.Completions=Or;_.Chat=St;_.ChatCompletionsPage=Rt;_.Embeddings=Nr;_.Files=Pn;_.FileObjectsPage=Tn;_.Images=Ur;_.Audio=He;_.Moderations=Br;_.Models=Un;_.ModelsPage=Bn;_.FineTuning=he;_.Graders=Fn;_.VectorStores=me;_.VectorStoresPage=Hn;_.VectorStoreSearchResponsesPage=qn;_.Beta=Le;_.Batches=dn;_.BatchesPage=pn;_.Uploads=Gn;_.Responses=jn;_.Evals=Xe;_.EvalListResponsesPage=Sn;_.Containers=Ke;_.ContainerListResponsesPage=vn;class no{threshold;timeout;failureCount=0;lastFailureTime=0;state="CLOSED";constructor(e,t){this.threshold=e,this.timeout=t}async execute(e){if(this.state==="OPEN")if(Date.now()-this.lastFailureTime>this.timeout)this.state="HALF_OPEN";else throw new S(v.SERVICE_UNAVAILABLE,"Circuit breaker is OPEN - service temporarily unavailable");try{const t=await e();return this.onSuccess(),t}catch(t){throw this.onFailure(),t}}onSuccess(){this.failureCount=0,this.state="CLOSED"}onFailure(){this.failureCount++,this.lastFailureTime=Date.now(),this.failureCount>=this.threshold&&(this.state="OPEN")}getState(){return{state:this.state,failureCount:this.failureCount,lastFailureTime:this.lastFailureTime}}}class so{config;circuitBreaker;errorHistory=[];performanceMetrics={totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0,lastHourErrors:0};constructor(e={}){this.config={maxRetries:e.maxRetries||3,baseDelay:e.baseDelay||1e3,maxDelay:e.maxDelay||3e4,backoffMultiplier:e.backoffMultiplier||2,retryableErrors:e.retryableErrors||[v.NETWORK_ERROR,v.TIMEOUT,v.RATE_LIMIT_EXCEEDED,v.UNKNOWN_ERROR],circuitBreakerThreshold:e.circuitBreakerThreshold||5,circuitBreakerTimeout:e.circuitBreakerTimeout||6e4},this.circuitBreaker=new no(this.config.circuitBreakerThreshold,this.config.circuitBreakerTimeout)}async executeWithRecovery(e,t){const n=Date.now();this.performanceMetrics.totalRequests++;try{const r=await this.circuitBreaker.execute(async()=>await this.retryWithBackoff(e,t));this.performanceMetrics.successfulRequests++;const i=Date.now()-n;return this.updateAverageResponseTime(i),r}catch(r){if(this.performanceMetrics.failedRequests++,r instanceof S)throw this.recordError(r),r;const i=new S(v.UNKNOWN_ERROR,`Operation '${t}' failed: ${r instanceof Error?r.message:String(r)}`,r instanceof Error?r:void 0);throw this.recordError(i),i}}async retryWithBackoff(e,t){let n;for(let r=0;r<=this.config.maxRetries;r++)try{const i=await e();return r>0&&console.log(`[PromptLint Recovery] Operation '${t}' succeeded on attempt ${r+1}`),i}catch(i){if(n=i,!this.isRetryableError(i)||r===this.config.maxRetries)throw i;const a=this.calculateBackoffDelay(r);console.warn(`[PromptLint Recovery] Attempt ${r+1} failed for '${t}', retrying in ${a}ms:`,i),await this.sleep(a)}throw n}isRetryableError(e){return this.config.retryableErrors.includes(e.type)}calculateBackoffDelay(e){const t=this.config.baseDelay*Math.pow(this.config.backoffMultiplier,e),n=Math.random()*.3*t,r=t+n;return Math.min(r,this.config.maxDelay)}recordError(e){const t=Date.now();this.errorHistory.push({timestamp:t,error:e}),this.errorHistory=this.errorHistory.filter(n=>t-n.timestamp<36e5),this.performanceMetrics.lastHourErrors=this.errorHistory.length}updateAverageResponseTime(e){const t=this.performanceMetrics.averageResponseTime*(this.performanceMetrics.successfulRequests-1);this.performanceMetrics.averageResponseTime=(t+e)/this.performanceMetrics.successfulRequests}getHealthMetrics(){const e=this.performanceMetrics.totalRequests>0?this.performanceMetrics.failedRequests/this.performanceMetrics.totalRequests:0,t=this.errorHistory.slice(-10).map(r=>({timestamp:r.timestamp,type:r.error.type,message:r.error.message})),n=this.generateRecommendations(e);return{performance:{...this.performanceMetrics},circuitBreaker:this.circuitBreaker.getState(),errorRate:e,recentErrors:t,recommendations:n}}generateRecommendations(e){const t=[];return e>.5&&t.push("High error rate detected - consider checking API key validity"),this.performanceMetrics.averageResponseTime>1e4&&t.push("Slow response times - consider reducing request complexity"),this.errorHistory.filter(i=>i.error.type===v.RATE_LIMIT_EXCEEDED).length>3&&t.push("Frequent rate limiting - consider reducing request frequency"),this.errorHistory.filter(i=>i.error.type===v.NETWORK_ERROR).length>2&&t.push("Network connectivity issues detected - check internet connection"),this.circuitBreaker.getState().state==="OPEN"&&t.push("Circuit breaker is open - service will retry automatically after cooldown"),t}reset(){this.errorHistory=[],this.performanceMetrics={totalRequests:0,successfulRequests:0,failedRequests:0,averageResponseTime:0,lastHourErrors:0}}sleep(e){return new Promise(t=>setTimeout(t,e))}}const xs=new so;class ro{requestsThisMinute=[];requestsThisHour=[];maxPerMinute;maxPerHour;constructor(e=20,t=100){this.maxPerMinute=e,this.maxPerHour=t}canMakeRequest(){const e=Date.now();return this.requestsThisMinute=this.requestsThisMinute.filter(t=>e-t<6e4),this.requestsThisHour=this.requestsThisHour.filter(t=>e-t<36e5),this.requestsThisMinute.length<this.maxPerMinute&&this.requestsThisHour.length<this.maxPerHour}recordRequest(){const e=Date.now();this.requestsThisMinute.push(e),this.requestsThisHour.push(e)}getStatus(){const e=Date.now();return this.requestsThisMinute=this.requestsThisMinute.filter(t=>e-t<6e4),this.requestsThisHour=this.requestsThisHour.filter(t=>e-t<36e5),{remainingMinute:Math.max(0,this.maxPerMinute-this.requestsThisMinute.length),remainingHour:Math.max(0,this.maxPerHour-this.requestsThisHour.length),minuteResetTime:e+6e4,hourResetTime:e+36e5}}updateLimits(e,t){this.maxPerMinute=e,this.maxPerHour=t}}class Vr{client=null;config;rateLimiter;lastSuccessfulRequest;currentError;constructor(e){this.config={...e},this.rateLimiter=new ro(e.rateLimit?.requestsPerMinute||20,e.rateLimit?.requestsPerHour||100),e.apiKey&&this.initializeClient()}initializeClient(){try{this.client=new _({apiKey:this.config.apiKey,timeout:this.config.timeout||3e4}),this.currentError=void 0}catch(e){this.currentError=`Failed to initialize OpenAI client: ${e}`,console.error("[PromptLint LLM]",this.currentError)}}configure(e){this.config={...this.config,...e},e.apiKey&&this.initializeClient(),e.rateLimit&&this.rateLimiter.updateLimits(e.rateLimit.requestsPerMinute,e.rateLimit.requestsPerHour)}async isAvailable(){if(!this.client||!this.config.apiKey)return!1;try{return await this.client.models.list(),this.lastSuccessfulRequest=Date.now(),this.currentError=void 0,!0}catch(e){return this.currentError=`API availability check failed: ${e}`,!1}}getStatus(){return{configured:!!this.config.apiKey,apiKeyValid:!!this.client&&!this.currentError,rateLimit:this.rateLimiter.getStatus(),lastSuccessfulRequest:this.lastSuccessfulRequest,error:this.currentError}}async generateCompletion(e,t,n={}){if(!this.client)throw new S(v.SERVICE_UNAVAILABLE,"OpenAI client not initialized. Please check API key configuration.");if(!this.rateLimiter.canMakeRequest()){const i=this.rateLimiter.getStatus(),a=Math.min(i.minuteResetTime-Date.now(),i.hourResetTime-Date.now());throw new S(v.RATE_LIMIT_EXCEEDED,`Rate limit exceeded. Try again in ${Math.ceil(a/1e3)} seconds.`,void 0,!0)}const r=Date.now();return await xs.executeWithRecovery(async()=>{const i=await this.client.chat.completions.create({model:this.config.model||"gpt-3.5-turbo",messages:[{role:"system",content:e},{role:"user",content:t}],temperature:n.temperature??this.config.temperature??.7,max_tokens:n.maxTokens??this.config.maxTokens??1e3,stream:!1}),a=i.choices[0]?.message?.content;if(!a)throw new S(v.INVALID_REQUEST,"No content in OpenAI response");this.rateLimiter.recordRequest(),this.lastSuccessfulRequest=Date.now(),this.currentError=void 0;const o=Date.now()-r;return{content:a,tokensUsed:i.usage?.total_tokens||0,model:i.model,processingTime:o}},"openai-completion").catch(i=>{if(i instanceof S)throw this.currentError=i.message,i;const a=this.categorizeError(i);throw this.currentError=a.message,a})}categorizeError(e){const t=e.message.toLowerCase();return t.includes("invalid api key")||t.includes("unauthorized")?new S(v.INVALID_API_KEY,"Invalid OpenAI API key. Please check your configuration.",e,!1):t.includes("rate limit")||t.includes("too many requests")?new S(v.RATE_LIMIT_EXCEEDED,"OpenAI rate limit exceeded. Please wait before retrying.",e,!0):t.includes("quota")||t.includes("billing")?new S(v.QUOTA_EXCEEDED,"OpenAI quota exceeded. Please check your billing settings.",e,!1):t.includes("timeout")||t.includes("network")?new S(v.NETWORK_ERROR,"Network error connecting to OpenAI. Please check your connection.",e,!0):t.includes("invalid request")||t.includes("bad request")?new S(v.INVALID_REQUEST,"Invalid request to OpenAI API.",e,!1):new S(v.UNKNOWN_ERROR,`OpenAI API error: ${e.message}`,e,!0)}getHealthMetrics(){return{...xs.getHealthMetrics(),rateLimitStatus:this.rateLimiter.getStatus(),clientStatus:{initialized:!!this.client,lastSuccessfulRequest:this.lastSuccessfulRequest,currentError:this.currentError}}}sleep(e){return new Promise(t=>setTimeout(t,e))}static validateApiKey(e){return/^sk-[A-Za-z0-9]{48}$/.test(e)}estimateCost(e,t){const n=this.config.model||"gpt-3.5-turbo",r={"gpt-3.5-turbo":{input:.0015,output:.002},"gpt-4":{input:.03,output:.06},"gpt-4-turbo-preview":{input:.01,output:.03}},i=r[n]||r["gpt-3.5-turbo"];return e/1e3*i.input+t/1e3*i.output}}const Kr=`You are PromptLint's AI prompt improvement assistant. Your job is to rephrase user prompts to be clearer, more structured, and more effective while following strict rules.

CRITICAL RULES (NEVER VIOLATE):
1. NEVER add technical details not provided by the user
2. NEVER assume programming language, environment, or context  
3. NEVER invent requirements or constraints not mentioned
4. Only rephrase, restructure, and clarify existing content
5. If information is missing, explicitly indicate where user should clarify
6. Use structured Task/Input/Output format when applicable

REPHRASING APPROACH:
- Generate 2-3 different structural variations
- Each variation should use a different organizational approach
- Maintain 100% fidelity to user's original intent
- Improve clarity without adding assumptions
- Use professional, direct language
- Structure information logically

STRUCTURAL APPROACHES TO USE:
1. STRUCTURED: Use clear Task/Input/Output sections
2. CONVERSATIONAL: Natural language flow with clear intent
3. IMPERATIVE: Direct command style with specific actions
4. CLARIFYING: Add explicit clarification requests for missing info

QUALITY STANDARDS:
- Be specific and actionable
- Use clear, unambiguous language
- Organize information logically
- Remove redundancy and filler words
- Maintain user's original scope and intent
- Never expand scope beyond what user provided

WHEN INFORMATION IS MISSING:
- Don't assume or guess
- Explicitly note: "[Clarify: specify programming language]"
- Use placeholders: "[your preferred language]"
- Suggest what user should specify

RESPONSE FORMAT:
Generate exactly 2-3 variations, each using a different approach. For each variation, provide:
- The rephrased prompt
- The approach used (structured/conversational/imperative/clarifying)
- Key improvements made
- Any clarifications needed

Remember: Your goal is to make prompts clearer and more effective, not to add information the user didn't provide.`,io=`Focus on creating a clear Task/Input/Output structure:

STRUCTURE TEMPLATE:
**Task**: [Clear action to perform]
**Input**: [What you'll provide/work with]
**Output**: [Expected result format]
**Context**: [Any relevant background info provided by user]

Use this structure to organize the user's prompt content without adding new requirements.`,ao=`Focus on natural language flow while maintaining clarity:

APPROACH:
- Use natural, conversational language
- Maintain logical flow from context to request
- Be direct but friendly in tone
- Organize information in intuitive order
- Remove unnecessary filler words
- Keep the human-to-AI conversation natural`,oo=`Focus on direct, command-style language:

APPROACH:
- Use clear, direct commands
- Start with action verbs
- Be specific about what to do
- Organize as step-by-step if applicable
- Remove all unnecessary words
- Make instructions immediately actionable`,lo=`Focus on identifying and highlighting missing information:

APPROACH:
- Identify gaps in the original prompt
- Add explicit clarification requests
- Use placeholders for missing info
- Suggest specific details user should provide
- Maintain original intent while noting ambiguities
- Format clarifications clearly: [Clarify: specific detail needed]`,Vt={coding:`When rephrasing coding prompts:
- Don't assume programming language unless specified
- Don't assume frameworks, libraries, or environment
- Focus on the logical problem, not implementation details
- Use placeholders: [your preferred language], [your framework]
- Clarify input/output data structures when relevant`,creative:`When rephrasing creative prompts:
- Preserve the creative intent and style preferences
- Don't add genre or format constraints not mentioned
- Maintain the user's creative vision
- Focus on clarity of creative direction
- Ask for clarification on ambiguous creative elements`,analysis:`When rephrasing analysis prompts:
- Don't assume data sources or formats
- Don't add analysis methods not requested
- Focus on what to analyze and desired insights
- Clarify the scope and depth of analysis needed
- Maintain objectivity in the request`,general:`For general prompts:
- Focus on core intent and desired outcome
- Don't add domain-specific assumptions
- Use clear, accessible language
- Structure logically without technical jargon
- Ask for clarification on vague terms`};function co(s){const e=Kr;switch(s){case"structured":return`${e}

${io}`;case"conversational":return`${e}

${ao}`;case"imperative":return`${e}

${oo}`;case"clarifying":return`${e}

${lo}`;default:return e}}function uo(s){const e=Kr;return s&&Vt[s]?`${e}

${Vt[s]}`:`${e}

${Vt.general}`}class po{templates={structured:{pattern:/^(write|create|build|implement|develop|design)/i,template:e=>`**Task**: ${this.extractAction(e)}

**Input**: [Specify your input requirements]

**Output**: [Describe expected output format]

**Additional Context**: [Add any relevant constraints or preferences]`},conversational:{pattern:/^(help|can you|please|could you)/i,template:e=>`I need help with ${this.extractSubject(e)}. Here's what I'm looking for:

- What I want to accomplish: [Describe your goal]
- What I'm working with: [Specify your context/data]
- How I want the result: [Format preferences]
- Any constraints: [Limitations or requirements]

Could you help me with this?`},imperative:{pattern:/./,template:e=>`${this.capitalizeFirst(this.extractAction(e))} following these steps:

1. [First step - specify what to analyze/process]
2. [Second step - define the transformation/operation]
3. [Third step - format the output as needed]
4. [Final step - validate and present results]

Requirements: [List any specific constraints or preferences]`}};improvements={vague:["Be more specific about input/output","Add concrete examples","Specify the programming language or domain"],incomplete:["Add missing context","Specify expected format","Include constraints or requirements"],unclear:["Use precise terminology","Break down complex requests","Provide step-by-step details"]};generateOfflineRephrase(e){const t=[],n=e.originalPrompt||"create a solution",r=Math.min(e.candidateCount||3,5);t.push(this.createStructuredCandidate(n)),r>1&&t.push(this.createConversationalCandidate(n)),r>2&&t.push(this.createImperativeCandidate(n)),r>3&&t.push(this.createClarifyingCandidate(n)),r>4&&t.push(this.createDetailedCandidate(n));const i=["Generated using offline rules-based engine","For best results, configure OpenAI API key for AI-powered rephrasing","This is a basic structural improvement - AI rephrasing provides more sophisticated results"];return(!e.originalPrompt||e.originalPrompt.trim().length===0)&&i.unshift("Empty prompt detected - providing helpful template structure"),{originalPrompt:e.originalPrompt,candidates:t.slice(0,r),metadata:{processingTime:10,model:"offline-rules-engine",tokensUsed:0,estimatedCost:0,timestamp:Date.now()},warnings:i}}createStructuredCandidate(e){const t=this.templates.structured.template(e);return{id:"offline-structured",text:t,approach:"structured",estimatedScore:this.estimateOfflineScore(t,e),improvements:this.identifyImprovements(e),length:t.length}}createConversationalCandidate(e){const t=this.templates.conversational.template(e);return{id:"offline-conversational",text:t,approach:"conversational",estimatedScore:this.estimateOfflineScore(t,e)-5,improvements:["Added conversational structure","Included placeholder guidance"],length:t.length}}createImperativeCandidate(e){const t=this.templates.imperative.template(e);return{id:"offline-imperative",text:t,approach:"imperative",estimatedScore:this.estimateOfflineScore(t,e)-3,improvements:["Added step-by-step structure","Used direct command style"],length:t.length}}createClarifyingCandidate(e){const t=`${this.capitalizeFirst(this.extractAction(e))} with the following clarifications needed:

[Clarify: What specific type of ${this.extractSubject(e)} do you need?]
[Clarify: What format should the output be in?]
[Clarify: Are there any constraints or requirements?]
[Clarify: What programming language or platform should be used?]

Please provide these details for a more targeted solution.`;return{id:"offline-clarifying",text:t,approach:"clarifying",estimatedScore:this.estimateOfflineScore(t,e)-8,improvements:["Added explicit clarification requests","Identified missing information"],length:t.length}}createDetailedCandidate(e){const t=`**Comprehensive Request**: ${this.capitalizeFirst(this.extractAction(e))}

**Detailed Specification**:
- **Primary Goal**: [Describe the main objective]
- **Input Requirements**: [Specify what data/information will be provided]
- **Output Format**: [Define the expected result format]
- **Technical Constraints**: [List any limitations or requirements]
- **Success Criteria**: [How will you know it's working correctly?]

**Additional Context**:
- **Use Case**: [Explain when/where this will be used]
- **Performance Requirements**: [Any speed/efficiency needs]
- **Error Handling**: [How should edge cases be handled?]

Please fill in the bracketed sections with your specific requirements.`;return{id:"offline-detailed",text:t,approach:"detailed",estimatedScore:this.estimateOfflineScore(t,e)+5,improvements:["Added comprehensive specification template","Included success criteria","Added context sections"],length:t.length}}extractAction(e){const t=["write","create","build","implement","develop","design","generate","make"],n=e.toLowerCase().split(/\s+/);for(const r of n)if(t.includes(r)){const i=n.indexOf(r);return n.slice(i,i+3).join(" ")}return"create a solution"}extractSubject(e){return e.replace(/^(help|can you|please|could you|i need|i want)/i,"").trim()||"the requested task"}capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}estimateOfflineScore(e,t){let n=40;return e.length>t.length*1.5&&(n+=10),(e.includes("**Task**")||e.includes("1."))&&(n+=15),e.includes("[")&&e.includes("]")&&(n+=10),Math.min(n,75)}identifyImprovements(e){const t=[];return e.length<20&&t.push("Added structure to brief prompt"),!e.includes("input")&&!e.includes("output")&&t.push("Added input/output specification"),t.push("Provided template structure"),t.push("Added placeholder guidance"),t}}class ho{cache=new Map;maxEntries=50;maxAge=24*60*60*1e3;set(e,t){const n=this.hashPrompt(e);this.cache.size>=this.maxEntries&&this.cleanOldEntries(),this.cache.set(n,{prompt:e,result:{...t,metadata:{...t.metadata,timestamp:Date.now()}},timestamp:Date.now(),hash:n})}get(e){const t=this.hashPrompt(e),n=this.cache.get(t);return n?Date.now()-n.timestamp>this.maxAge?(this.cache.delete(t),null):{...n.result,warnings:[...n.result.warnings||[],"Result retrieved from cache (offline mode)"]}:null}hashPrompt(e){let t=0;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);t=(t<<5)-t+r,t=t&t}return t.toString()}cleanOldEntries(){const e=Array.from(this.cache.entries());e.sort((n,r)=>n[1].timestamp-r[1].timestamp);const t=Math.floor(e.length*.25);for(let n=0;n<t;n++)this.cache.delete(e[n][0])}clear(){this.cache.clear()}getStats(){const e=Array.from(this.cache.values()),t=e.length>0?Math.min(...e.map(n=>n.timestamp)):void 0;return{size:this.cache.size,maxEntries:this.maxEntries,oldestEntry:t}}}class mo{offlineEngine=new po;cache=new ho;isOnlineMode=!0;async handleRephrase(e,t){if(!this.isOnlineMode){const n=this.cache.get(e.originalPrompt);if(n)return n}try{const n=await t(e);return this.cache.set(e.originalPrompt,n),this.isOnlineMode=!0,n}catch(n){console.warn("[PromptLint Graceful] Primary handler failed, attempting graceful degradation:",n),this.isOnlineMode=!1;const r=this.cache.get(e.originalPrompt);return r?{...r,warnings:[...r.warnings||[],"Service temporarily unavailable - using cached result"]}:this.offlineEngine.generateOfflineRephrase(e)}}getCapabilities(){return{basicRephrase:!0,templateSuggestions:!0,structuredFormat:!0,improvementTips:!0,onlineMode:this.isOnlineMode,cacheStats:this.cache.getStats()}}setOfflineMode(e){this.isOnlineMode=!e}clearCache(){this.cache.clear()}getUserGuidance(){return this.isOnlineMode?{status:"online",message:"AI-powered rephrasing is available",actionable:[]}:{status:"offline",message:"Using offline mode with rule-based improvements",actionable:["Check your internet connection","Verify your OpenAI API key is valid","Try again in a few minutes","Basic structural improvements are still available"]}}}const fo=new mo;class go{openaiClient;config;constructor(e){this.config={...e},this.openaiClient=new Vr(e)}async rephrase(e){return await fo.handleRephrase(e,async t=>{const n=Date.now();try{this.validateRequest(t);const r=this.selectApproaches(t),i=await this.generateCandidates(t,r),a=Date.now()-n,o=this.openaiClient.getStatus();return{originalPrompt:t.originalPrompt,candidates:i,metadata:{processingTime:a,model:this.config.model||"gpt-3.5-turbo",tokensUsed:i.reduce((l,c)=>l+c.tokensUsed||0,0),estimatedCost:this.estimateTotalCost(i),timestamp:Date.now()},warnings:this.generateWarnings(t,i)}}catch(r){throw console.error("[PromptLint Rephrase] Error:",r),r instanceof S?r:new S(v.UNKNOWN_ERROR,`Rephrase failed: ${r instanceof Error?r.message:String(r)}`,r instanceof Error?r:void 0)}})}async isAvailable(){return await this.openaiClient.isAvailable()}getStatus(){return this.openaiClient.getStatus()}configure(e){this.config={...this.config,...e},this.openaiClient.configure(e)}validateRequest(e){if(e.originalPrompt&&e.originalPrompt.length>(e.maxLength||5e3))throw new S(v.INVALID_REQUEST,"Original prompt exceeds maximum length");e.candidateCount&&(e.candidateCount=Math.max(1,Math.min(e.candidateCount,5)))}selectApproaches(e){const t=e.candidateCount||3,n=["structured","conversational","imperative","clarifying"],r=["structured"],i=e.originalPrompt.toLowerCase();(i.includes("create")||i.includes("build")||i.includes("implement"))&&r.push("imperative"),(i.length<50||this.hasVagueTerms(i))&&r.push("clarifying"),r.length<t&&r.push("conversational");for(const a of n){if(r.length>=t)break;r.includes(a)||r.push(a)}return r.slice(0,t)}hasVagueTerms(e){return["something","anything","somehow","maybe","perhaps","kind of","sort of","basically","generally","usually","stuff","things","whatever","etc","and so on"].some(n=>e.includes(n))}async generateCandidates(e,t){const n=[];for(let r=0;r<t.length;r++){const i=t[r];try{const a=await this.generateSingleCandidate(e,i,r);n.push(a)}catch(a){if(console.warn(`[PromptLint Rephrase] Failed to generate candidate with ${i} approach:`,a),i!=="structured")try{const o=await this.generateSingleCandidate(e,"structured",r);n.push(o)}catch(o){console.error("[PromptLint Rephrase] Fallback also failed:",o)}}}if(n.length===0)throw new S(v.SERVICE_UNAVAILABLE,"Failed to generate any rephrase candidates");return n}async generateSingleCandidate(e,t,n){const r=this.buildSystemPrompt(e,t),i=this.buildUserPrompt(e,t),a=await this.openaiClient.generateCompletion(r,i,{temperature:this.getTemperatureForApproach(t),maxTokens:e.maxLength?Math.min(e.maxLength*2,1e3):800}),o=this.parseRephraseResponse(a.content,t),l=this.estimateQualityScore(o,e.originalPrompt),c=this.identifyImprovements(e.originalPrompt,o);return{id:`rephrase-${t}-${n}`,text:o,approach:t,estimatedScore:l,improvements:c,length:o.length,tokensUsed:a.tokensUsed}}buildSystemPrompt(e,t){let n=co(t);return e.context?.domain&&(n=uo(e.context.domain)),n}buildUserPrompt(e,t){let n=`Please rephrase this prompt using the ${t} approach:

"${e.originalPrompt}"`;return e.context&&(n+=`

Context:`,e.context.targetSystem&&(n+=`
- Target system: ${e.context.targetSystem}`),e.context.domain&&(n+=`
- Domain: ${e.context.domain}`),e.context.responseStyle&&(n+=`
- Desired style: ${e.context.responseStyle}`)),n+=`

Provide only the rephrased prompt, no explanation or commentary.`,n}getTemperatureForApproach(e){return{structured:.3,conversational:.7,imperative:.4,clarifying:.5,detailed:.6,concise:.4}[e]||.5}parseRephraseResponse(e,t){let n=e.replace(/```[\s\S]*?```/g,"");n=n.replace(/`([^`]+)`/g,"$1");const r=["Here's the rephrased prompt:","Rephrased prompt:","Here is the rephrased version:","Rephrased:","Here's a rephrased version:","The rephrased prompt is:"];for(const i of r)n.toLowerCase().startsWith(i.toLowerCase())&&(n=n.substring(i.length));return n=n.trim(),n.startsWith('"')&&n.endsWith('"')&&(n=n.slice(1,-1)),n.trim()}estimateQualityScore(e,t){let n=50;const r=e.length/t.length;r>1.2&&r<2?n+=15:r>.8&&r<=1.2&&(n+=10),(e.includes("Task:")||e.includes("Input:")||e.includes("Output:"))&&(n+=15);const a=["specific","clear","detailed","format","structure","requirements"].filter(m=>e.toLowerCase().includes(m)).length;n+=Math.min(a*3,15),["implement","create","build","generate","analyze","design","develop"].some(m=>e.toLowerCase().includes(m))&&(n+=10);const c=["something","somehow","maybe","kind of","sort of"].filter(m=>e.toLowerCase().includes(m)).length;return n-=c*5,Math.max(0,Math.min(100,n))}identifyImprovements(e,t){const n=[];(t.includes("Task:")||t.includes("Input:")||t.includes("Output:"))&&n.push("Added structured format");const r=t.length/e.length;r>1.3?n.push("Expanded with helpful details"):r<.8&&n.push("Condensed for clarity"),["specific","clear","detailed","format","requirements"].some(p=>t.toLowerCase().includes(p)&&!e.toLowerCase().includes(p))&&n.push("Enhanced clarity and specificity");const a=["implement","create","build","generate","analyze","design"],o=a.some(p=>e.toLowerCase().includes(p)),l=a.some(p=>t.toLowerCase().includes(p));!o&&l&&n.push("Added clear action verb");const c=["something","somehow","maybe","kind of","sort of"],m=c.filter(p=>e.toLowerCase().includes(p)).length,u=c.filter(p=>t.toLowerCase().includes(p)).length;return m>u&&n.push("Removed vague language"),n.length===0&&n.push("Improved overall structure and clarity"),n}estimateTotalCost(e){return e.reduce((t,n)=>{const r=n.tokensUsed||0;return t+this.openaiClient.estimateCost(r*.3,r*.7)},0)}generateWarnings(e,t){const n=[];e.originalPrompt.length<20&&n.push("Original prompt was very short - consider providing more context for better results"),t.length>1&&this.calculateSimilarities(t)>.8&&n.push("Generated candidates are very similar - original prompt may already be well-structured");const r=e.originalPrompt.toLowerCase();return(r.includes("code")||r.includes("program"))&&!r.includes("language")&&!r.includes("python")&&!r.includes("javascript")&&n.push("Consider specifying the programming language for more targeted results"),n}calculateSimilarities(e){if(e.length<2)return 0;let t=0,n=0;for(let r=0;r<e.length;r++)for(let i=r+1;i<e.length;i++)t+=this.calculateTextSimilarity(e[r].text,e[i].text),n++;return n>0?t/n:0}calculateTextSimilarity(e,t){const n=new Set(e.toLowerCase().split(/\s+/)),r=new Set(t.toLowerCase().split(/\s+/)),i=new Set([...n].filter(o=>r.has(o))),a=new Set([...n,...r]);return i.size/a.size}}class _t{static ALGORITHM="AES-GCM";static KEY_LENGTH=256;static async deriveKey(e){const t=new TextEncoder,n=await crypto.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t.encode("promptlint-salt"),iterations:1e5,hash:"SHA-256"},n,{name:this.ALGORITHM,length:this.KEY_LENGTH},!1,["encrypt","decrypt"])}static async encrypt(e,t){const n=await this.deriveKey(t),r=new TextEncoder,i=crypto.getRandomValues(new Uint8Array(12)),a=await crypto.subtle.encrypt({name:this.ALGORITHM,iv:i},n,r.encode(e)),o=new Uint8Array(i.length+a.byteLength);return o.set(i),o.set(new Uint8Array(a),i.length),btoa(String.fromCharCode(...o))}static async decrypt(e,t){const n=await this.deriveKey(t),r=new Uint8Array(atob(e).split("").map(l=>l.charCodeAt(0))),i=r.slice(0,12),a=r.slice(12),o=await crypto.subtle.decrypt({name:this.ALGORITHM,iv:i},n,a);return new TextDecoder().decode(o)}}class J{static STORAGE_KEY="promptlint_api_key";static DEVICE_ID_KEY="promptlint_device_id";async getDeviceKey(){if(typeof chrome>"u"||!chrome.storage)throw new Error("Chrome extension storage not available");const e=await chrome.storage.local.get(J.DEVICE_ID_KEY);if(e[J.DEVICE_ID_KEY])return e[J.DEVICE_ID_KEY];const t=crypto.randomUUID();return await chrome.storage.local.set({[J.DEVICE_ID_KEY]:t}),t}async store(e){if(!e||e.trim().length===0)throw new Error("API key cannot be empty");if(!chrome?.storage?.local)throw new Error("Chrome extension storage not available");const t=await this.getDeviceKey(),n=await _t.encrypt(e,t);await chrome.storage.local.set({[J.STORAGE_KEY]:n})}async retrieve(){if(!chrome?.storage?.local)return null;const t=(await chrome.storage.local.get(J.STORAGE_KEY))[J.STORAGE_KEY];if(!t)return null;try{const n=await this.getDeviceKey();return await _t.decrypt(t,n)}catch(n){return console.error("[PromptLint] Failed to decrypt API key:",n),await this.remove(),null}}async remove(){chrome?.storage?.local&&await chrome.storage.local.remove(J.STORAGE_KEY)}async hasKey(){return chrome?.storage?.local?!!(await chrome.storage.local.get(J.STORAGE_KEY))[J.STORAGE_KEY]:!1}}class ye{static STORAGE_FILE=".promptlint-api-key";static DEVICE_ID_FILE=".promptlint-device-id";getStorageDir(){const e=require("os");return require("path").join(e.homedir(),".promptlint")}async ensureStorageDir(){const e=require("fs").promises,t=this.getStorageDir();try{await e.access(t)}catch{await e.mkdir(t,{recursive:!0})}}async getDeviceKey(){const e=require("fs").promises,t=require("path");await this.ensureStorageDir();const n=t.join(this.getStorageDir(),ye.DEVICE_ID_FILE);try{return(await e.readFile(n,"utf8")).trim()}catch{const i=require("crypto").randomUUID();return await e.writeFile(n,i,{mode:384}),i}}async store(e){if(!e||e.trim().length===0)throw new Error("API key cannot be empty");const t=require("fs").promises,n=require("path");await this.ensureStorageDir();const r=await this.getDeviceKey(),i=await _t.encrypt(e,r),a=n.join(this.getStorageDir(),ye.STORAGE_FILE);await t.writeFile(a,i,{mode:384})}async retrieve(){const e=require("fs").promises,n=require("path").join(this.getStorageDir(),ye.STORAGE_FILE);try{const r=await e.readFile(n,"utf8"),i=await this.getDeviceKey();return await _t.decrypt(r,i)}catch(r){return r.code==="ENOENT"||(console.error("[PromptLint] Failed to decrypt API key:",r),await this.remove()),null}}async remove(){const e=require("fs").promises,n=require("path").join(this.getStorageDir(),ye.STORAGE_FILE);try{await e.unlink(n)}catch(r){if(r.code!=="ENOENT")throw r}}async hasKey(){const e=require("fs").promises,n=require("path").join(this.getStorageDir(),ye.STORAGE_FILE);try{return await e.access(n),!0}catch{return!1}}}class yo{apiKey=null;async store(e){this.apiKey=e}async retrieve(){return this.apiKey}async remove(){this.apiKey=null}async hasKey(){return this.apiKey!==null}}function Jr(){return typeof chrome<"u"&&chrome.storage?new J:typeof process<"u"&&process.versions&&process.versions.node?new ye:(console.warn("[PromptLint] Using memory-based API key storage - keys will not persist"),new yo)}class wo{static validateOpenAIKey(e){if(!e||e.trim().length===0)return{valid:!1,error:"API key cannot be empty"};const t=e.trim();return t.startsWith("sk-")?t.length!==51?{valid:!1,error:"OpenAI API key must be 51 characters long"}:/^sk-[A-Za-z0-9]{48}$/.test(t)?{valid:!0}:{valid:!1,error:"OpenAI API key contains invalid characters"}:{valid:!1,error:'OpenAI API key must start with "sk-"'}}static maskApiKey(e){if(!e||e.length<11)return"***";const t=e.substring(0,7),n=e.substring(e.length-4),r="*".repeat(Math.max(0,e.length-11));return`${t}${r}${n}`}}function bo(s={}){const t={...{apiKey:"",model:"gpt-3.5-turbo",timeout:3e4,maxRetries:3,temperature:.7,maxTokens:1e3,rateLimit:{requestsPerMinute:20,requestsPerHour:100}},...s};return new go(t)}async function _o(s={}){const t=await Jr().retrieve();if(!t)return console.warn("[PromptLint LLM] No stored API key found"),null;const n={...s,apiKey:t};return bo(n)}async function Eo(s){const e=wo.validateOpenAIKey(s);if(!e.valid)return{valid:!1,error:e.error};try{const t=new Vr({apiKey:s});return await t.isAvailable()?{valid:!0}:{valid:!1,error:t.getStatus().error||"API key test failed"}}catch(t){return{valid:!1,error:t instanceof Error?t.message:"Unknown error testing API key"}}}class xo{rephraseService=null;apiKeyStorage=Jr();isInitialized=!1;async initialize(){try{if(!await this.apiKeyStorage.hasKey())return{available:!1,hasApiKey:!1,error:"No API key configured"};if(this.rephraseService=await _o(),!this.rephraseService)return{available:!1,hasApiKey:!0,error:"Failed to initialize rephrase service"};const t=await this.rephraseService.isAvailable();return this.isInitialized=t,{available:t,hasApiKey:!0,error:t?void 0:"Service not available"}}catch(e){return console.error("[PromptLint Rephrase] Initialization failed:",e),{available:!1,hasApiKey:!1,error:e instanceof Error?e.message:"Initialization failed"}}}async setupApiKey(e){try{const t=await Eo(e);if(!t.valid)return{success:!1,error:t.error||"Invalid API key"};await this.apiKeyStorage.store(e);const n=await this.initialize();return{success:n.available,error:n.error}}catch(t){return console.error("[PromptLint Rephrase] API key setup failed:",t),{success:!1,error:t instanceof Error?t.message:"Setup failed"}}}async removeApiKey(){await this.apiKeyStorage.remove(),this.rephraseService=null,this.isInitialized=!1}isReady(){return this.isInitialized&&!!this.rephraseService}async rephrase(e){if(!this.isReady())throw new S(v.SERVICE_UNAVAILABLE,"Rephrase service not initialized. Please configure your OpenAI API key.");if(!e||e.trim().length===0)throw new S(v.INVALID_REQUEST,"Cannot rephrase empty prompt");try{const t={originalPrompt:e.trim(),candidateCount:3,context:{targetSystem:this.detectTargetSystem(),domain:this.detectDomain(e),responseStyle:"technical"}},n=await this.rephraseService.rephrase(t);return console.log("[PromptLint Rephrase] Success:",{originalLength:e.length,candidatesGenerated:n.candidates.length,processingTime:n.metadata.processingTime}),n}catch(t){throw console.error("[PromptLint Rephrase] Request failed:",t),t instanceof S?t:new S(v.UNKNOWN_ERROR,t instanceof Error?t.message:"Rephrase request failed")}}async getStatus(){if(!this.isInitialized)return await this.initialize();try{const e=this.rephraseService?await this.rephraseService.isAvailable():!1,t=await this.apiKeyStorage.hasKey();return{available:e,hasApiKey:t,error:e?void 0:"Service not available"}}catch(e){return{available:!1,hasApiKey:await this.apiKeyStorage.hasKey(),error:e instanceof Error?e.message:"Status check failed"}}}detectTargetSystem(){const e=window.location.hostname;return e.includes("openai.com")?"ChatGPT":e.includes("claude.ai")?"Claude":"Unknown"}detectDomain(e){const t=e.toLowerCase();return t.includes("code")||t.includes("program")||t.includes("function")?"coding":t.includes("analyze")||t.includes("data")||t.includes("report")?"analysis":t.includes("write")||t.includes("create")||t.includes("story")?"creative":"general"}createGracefulFallback(){return{onRephraseRequest:async e=>{try{return(await this.getStatus()).available&&this.rephraseService?await this.rephrase(e):this.createOfflineRephraseResult(e)}catch(t){return console.warn("[PromptLint] Rephrase failed, using offline mode:",t),this.createOfflineRephraseResult(e)}},onRephraseSelect:(e,t)=>{this.replacePromptInInput(e.text),console.log("[PromptLint Rephrase] Candidate selected:",{approach:e.approach,originalLength:t.length,newLength:e.text.length,estimatedScore:e.estimatedScore})}}}replacePromptInInput(e){const t=document.activeElement;t&&(t.tagName==="TEXTAREA"||t.tagName==="INPUT")?(t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0}))):navigator.clipboard.writeText(e).then(()=>{console.log("[PromptLint Rephrase] Copied to clipboard:",e.substring(0,50)+"...")}).catch(()=>{console.warn("[PromptLint Rephrase] Failed to copy to clipboard")})}createOfflineRephraseResult(e){const t=[];return t.push({id:"offline-structured",text:`**Task**: ${this.capitalizeFirst(this.extractAction(e))}

**Input**: [Specify your input data/requirements here]

**Output**: [Describe the expected output format]

**Additional Context**: [Add any constraints, preferences, or specific requirements]`,approach:"structured",estimatedScore:75,improvements:["Added structured format","Included clear sections","Made requirements explicit"],length:200}),t.push({id:"offline-conversational",text:`I need help with ${this.extractAction(e)}. Here's what I'm looking for:

- What I want to accomplish: [Describe your goal]
- What I'm working with: [Specify your context/data]
- How I want the result: [Format preferences]
- Any constraints: [Limitations or requirements]

Could you help me with this?`,approach:"conversational",estimatedScore:70,improvements:["Added conversational structure","Included guidance prompts","Made it more engaging"],length:180}),t.push({id:"offline-imperative",text:`${this.capitalizeFirst(this.extractAction(e))} following these steps:

1. [First step - specify what to analyze/process]
2. [Second step - define the transformation/operation]
3. [Third step - format the output as needed]
4. [Final step - validate and present results]

Requirements: [List any specific constraints or preferences]`,approach:"imperative",estimatedScore:72,improvements:["Added step-by-step structure","Made process explicit","Included requirements section"],length:190}),{originalPrompt:e,candidates:t,metadata:{processingTime:5,model:"offline-rules-engine",tokensUsed:0,estimatedCost:0,timestamp:Date.now()},warnings:["Generated using offline template engine","For AI-powered improvements, configure OpenAI API key in extension popup","Templates provide structural improvements - AI rephrasing offers more sophisticated results"]}}extractAction(e){const t=["write","create","build","implement","develop","design","generate","make","analyze","process"],n=e.toLowerCase().split(/\s+/);for(const r of t)if(n.includes(r))return r;return e.length<20?"create a solution for":"help with"}capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}}const As=new xo;class Ao{uiInjector=null;inputMonitor=null;isInitialized=!1;async initialize(){if(this.isInitialized){console.log("[PromptLint] Already initialized");return}try{console.log("[PromptLint] Initializing content script...");const e=await K.attemptRecovery(async()=>{const o=await Jt.detectSite();if(!o||o.confidence<.7)throw new Error("Site not supported or confidence too low");return o},Z.SITE_DETECTION_FAILED,{url:window.location.href});if(!e){console.log("[PromptLint] Site detection failed after retries");return}if(console.log("[PromptLint] Site detection result:",e),!await K.attemptRecovery(async()=>(await gi(),!0),Z.ADAPTER_INITIALIZATION_FAILED,{phase:"site_adapters_init"})){console.error("[PromptLint] Failed to initialize site adapters");return}console.log("[PromptLint] Site adapters initialized"),console.log("[PromptLint] Registered adapters:",ft.getRegisteredSiteTypes()),console.log("[PromptLint] Looking for adapter for site type:",e.type);const n=await K.attemptRecovery(async()=>{if(!e.type)throw new Error("Site type is null");const o=ft.getAdapterByType(e.type);if(console.log("[PromptLint] Found adapter:",!!o),!o)throw new Error(`No adapter found for site type: ${e.type}`);return o},Z.ADAPTER_NOT_FOUND,{siteType:e.type});if(!n){console.error("[PromptLint] Failed to get adapter after retries");return}await K.attemptRecovery(async()=>(await n.initialize(),!0),Z.ADAPTER_INITIALIZATION_FAILED,{siteType:e.type}),console.log("[PromptLint] Site adapter initialized"),console.log("[PromptLint] Initializing rephrase service...");const r=await As.initialize();if(console.log("[PromptLint] Rephrase service status:",r),!await K.attemptRecovery(async()=>{const o=As.createGracefulFallback();return this.uiInjector=new yi(n,{panelOptions:{enableRephrase:!0}},o),await this.uiInjector.initialize(),!0},Z.DOM_INJECTION_FAILED,{siteType:e.type})){console.error("[PromptLint] Failed to initialize UI components");return}const a=await K.attemptRecovery(async()=>(this.inputMonitor=new Ki(n,this.uiInjector),await this.inputMonitor.initialize(),!0),Z.INPUT_ELEMENT_NOT_FOUND,{siteType:e.type});a||console.error("[PromptLint] Failed to initialize input monitor"),this.isInitialized=!0,console.log("[PromptLint] Content script initialized successfully");try{chrome.runtime.sendMessage({type:"CONTENT_SCRIPT_READY",site:e.type,confidence:e.confidence,hasInputMonitor:!!a})}catch(o){console.warn("[PromptLint] Could not send ready message to background:",o)}}catch(e){const t=K.handleError(e,Z.UNKNOWN_ERROR,{phase:"initialization",url:window.location.href});if(console.error("[PromptLint] Failed to initialize content script:",t),this.uiInjector){const n=K.createErrorLintResult(t);await this.uiInjector.updateResults(n)}}}async cleanup(){try{this.inputMonitor&&(await this.inputMonitor.cleanup(),this.inputMonitor=null),this.uiInjector&&(await this.uiInjector.cleanup(),this.uiInjector=null);try{const e=await Is();e&&e.cleanup()}catch(e){console.warn("[PromptLint] Error during adapter cleanup:",e)}this.isInitialized=!1,console.log("[PromptLint] Content script cleaned up")}catch(e){console.error("[PromptLint] Error during cleanup:",e),this.isInitialized=!1}}}const ie=new Ao;document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{ie.initialize()}):ie.initialize();let Kt=window.location.href;const kt=()=>{try{const s=window.location.href;s!==Kt&&(console.log("[PromptLint] URL changed from",Kt,"to",s),Kt=s,s.startsWith("https://chat.openai.com/")||s.startsWith("https://chatgpt.com/")||s.startsWith("https://claude.ai/")||s.startsWith("https://anthropic.com/")?(console.log("[PromptLint] New URL is supported, reinitializing..."),ie.cleanup().then(()=>{setTimeout(()=>ie.initialize(),1e3)}).catch(t=>{console.warn("[PromptLint] Error during cleanup before reinitialization:",t),setTimeout(()=>ie.initialize(),1e3)})):(console.log("[PromptLint] New URL is not supported, cleaning up..."),ie.cleanup().catch(t=>{console.warn("[PromptLint] Error during cleanup for unsupported URL:",t)})))}catch(s){console.error("[PromptLint] Error in URL change handler:",s)}},Xr=new MutationObserver(()=>{kt()});Xr.observe(document.body,{childList:!0,subtree:!0});const Yr=history.pushState,Qr=history.replaceState;history.pushState=function(...s){Yr.apply(history,s),setTimeout(kt,100)};history.replaceState=function(...s){Qr.apply(history,s),setTimeout(kt,100)};window.addEventListener("popstate",()=>{setTimeout(kt,100)});window.addEventListener("beforeunload",()=>{ie.cleanup(),Xr.disconnect(),history.pushState=Yr,history.replaceState=Qr});chrome.runtime.onMessage.addListener((s,e,t)=>{switch(s.type){case"GET_STATUS":t({initialized:ie.isInitialized,site:null});break;case"REINITIALIZE":ie.cleanup().then(()=>ie.initialize()),t({success:!0});break}});
